<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ë¯¸ìŠ¤í„° ì‹ ì˜ íˆ¬ì–´ë§ˆìŠ¤í„° 10.0 (Contact Logic Fixed)</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
  /* --- [ìŠ¤íƒ€ì¼ì€ ì›ë³¸ 100% ìœ ì§€] --- */
  body, input, button, textarea, select { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; -webkit-user-select:none; }
  body { background: #f0f2f5; margin: 0; padding: 5px; max-width: 100vw; overflow-x: hidden; }
  
  .guide-panel { background: #fff3e0; padding: 10px; border-radius: 12px; margin-bottom: 10px; text-align: center; border: 2px solid #ffe0b2; display: flex; justify-content: space-around; gap: 5px; }
  .guide-input-group { display: flex; flex-direction: column; align-items: center; }
  .guide-input { font-size: 16px; font-weight: 900; color: #e65100; border: none; border-bottom: 2px solid #e65100; background: transparent; text-align: center; width: 120px; outline: none; }
  
  .input-box { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; box-sizing: border-box; width: 100%; }
  
  .manual-control-panel { display: flex; gap: 5px; background: #e8eaf6; padding: 10px; border-radius: 8px; margin-bottom: 10px; align-items: center; border: 1px solid #c5cae9; width: 100%; box-sizing: border-box; }
  .manual-input { flex: 1; padding: 12px; font-size: 16px; font-weight: bold; text-align: center; border: 2px solid #3f51b5; border-radius: 6px; color: #333; outline: none; min-width: 0; }
  .btn-manual { width: 50px; height: 45px; font-size: 20px; font-weight: 900; border: none; border-radius: 6px; cursor: pointer; color: white; flex-shrink: 0; }
  .btn-add { background: #3f51b5; }
  .btn-del { background: #f44336; }

  textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 11px; box-sizing: border-box; }
  
  .time-setting-panel { background: #e3f2fd; padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; gap: 5px; justify-content: space-between; align-items: center; }
  .time-input-group { display: flex; flex-direction: column; flex: 1; }
  .time-input-group label { font-size: 10px; font-weight: bold; color: #1565c0; margin-bottom: 2px; text-align: center; }
  .time-input-group input { text-align: center; border: 1px solid #90caf9; border-radius: 4px; padding: 4px; font-weight: bold; color: #333; width: 100%; box-sizing: border-box; }
  
  .control-panel { margin-top: 8px; border-top: 1px dashed #ddd; padding-top: 8px; }
  .chk-label { background: #f1f3f5; border: 1px solid #d1d1d1; border-radius: 4px; padding: 6px 9px; font-size: 11px; font-weight: 800; cursor: pointer; color: #333; display: flex; align-items: center; }
  .chk-label input { margin-right: 4px; }
  .chk-label:has(input:checked) { background: #007bff; border-color: #0056b3; color: white; }
  
  .priority-display { font-size: 12px; color: #0056b3; font-weight: bold; margin: 5px 0; padding: 5px; background: #fff; border-radius: 4px; min-height: 15px; border: 1px solid #eee; }
  .size-selector { display: flex; gap: 10px; margin-bottom: 5px; font-size: 12px; font-weight: bold; justify-content: center; background: #eee; padding: 5px; border-radius: 8px;}
  .control-group { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 5px; }
  
  .btn-group { display: flex; gap: 5px; margin-top: 5px; }
  button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; }
  .btn-run { background: #4e54c8; color: white; }
  .btn-save { background: #11998e; color: white; }
  .btn-clear { background: #ff5252; color: white; flex: 0.4; } 
  
  .vcard-panel { background: #e0f2f1; padding: 8px; border-radius: 8px; margin-top: 8px; border: 1px solid #b2dfdb; display: flex; gap: 5px; align-items: center; }
  .vcard-input { width: 80px; padding: 8px; text-align: center; border: 1px solid #00897b; border-radius: 6px; font-weight: bold; color: #00695c; }
  .btn-vcard { background: #009688; color: white; flex: 1; font-size: 13px; padding: 10px; }
  
  .capture-wrapper { margin-bottom: 30px; border: 5px solid #eee; }
  #captureArea1, #captureArea2 { background: white; padding: 15px 5px; border-radius: 0; width: 100%; max-width: 500px; margin: 0 auto; box-sizing: border-box; }
  
  .bus-header { text-align: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #333; }
  .pickup-summary { background: #2c3e50; color: white; padding: 10px; border-radius: 6px; font-size: 1.2rem; font-weight: 900; margin-bottom: 5px; letter-spacing: -0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  .bus-date { font-size: 1.0rem; color: #555; margin-top: 6px; font-weight: 800; }
  .bus-title-label { background: #333; color: #fff; display:inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 5px; font-weight: bold; }
  
  .bus-grid { display: grid; grid-template-columns: 1fr 1fr 0.2fr 1fr 1fr; grid-auto-rows: 1fr; gap: 4px; width: 100%; }
  .last-row-45 { grid-column: 1 / -1; display: flex; justify-content: space-between; gap: 4px; height: 100%; }
  .last-row-45 .seat { flex: 1; width: auto; }
  
  .seat { aspect-ratio: 1.1 / 1; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; position: relative; cursor: pointer; box-shadow: 1px 2px 3px rgba(0,0,0,0.1); padding: 3px; height: 100%; box-sizing: border-box; background: white; justify-content: center; align-items: center; }
  .seat.empty { background: white; opacity: 1; border: 2px dashed #ddd; } 
  .seat.reserved { background: #bbb; color: white; opacity: 0.5; pointer-events: none; border:none; } 
  .seat.emergency { border: 2px dashed #ff9800; background-color: #fff8e1; } 
  .seat.selected { border: 3px solid #ff0000; transform: scale(1.05); z-index: 20; box-shadow: 0 0 10px rgba(255,0,0,0.5); }
  .seat.synced-general { background-color: #e0e0e0 !important; border: 1px solid #bdbdbd; opacity: 0.8; }
  
  .seat-num { position: absolute; top: 2px; left: 4px; font-size: 11px; font-weight: bold; color: rgba(0,0,0,0.4); z-index: 2; }
  .grp-id { font-size: 24px; font-weight: 900; color: #333; line-height: 1; margin-bottom: 4px; margin-top: 8px; text-align: center; }
  .grp-id.long-text { font-size: 20px; letter-spacing: -1px; }
  .info-badge { background: rgba(255,255,255,0.85); border-radius: 12px; padding: 3px 6px; text-align: center; font-size: 11px; font-weight: 900; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: 95%; margin-top: auto; margin-bottom: 2px; white-space: nowrap; }
  .male-text { color: #1565c0; } .female-text { color: #e91e63; } .neutral-text { color: #757575; } 
  .day-tag { color: white; padding: 1px 4px; border-radius: 4px; margin-right: 3px; font-size: 10px; vertical-align: middle; }
  .tag-d1 { background-color: #1976d2; } .tag-d2 { background-color: #d32f2f; } .tag-d3 { background-color: #7b1fa2; } .tag-stay { background-color: #ff9800; }
  .tag-hot { background-color: #ff3d00; border: 1px solid white; font-weight:900; }

  .status { font-size: 11px; color: #666; text-align: right; margin-top: 5px; }

  .msg-section { margin-top: 20px; border-top: 2px solid #333; padding-top: 10px; }
  .msg-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .msg-check-area { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 8px; width: 45px; gap: 8px; }
  .check-box-wrapper { display: flex; flex-direction: column; align-items: center; }
  .msg-check-label { font-size: 10px; font-weight: 800; color: #555; margin-bottom: 2px; text-align: center; white-space: nowrap; }
  .label-sent { color: #1976d2; } .label-connected { color: #d32f2f; }
  .msg-check-input { transform: scale(1.5); margin: 0; cursor: pointer; }
  .chk-sent { accent-color: #2196f3; } .chk-conn { accent-color: #f44336; } 
  .msg-info { flex: 1; margin-right: 5px; min-width: 0; }
  .msg-group-row { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; }
  .msg-group { font-size: 18px; font-weight: 900; color: #333; }
  .msg-seats { font-size: 14px; font-weight: bold; color: #d32f2f; margin-top: 4px; }
  .msg-memo-input { width: 100%; margin-top: 5px; border: none; border-bottom: 1px solid #ccc; font-size: 12px; padding: 5px 2px; background: #fafafa; }
  .lang-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
  .lang-CN { background: #fce4ec; color: #c2185b; }
  .lang-EN { background: #e3f2fd; color: #1565c0; }
  .msg-actions { display: flex; gap: 5px; align-items: center; }
  .btn-action { width: 45px; height: 45px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; text-align: center; line-height: 1.2; transition: transform 0.1s; }
  .btn-action:active { transform: scale(0.95); }
  .btn-wa-send { background: #25D366; color: white; }
  .btn-wa-send.disabled { background: #ccc; pointer-events: none; }
  .btn-copy-body { background: #607d8b; color: white; }
  .btn-copy-mail { background: #4fc3f7; color: white; }
  
  .logo-wa { background: #25D366; color: white; } .logo-line { background: white; border: 2px solid #06C755; color: #06C755; box-sizing: border-box; } .logo-kakao { background: #FEE500; color: #3c1e1e; }
  .logo-viber { background: #7360f2; color: white; } .logo-wechat { background: #000000; color: #07C160; border: 1px solid #07C160; } .logo-zalo { background: #0068FF; color: white; } .logo-none { background: #e0e0e0; color: #999; cursor: default; }
  .hidden-msg { display: none; white-space: pre-wrap; }
</style>
</head>
<body>
<div class="guide-panel">
    <div class="guide-input-group">
        <label style="font-weight:bold; font-size:12px; color:#ef6c00;">ê°€ì´ë“œ (Guide)</label>
        <input type="text" id="guideNameInput" class="guide-input" value="Mr. Shin" oninput="saveGuideName()">
    </div>
    <div class="guide-input-group">
        <label style="font-weight:bold; font-size:12px; color:#0277bd;">ë²„ìŠ¤ ë²ˆí˜¸ (Bus)</label>
        <input type="text" id="busNumberInput" class="guide-input" value="4044" oninput="saveGuideName()">
    </div>
</div>

<div class="input-box" style="background: #fff9c4; border: 2px solid #fbc02d;">
  <label style="font-weight:bold; font-size:13px; color:#f57f17;">ğŸ“¢ ë‹¹ì¼ íˆ¬ì–´ íŠ¹ìˆ˜ ê³µì§€ (Special Notice)</label>
  <textarea id="specialNotice" style="height: 50px; margin-top:5px; border-color:#fbc02d;" placeholder="ì—¬ê¸°ì— ì…ë ¥í•œ ë‚´ìš©ì´ ë‹¹ì¼ ë©”ì‹œì§€ ì¤‘ê°„ì— ë“¤ì–´ê°‘ë‹ˆë‹¤." oninput="saveSpecialNotice()"></textarea>
</div>

<div class="input-box">
  <h2>ë¯¸ìŠ¤í„° ì‹ ì˜ íˆ¬ì–´ë§ˆìŠ¤í„° 10.0 (Contact Fixed)</h2>
  
  <div class="manual-control-panel">
      <input type="number" id="manualGroupNum" class="manual-input" placeholder="No." inputmode="numeric">
      <button class="btn-manual btn-add" onclick="manualAddGroup()">+</button>
      <button class="btn-manual btn-del" onclick="manualDelGroup()">-</button>
  </div>

  <div class="time-setting-panel">
    <div class="time-input-group"><label>í™ëŒ€(8ë²ˆ)</label><input type="text" id="timeHongdae" value="06:40" onchange="saveTimeInput()"></div>
    <div class="time-input-group"><label>ëª…ë™(3ë²ˆ)</label><input type="text" id="timeMyeongdong" value="07:10" onchange="saveTimeInput()"></div>
    <div class="time-input-group"><label>ë™ëŒ€ë¬¸(11ë²ˆ)</label><input type="text" id="timeDongdaemun" value="07:20" onchange="saveTimeInput()"></div>
  </div>
  <textarea id="rawData" placeholder="ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”... (ìŠ¤í‚¤/ì‚°ì²œì–´/ì¼ë°˜ ìë™ ê°ì§€)" oninput="saveTextInput()"></textarea>
  <div class="size-selector">
    <label><input type="radio" name="busSize" value="44" checked onchange="saveTextInput()"> 44ì¸ìŠ¹</label>
    <label><input type="radio" name="busSize" value="45" onchange="saveTextInput()"> 45ì¸ìŠ¹</label>
  </div>
  <div class="control-panel">
    <div class="priority-display" id="priorityView">ìš°ì„ ìˆœìœ„: ì—†ìŒ</div>
    <div class="control-group">
      <label class="chk-label"><input type="checkbox" class="criteria" value="solo" onchange="updatePriority(this)"> í˜¼ì(1ì¸)</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="CN" onchange="updatePriority(this)"> ì¤‘êµ­ì–´ê¶Œ</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="EN" onchange="updatePriority(this)"> ì˜ì–´ê¶Œ</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="F" onchange="updatePriority(this)"> ì—¬ì</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="M" onchange="updatePriority(this)"> ë‚¨ì</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="G4" onchange="updatePriority(this)"> 4ì¸ ì´ìƒ</label>
    </div>
    <div class="size-selector" style="background:#eef;">
      <label><input type="radio" name="direction" value="front" checked> ì¡°ê±´ ì•ìª½</label>
      <label><input type="radio" name="direction" value="back"> ì¡°ê±´ ë’¤ìª½</label>
    </div>
  </div>
  <div class="vcard-panel">
      <input type="text" id="vcardDate" class="vcard-input" placeholder="YYMMDD" onchange="checkDateChange()">
      <button class="btn-vcard" onclick="downloadVCard()">ğŸ“ ì—°ë½ì²˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (.vcf)</button>
  </div>
  <div class="btn-group">
    <button class="btn-clear" onclick="clearData()">ğŸ—‘ ì´ˆê¸°í™”</button>
    <button class="btn-run" onclick="runAI()">ğŸ¤– ìë™ ë°°ì¹˜ ì‹¤í–‰</button>
    <button class="btn-save" onclick="downloadImage(1)">ğŸ“¸ ë§µ1(ê°€ëŠ”í¸)</button>
    <button class="btn-save" style="background:#e91e63;" onclick="downloadImage(2)">ğŸ“¸ ë§µ2(ì˜¤ëŠ”í¸)</button>
  </div>
  <div class="status" id="paxInfo">ì¤€ë¹„ë¨</div>
</div>

<div class="capture-wrapper">
  <div id="captureArea1">
    <div class="bus-header">
      <div class="bus-title-label">â˜€ï¸ Map 1 (Seoul â†’ Dest)</div>
      <div class="pickup-summary" id="pickupSummary1">ì¤€ë¹„ì¤‘...</div>
      <div class="bus-date" id="dateDisplay1">2026-00-00</div>
    </div>
    <div class="bus-grid" id="busGrid1"></div>
  </div>
</div>

<div class="capture-wrapper">
  <div id="captureArea2">
    <div class="bus-header">
      <div class="bus-title-label">ğŸŒ™ Map 2 (Dest â†’ Seoul)</div>
      <div class="pickup-summary" id="pickupSummary2">ì¤€ë¹„ì¤‘...</div>
      <div class="bus-date" id="dateDisplay2">2026-00-00</div>
    </div>
    <div class="bus-grid" id="busGrid2"></div>
  </div>
</div>

<div class="msg-section" id="msgSection" style="display:none;">
    <h3 style="text-align:center; margin:0 0 10px 0;">ğŸ’¬ ë©”ì‹œì§€ ë°œì†¡ & ì²´í¬</h3>
    <div id="msgList"></div>
</div>
<textarea id="clipboardHelper" style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none;"></textarea>

<script>
/**
 * [ì „ì—­ ìƒìˆ˜ ë° ì„¤ì •]
 */
const CONFIG = {
    BOOTS_YOUTUBE: "https://youtu.be/J9S0q1QKoOY?si=V57nHSmY0NGhhHcY",
    COLORS: {
        hongdae: '#C8E6C9',    // í™ëŒ€ (ì´ˆë¡)
        myeongdong: '#BBDEFB', // ëª…ë™ (íŒŒë‘)
        dongdaemun: '#E1BEE7', // ë™ëŒ€ë¬¸ (ë³´ë¼)
        resort: '#FFF9C4',     // ìŠ¤í‚¤ì¥/D2/D3 (ë…¸ë‘)
        etc: '#E0E0E0'         // ê¸°íƒ€/í˜„ì¥ (íšŒìƒ‰)
    },
    PHONE_CODES: { 
        "1": "US", "7": "RU", "20": "EG", "27": "ZA", "30": "GR", "31": "NL", "32": "BE", "33": "FR", "34": "ES", 
        "36": "HU", "39": "IT", "40": "RO", "41": "CH", "43": "AT", "44": "UK", "45": "DK", "46": "SE", "47": "NO", 
        "48": "PL", "49": "DE", "51": "PE", "52": "MX", "53": "CU", "54": "AR", "55": "BR", "56": "CL", "57": "CO", 
        "58": "VE", "60": "MY", "61": "AU", "62": "ID", "63": "PH", "64": "NZ", "65": "SG", "66": "TH", "81": "JP", 
        "82": "KR", "84": "VN", "86": "CN", "90": "TR", "91": "IN", "92": "PK", "93": "AF", "94": "LK", "95": "MM", 
        "98": "IR", "852": "HK", "886": "TW" 
    },
    COUNTRY_MAP: { 
        'KR':'í•œêµ­','CN':'ì¤‘êµ­','TW':'ëŒ€ë§Œ','HK':'í™ì½©','SG':'ì‹±ê°€','MY':'ë§ë ˆ','TH':'íƒœêµ­','PH':'í•„ë¦¬',
        'VN':'ë² íŠ¸','ID':'ì¸ë‹ˆ','US':'ë¯¸êµ­','UK':'ì˜êµ­','AU':'í˜¸ì£¼','JP':'ì¼ë³¸' 
    }
};

let currentSeatMap1 = [];
let currentSeatMap2 = [];
let selectedSeat = { busNum: 0, idx: -1 };
let msgListGroups = []; 
let priorityQueue = [];
let audioCtx = null;

// =========================================
// [1] ìœ í‹¸ë¦¬í‹° ë° í—¬í¼ í•¨ìˆ˜
// =========================================

function initAudio() {
  if (!audioCtx) {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AudioContext();
  }
  if (audioCtx.state === 'suspended') { audioCtx.resume(); }
}

function playPopSound() {
  initAudio();
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  osc.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  osc.type = 'sine';
  osc.frequency.setValueAtTime(800, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
  gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.1);
}

document.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON' || (e.target.tagName === 'INPUT' && (e.target.type === 'checkbox' || e.target.type === 'radio')) || e.target.closest('.seat') || e.target.classList.contains('btn-action')) {
        playPopSound();
    }
});

/**
 * [CRITICAL UPDATE] ì „í™”ë²ˆí˜¸ íŒŒì‹± ë¡œì§ ì™„ì „ ìˆ˜ì •
 * 1. ì „í™”ë²ˆí˜¸ ì¹¼ëŸ¼: ì˜¤ì§ 'êµ­ê°€ë²ˆí˜¸' ì¶”ì¶œìš© ë° 'WhatsApp/Viber ì—†ì„ ë•Œ'ì˜ ëŒ€ì²´ì¬ë¡œ ì‚¬ìš©.
 * 2. ë©”ì‹ ì € ì¹¼ëŸ¼: WhatsApp/Viberê°€ ëª…ì‹œëœ ê²½ìš°ì—ë§Œ ìˆ«ì ì¶”ì¶œ. Line/Kakao ë“±ì€ ë¬´ì‹œ.
 * 3. ìµœì¢… ì¡°í•©: (ì¶”ì¶œëœ êµ­ê°€ë²ˆí˜¸) + (ì„ íƒëœ ë²ˆí˜¸ Body).
 * 4. ì¤‘ë³µ ë°©ì§€: ë²ˆí˜¸ Bodyê°€ ì´ë¯¸ êµ­ê°€ë²ˆí˜¸ë¡œ ì‹œì‘í•˜ë©´ ë¶™ì´ì§€ ì•ŠìŒ.
 */
function combinePhoneAndMessenger(phoneCol, messengerCol) {
    let cleanPhoneCol = (phoneCol || "").trim();
    // [Modified Item 1] ì „í™”ë²ˆí˜¸ ì—¬ëŸ¬ ê°œì¼ ë•Œ ë¶„ë¦¬
    let splitPhone = cleanPhoneCol.split(/[,\/]/);
    let firstPhone = splitPhone[0] ? splitPhone[0].trim() : "";
    let cleanMsgCol = (messengerCol || "").trim();
    let lowerMsg = cleanMsgCol.toLowerCase();
    
    // [Step 1] ì „í™”ë²ˆí˜¸ ì¹¼ëŸ¼ì—ì„œ êµ­ê°€ë²ˆí˜¸ ì¶”ì¶œ (Phone Codes Loop)
    // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ìëŠ” ì¼ë‹¨ ì œê±°í•˜ê³  ì•ìë¦¬ ë§¤ì¹­ í™•ì¸
    let rawPhoneDigits = firstPhone.replace(/[^0-9]/g, '');
    let f_CountryCode = "82"; // ê¸°ë³¸ê°’
    let f_Country = "ETC";
    
    // ê¸´ ë²ˆí˜¸ë¶€í„° ë§¤ì¹­ (4ìë¦¬ ~ 1ìë¦¬)
    for (let len = 4; len >= 1; len--) {
        let prefix = rawPhoneDigits.substring(0, len);
        if (CONFIG.PHONE_CODES[prefix]) { 
            f_CountryCode = prefix; 
            f_Country = CONFIG.PHONE_CODES[prefix]; 
            break; 
        }
    }
    
    // [Step 2] ì‚¬ìš©í•  ë²ˆí˜¸ Body ê²°ì • (ìš°ì„ ìˆœìœ„ ë¡œì§)
    let targetBody = "";
    let isMessengerValid = false;
    
    // WhatsApp ë˜ëŠ” Viberê°€ ë©”ì‹ ì € ì¹¼ëŸ¼ì— ëª…ì‹œë˜ì–´ ìˆëŠ”ê°€?
    if (lowerMsg.includes('whatsapp') || lowerMsg.includes('viber')) {
        // ìˆìœ¼ë©´ ë©”ì‹ ì € ì¹¼ëŸ¼ì˜ ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ ì‚¬ìš©
        targetBody = cleanMsgCol.replace(/[^0-9]/g, '');
        isMessengerValid = true;
    } 
    
    // ë©”ì‹ ì € ì¹¼ëŸ¼ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ (Line/Kakao/WeChat ë“±, í˜¹ì€ ë¹„ì–´ìˆìŒ) -> ì „í™”ë²ˆí˜¸ ì¹¼ëŸ¼ ì‚¬ìš©
    if (!isMessengerValid) {
        // ì „í™”ë²ˆí˜¸ ì¹¼ëŸ¼ì˜ ìˆ«ì ì‚¬ìš©. ë‹¨, ì•ì„œ ì¶”ì¶œí•œ êµ­ê°€ë²ˆí˜¸ê°€ ì¤‘ë³µë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜ í•„ìš”.
        targetBody = rawPhoneDigits;
        
        // [Logic Refinement] ì „í™”ë²ˆí˜¸ ì¹¼ëŸ¼ì„ Bodyë¡œ ì“¸ ë•Œ, 
        // ì´ë¯¸ ì•ë¶€ë¶„ì´ êµ­ê°€ë²ˆí˜¸ì™€ ê°™ë‹¤ë©´ ì œê±°í• ì§€ ë§ì§€ ê³ ë¯¼ë˜ì§€ë§Œ,
        // ë³´í†µ ì—‘ì…€ì— 886-9xxx ë¡œ ì í˜€ìˆìœ¼ë©´ êµ­ê°€ë²ˆí˜¸ê°€ ì´ë¯¸ í¬í•¨ëœ ê²ƒì„.
        // ì•„ë˜ Step 4ì—ì„œ ì¤‘ë³µ ì²´í¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„  ê·¸ëŒ€ë¡œ ë‘ .
    }
    
    // [Step 3] ë§¨ ì•ì˜ '0' ì œê±° (êµ­ê°€ë²ˆí˜¸ ë¶™ì´ê¸° ì „ í‘œì¤€í™”)
    if (targetBody.startsWith('0')) targetBody = targetBody.substring(1);
    
    // [Step 4] êµ­ê°€ë²ˆí˜¸ì™€ ê²°í•©
    // ë§Œì•½ Bodyê°€ ì´ë¯¸ í•´ë‹¹ êµ­ê°€ë²ˆí˜¸ë¡œ ì‹œì‘í•œë‹¤ë©´? (ì˜ˆ: Bodyê°€ 852968..., Codeê°€ 852)
    // ì¤‘ë³µí•´ì„œ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤. (852852... ë°©ì§€)
    let fullNumber = "";
    if (targetBody.startsWith(f_CountryCode)) {
        fullNumber = targetBody;
    } else {
        fullNumber = f_CountryCode + targetBody;
    }
    
    return { code: f_CountryCode, country: f_Country, fullNumber: fullNumber };
}

function getGenderGlobal(name) {
  if(!name) return 'N'; const lowerName = name.toLowerCase();
  if(lowerName.includes('mr.') || lowerName.includes('mr ')) return 'M';
  if(lowerName.includes('ms.') || lowerName.includes('mrs.') || lowerName.includes('miss')) return 'F';
  
  const f_list = ['alice','amy','annie','audrey','belle','bernice','carol','cathy','celine','chery','chloe','cindy','clara','connie','crystal','daisy','daphne','doris','elaine','eleanor','elizabeth','emily','eva','fiona','grace','hannah','hazel','helen','irene','iris','ivy','janet','jean','jessica','joan','joanna','joyce','judy','julia','karen','kelly','kitty','linda','lisa','mandy','mary','megan','melissa','michelle','nicole','olivia','peggy','phoebe','rachel','rebecca','regina','rita','rose','ruby','sally','sandy','sarah','sharon','sophie','stella','stephanie','susan','sylvia','teresa','tiffany','tina','tracy','vicky','victoria','vivian','wendy','winnie','yvonne','zoe','ji-eun','min-ji','su-bin','ha-eun','yoon-seo','wei','fang','mei','hui','ying','yan','ling','putri','nur','ayu','sari'];
  const m_list = ['aaron','adam','alan','albert','alex','alfred','alvin','andrew','andy','anthony','arthur','austin','ben','benjamin','bernard','brian','calvin','charles','chris','christopher','daniel','david','dennis','derek','donald','douglas','eddie','edward','eric','felix','frank','gary','george','gordon','harry','henry','howard','hugo','ivan','jack','jackson','jacob','james','jason','jeffrey','jerry','jimmy','joe','john','jonathan','joseph','justin','keith','kelvin','ken','kenneth','kevin','larry','leo','leon','louis','lucas','marcus','mark','martin','matthew','max','michael','mike','nathan','nelson','nicholas','nick','oscar','patrick','paul','peter','philip','raymond','richard','ricky','robert','roger','ronald','roy','ryan','sam','samuel','scott','sean','simon','stanley','stephen','steven','terry','thomas','tim','timothy','tom','tommy','tony','victor','vincent','wayne','william','wilson','ji-hoon','min-jun','jun-ho','wei','jun','jie','ming','muhammad','ahmad','ali','rizky','putra'];
  
  for(let n of f_list) { if(lowerName.includes(n)) return 'F'; }
  for(let n of m_list) { if(lowerName.includes(n)) return 'M'; }
  return 'N';
}

function getMessengerApp(text) { 
    if(!text) return 'ë¬´'; const t = text.toLowerCase(); 
    if(t.includes('whatsapp')) return 'ì™€'; if(t.includes('line')) return 'ë¼'; 
    if(t.includes('kakao')) return 'ì¹´'; if(t.includes('wechat') || t.includes('weixin')) return 'ì›¨'; 
    if(t.includes('viber')) return 'ë°”'; if(t.includes('zalo')) return 'ì˜'; return 'ë¬´'; 
}

function copyToClipboard(text, el) {
    const helper = document.getElementById('clipboardHelper');
    helper.value = text; helper.style.opacity = '1'; helper.select(); helper.setSelectionRange(0, 99999); 
    try { if(document.execCommand('copy')) feedback(el); else alert('ë³µì‚¬ ì‹¤íŒ¨'); } catch (err) { alert('ì—ëŸ¬: ' + err); }
    helper.style.opacity = '0';
}
function feedback(el) { if(!el) return; let original = el.innerHTML; el.innerHTML = 'OK!'; setTimeout(() => el.innerHTML = original, 800); }
function copyMessageBody(btn) { const card = btn.closest('.msg-card'); const hiddenDiv = card.querySelector('.hidden-msg'); copyToClipboard(hiddenDiv.textContent, btn); }
function copyOnly(el, text) { copyToClipboard(text, el); }

// =========================================
// [2] ë°ì´í„° íŒŒì‹± ë° ì „ì²˜ë¦¬
// =========================================

function parseRawDataLine(line, originalOrder) {
    let parts = line.split('\t'); 
    if(parts.length < 4) return null;
    
    let firstCol = parts[0] ? parts[0].trim() : "";
    if (firstCol === 'No.' || firstCol.toLowerCase().startsWith('total') || firstCol.includes('ì—‘ì…€') || firstCol.includes('ë‚ ì§œ')) return null;

    // [Logic Check 1] Tour Type Detection (Strict)
    // "ski" or "snowboard" in text = Ski Tour. Else = General.
    const lineLower = line.toLowerCase();
    const isSkiTour = lineLower.includes('ski') || lineLower.includes('snowboard');
    
    let customId, productName, name, rawPhone, messengerCol, count, location, rawLang, note;
    let optLift = false, optGear = false, optClothes = false, optLesson = false;
    
    // ì´ë©”ì¼ ì¶”ì¶œ ë¡œì§
    let emailAddr = "";
    for(let p of parts) { if(p && p.includes('@')) { emailAddr = p.trim(); break; } }

    if (!isSkiTour) { // ì¼ë°˜/ì‚°ì²œì–´ (General)
        // General Format Mapping
        customId = parts[0] ? parts[0].trim() : originalOrder.toString();
        productName = parts[2] ? parts[2].trim() : ""; 
        name = parts[4] ? parts[4].trim() : "Guest";
        rawPhone = parts[5] ? parts[5].trim() : ""; // Column F
        messengerCol = parts[6] ? parts[6].trim() : ""; // Column G
        rawLang = parts[8] ? parts[8].trim() : "";
        count = parseInt(parts[9]) || 1;
        location = parts[10] ? parts[10].trim() : "";
        note = parts[12] ? parts[12].trim() : "";
    } else { // ìŠ¤í‚¤ (Ski)
        // Ski Format Mapping
        customId = parts[0] ? parts[0].trim() : originalOrder.toString();
        productName = parts[1] ? parts[1].trim() : "";
        name = parts[3] ? parts[3].trim() : "Guest"; 
        rawPhone = parts[4] ? parts[4].trim() : ""; // Column E
        messengerCol = parts[5] ? parts[5].trim() : ""; // Column F
        rawLang = parts[7] ? parts[7].trim() : "";
        count = parseInt(parts[8]) || 1;
        location = parts[9] ? parts[9].trim() : "";
        note = parts[10] ? parts[10].trim() : "";
        
        // Options Check
        if (parts[11] && parseInt(parts[11]) > 0) optLift = true;
        if (parts[12] && parseInt(parts[12]) > 0) optGear = true;
        if (parts[13] && parseInt(parts[13]) > 0) optClothes = true;
        if (parts[14] && parseInt(parts[14]) > 0) optLesson = true;
    }

    // PaxType ë¶„ì„
    let paxType = 'General'; let isStay = false; 
    let isBoard = (productName.toLowerCase().includes('board') || productName.includes('ë³´ë“œ'));
    let isHot = (productName.toLowerCase().includes('hot')); // Ski Tourì˜ ê²½ìš° HOT í‘œì‹œ í™•ì¸

    let lowerP = productName.toLowerCase();
    if (lowerP.includes('day1') || lowerP.includes('day 1')) { paxType = 'D1'; }
    else if (lowerP.includes('day2') || lowerP.includes('day 2')) { paxType = 'D2'; }
    else if (lowerP.includes('day3') || lowerP.includes('day 3')) { paxType = 'D3'; }
    else if (lowerP.includes('í¸ë„') || lowerP.includes('one way')) { paxType = 'D1'; }
    
    if (paxType === 'General' && (location.includes('ìŠ¤í‚¤ì¥') || location.includes('Resort'))) { paxType = 'D2'; }

    // [Logic Check 3] New Phone Logic Applied Here
    let parsedInfo = combinePhoneAndMessenger(rawPhone, messengerCol);
    
    let langContext = (rawLang && rawLang.includes('ì¤‘êµ­ì–´')) ? 'CN' : 'EN';
    let gender = getGenderGlobal(name); 
    let appType = getMessengerApp(messengerCol);

    return {
      id: customId, originalId: originalOrder, name: name, 
      phone: parsedInfo.fullNumber, // ì •ì œëœ ë²ˆí˜¸ ì‚¬ìš©
      count: count, location: location, note: note,
      country: parsedInfo.country, langContext: langContext, gender: gender, appType: appType, messenger: messengerCol, isGrouped: false,
      paxType: paxType, isStay: isStay, isBoard: isBoard, 
      isSancheoneo: !isSkiTour, isHot: isHot, email: emailAddr,
      options: { lift: optLift, gear: optGear, clothes: optClothes, lesson: optLesson }
    };
}
function createGroupsFromEntries(entries) {
    let finalGroups = [];
    entries.forEach((entry) => {
        if(entry.isGrouped) return;
        
        // [Logic Check] BFSë¡œ ì—°ê²°ëœ(ì „í™”ë²ˆí˜¸ ê°™ì€) ì‚¬ëŒ ì°¾ê¸°
        // *ì¤‘ìš”* : ì „í™”ë²ˆí˜¸ê°€ ìœ íš¨í•œ ê²½ìš°(5ìë¦¬ ì´ìƒ)ì—ë§Œ ë¬¶ìŒ ì²˜ë¦¬.
        let currentGroupMembers = [entry]; entry.isGrouped = true;
        
        if (entry.phone && entry.phone.length > 5) {
            let queue = [entry];
            while(queue.length > 0) {
                let curr = queue.shift();
                entries.forEach((target) => {
                    if(target.isGrouped) return;
                    // ì „í™”ë²ˆí˜¸ê°€ ê°™ìœ¼ë©´ ê°™ì€ íŒ€ìœ¼ë¡œ ê°„ì£¼
                    if(target.phone && target.phone.length > 5 && curr.phone === target.phone) {
                        target.isGrouped = true; 
                        currentGroupMembers.push(target); 
                        queue.push(target); 
                    }
                });
            }
        }

        // ëŒ€í‘œì(ì²« ë²ˆì§¸ ì‚¬ëŒ) ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹ ì •ë³´ ìƒì„±
        let rep = currentGroupMembers[0];
        
        // ê·¸ë£¹ ë²ˆí˜¸ í‘œì‹œ (ì˜ˆ: 1.2.3)
        let cleanIds = currentGroupMembers.map(m => m.id.replace(/\D/g, '')); 
        if (cleanIds.some(id => id === "")) cleanIds = currentGroupMembers.map(m => m.id);
        cleanIds.sort((a,b) => parseInt(a) - parseInt(b));
        
        let displayNum = cleanIds.join('.'); 
        let totalC = currentGroupMembers.reduce((sum, m) => sum + m.count, 0);
        
        // íˆ¬ì–´ íƒ€ì… ê²°ì • (D3 > D2 > D1 > General)
        let groupType = 'General';
        if(currentGroupMembers.some(m => m.paxType === 'D3')) groupType = 'D3';
        else if(currentGroupMembers.some(m => m.paxType === 'D2')) groupType = 'D2';
        else if(currentGroupMembers.some(m => m.paxType === 'D1')) groupType = 'D1';
        if (groupType === 'D1' && currentGroupMembers.some(m => m.paxType === 'General')) groupType = 'D1';

        // ì˜µì…˜ ë³‘í•© (íŒ€ì› ì¤‘ í•œ ëª…ì´ë¼ë„ ì˜µì…˜ì´ ìˆìœ¼ë©´ íŒ€ ì „ì²´ì— í‘œì‹œ)
        let gLift = currentGroupMembers.some(m => m.options.lift);
        let gGear = currentGroupMembers.some(m => m.options.gear);
        let gClothes = currentGroupMembers.some(m => m.options.clothes);
        let gLesson = currentGroupMembers.some(m => m.options.lesson);

        finalGroups.push({
            mainNum: displayNum, 
            msgNum: rep.id + (currentGroupMembers.length > 1 ? ".." : ""), 
            repNum: rep.id, 
            count: totalC, 
            name: rep.name, 
            country: rep.country, 
            gender: rep.gender, 
            langContext: rep.langContext, 
            appType: rep.appType, 
            location: rep.location, 
            phone: rep.phone, // *ì¤‘ìš”* ì •ì œëœ ë²ˆí˜¸ í•˜ë‚˜ë§Œ ì‚¬ìš©
            messenger: rep.messenger, 
            paxType: groupType, 
            isStay: currentGroupMembers.some(m => m.isStay), 
            isBoard: currentGroupMembers.some(m => m.isBoard), 
            isSancheoneo: rep.isSancheoneo,
            isHot: currentGroupMembers.some(m => m.isHot),
            email: rep.email,
            options: { lift: gLift, gear: gGear, clothes: gClothes, lesson: gLesson }
        });
    });
    return finalGroups;
}

function calculateScore(grp) {
    let score = 0;
    priorityQueue.forEach((criteria, idx) => {
        let weight = Math.pow(10, 6 - idx); let match = false;
        if (criteria === 'solo' && grp.count === 1) match = true;
        if (criteria === 'CN' && grp.langContext === 'CN') match = true;
        if (criteria === 'EN' && grp.langContext === 'EN') match = true;
        if (criteria === 'F' && grp.gender === 'F') match = true;
        if (criteria === 'M' && grp.gender === 'M') match = true;
        if (criteria === 'G4' && grp.count >= 4) match = true;
        if(match) score += weight;
    });
    return score;
}

function getPickColor(grp) {
    let loc = grp.location || '';
    if (grp.paxType === 'D2' || grp.paxType === 'D3') return CONFIG.COLORS.resort;
    if (loc.includes('í™ëŒ€')) return CONFIG.COLORS.hongdae;
    if (loc.includes('ëª…ë™')) return CONFIG.COLORS.myeongdong;
    if (loc.includes('ë™ëŒ€ë¬¸')) return CONFIG.COLORS.dongdaemun;
    return CONFIG.COLORS.etc;
}

function setGroupMeta(grp) {
    let nation = grp.country;
    if (CONFIG.COUNTRY_MAP[grp.country]) nation = CONFIG.COUNTRY_MAP[grp.country];
    let genderSymbol = 'â–³'; let txtClass = 'neutral-text';
    if(grp.gender === 'F') { genderSymbol = 'â™€'; txtClass = 'female-text'; } 
    else if(grp.gender === 'M') { genderSymbol = 'â™‚'; txtClass = 'male-text'; }
    grp.textClass = txtClass; grp.subInfo = `${nation}${genderSymbol}`;
}
// =========================================
// [4] ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ (runAI)
// =========================================

function runAI() {
    // 1. ìƒíƒœ ì €ì¥ ë° ì´ˆê¸°í™”
    saveTextInput(); saveTimeInput(); saveGuideName();
    localStorage.removeItem('bus_seatMap');
    
    const raw = document.getElementById('rawData').value;
    const busSize = parseInt(document.querySelector('input[name="busSize"]:checked').value);
    const direction = document.querySelector('input[name="direction"]:checked').value;
    const lines = raw.trim().split('\n');
    
    // 2. íŒŒì‹± (Line ë‹¨ìœ„ ìŠ¤í‚¤/ì¼ë°˜ êµ¬ë¶„ ì ìš©ë¨)
    let entries = []; let originalOrder = 1;
    lines.forEach(line => {
        const parsed = parseRawDataLine(line, originalOrder);
        if(parsed) { entries.push(parsed); originalOrder++; }
    });

    // 3. ê·¸ë£¹í•‘
    msgListGroups = createGroupsFromEntries(entries);

    // 4. ì •ë ¬ (Map 1: ê°€ëŠ” í¸)
    let listGoing = msgListGroups.filter(g => g.paxType === 'General' || g.paxType === 'D1');
    if (direction === 'front') listGoing.sort((a,b) => calculateScore(b) - calculateScore(a));
    else listGoing.sort((a,b) => calculateScore(a) - calculateScore(b));

    // 5. ì¢Œì„ ë°°ì¹˜ (Map 1)
    currentSeatMap1 = new Array(busSize + 1).fill(null);
    let seatSequence = generateSeatSequence(999, busSize);
    let currentSeqIdx = 0;

    listGoing.forEach((grp) => {
        grp.color = getPickColor(grp); 
        setGroupMeta(grp);
        for(let i=0; i<grp.count; i++) {
            if(currentSeqIdx < seatSequence.length) {
                let seatNum = seatSequence[currentSeqIdx];
                currentSeatMap1[seatNum] = { ...grp }; 
                currentSeqIdx++;
            }
        }
    });

    // 6. Map 2 ë™ê¸°í™” (General ìŠ¹ê° ë³µì‚¬)
    currentSeatMap2 = new Array(busSize + 1).fill(null);
    for(let i=1; i<=busSize; i++) {
        if(currentSeatMap1[i]) {
            if (currentSeatMap1[i].paxType === 'General') {
                let cloned = { ...currentSeatMap1[i] }; cloned.color = '#e0e0e0'; cloned.isSynced = true; currentSeatMap2[i] = cloned;
            }
        }
    }

    // 7. Map 2 ë°°ì¹˜ (D2/D3 ëŒì•„ì˜¤ëŠ” í¸)
    let listReturnOnly = msgListGroups.filter(g => g.paxType === 'D2' || g.paxType === 'D3');
    toggleMap2(listReturnOnly.length > 0); 

    if (direction === 'front') listReturnOnly.sort((a,b) => calculateScore(b) - calculateScore(a));
    else listReturnOnly.sort((a,b) => calculateScore(a) - calculateScore(b));

    let emptySeatsMap2 = [];
    seatSequence.forEach(seatNum => { if(!currentSeatMap2[seatNum]) emptySeatsMap2.push(seatNum); });
    
    let d23Passengers = [];
    listReturnOnly.forEach((grp) => {
        grp.color = getPickColor(grp); 
        setGroupMeta(grp);
        if (!grp.isStay) { for(let k=0; k<grp.count; k++) { d23Passengers.push({ ...grp, count: 1 }); } }
    });
    
    let pIdx = 0;
    for(let k=0; k<emptySeatsMap2.length; k++) {
        if(pIdx >= d23Passengers.length) break;
        let seatNum = emptySeatsMap2[k]; currentSeatMap2[seatNum] = d23Passengers[pIdx]; pIdx++;
    }

    // 8. ì €ì¥ ë° ë Œë”ë§
    saveSeatMap(); redrawAll(busSize); renderMessages(msgListGroups, currentSeatMap1, currentSeatMap2);
}

function generateSeatSequence(totalPax, busSize) {
  let sequence = []; for(let i = 5; i <= busSize; i++) sequence.push(i);
  sequence.push(4); sequence.push(3); sequence.push(2); sequence.push(1); 
  return sequence;
}

// =========================================
// [5] UI ë Œë”ë§ ë° ì¸í„°ë™ì…˜
// =========================================

function redrawAll(busSize) {
    renderBus(currentSeatMap1, busSize, 'busGrid1', 1); 
    renderBus(currentSeatMap2, busSize, 'busGrid2', 2);
    updateHeader1(currentSeatMap1); 
    updateHeader2(currentSeatMap2);
}

function renderBus(seatMap, maxSeats, gridId, busNum) {
  const grid = document.getElementById(gridId); grid.innerHTML = '';
  for(let row=0; row<11; row++) {
    if(maxSeats === 45 && row === 10) {
      let lastRowDiv = document.createElement('div'); lastRowDiv.className = 'last-row-45';
      for(let k=41; k<=45; k++) createSeatElement(lastRowDiv, k, seatMap, maxSeats, busNum);
      grid.appendChild(lastRowDiv); continue; 
    }
    for(let col=0; col<5; col++) {
      if(col === 2) { grid.appendChild(document.createElement('div')); continue; }
      let seatNum = (row < 10) ? (row * 4) + (col < 2 ? col + 1 : col) : (col < 2 ? 40 + col + 1 : 40 + col);
      createSeatElement(grid, seatNum, seatMap, maxSeats, busNum);
    }
  }
}

function createSeatElement(parent, seatNum, seatMap, maxSeats, busNum) {
  let seatDiv = document.createElement('div'); seatDiv.className = 'seat'; seatDiv.dataset.idx = seatNum;
  if(selectedSeat.busNum === busNum && selectedSeat.idx === seatNum) seatDiv.classList.add('selected');
  if (busNum === 2 && seatMap[seatNum] && seatMap[seatNum].paxType === 'General') { seatDiv.classList.add('synced-general'); }
  
  if(seatNum <= 4) {
    if (seatMap[seatNum]) renderSeatContent(seatDiv, seatMap[seatNum], seatNum, busNum);
    else { seatDiv.classList.add('emergency'); renderSeatContent(seatDiv, null, seatNum, busNum); }
  } else {
    renderSeatContent(seatDiv, seatMap[seatNum], seatNum, busNum);
  }
  
  seatDiv.onclick = function() { handleSeatClick(this, busNum, seatNum, maxSeats); };
  parent.appendChild(seatDiv);
}

function renderSeatContent(el, data, num, busNum) {
  el.innerHTML = `<span class="seat-num">${num}</span>`;
  if(data) {
    if (busNum === 2 && data.paxType === 'General') { 
        el.style.backgroundColor = data.color; 
        el.innerHTML += `<div style="font-size:30px; color:#757575; font-weight:bold; margin-top:10px;">âŒ</div>`; 
        return; 
    }
    el.style.backgroundColor = data.color;
    let dispNum = data.mainNum; let longClass = data.isLong ? 'long-text' : '';
    let dayTagHtml = "";
    
    if (data.isHot) dayTagHtml += `<span class="day-tag tag-hot">H</span>`;
    if (data.paxType === 'D1') dayTagHtml += `<span class="day-tag tag-d1">D1</span>`;
    if (data.paxType === 'D2') dayTagHtml += `<span class="day-tag tag-d2">D2</span>`;
    if (data.paxType === 'D3') dayTagHtml += `<span class="day-tag tag-d3">D3</span>`;
    
    el.innerHTML += `<div class="grp-id ${longClass}">${dispNum}</div><div class="info-badge ${data.textClass}">${dayTagHtml}${data.subInfo}</div>`;
  } else el.className += " empty";
}

function handleSeatClick(el, busNum, seatIdx, busSize) {
    if(selectedSeat.idx === -1) { 
        selectedSeat = { busNum: busNum, idx: seatIdx }; el.classList.add('selected'); 
    } else {
        let sourceBus = selectedSeat.busNum; let sourceIdx = selectedSeat.idx; let targetBus = busNum; let targetIdx = seatIdx;
        if (sourceBus !== targetBus) { alert("ê°™ì€ ë²„ìŠ¤ë¼ë¦¬ë§Œ ì´ë™ ê°€ëŠ¥!"); resetSelection(); return; }
        
        let mapMain = (sourceBus === 1) ? currentSeatMap1 : currentSeatMap2;
        let paxS = mapMain[sourceIdx]; let paxT = mapMain[targetIdx];
        
        mapMain[sourceIdx] = paxT; mapMain[targetIdx] = paxS;
        
        if (sourceBus === 1) {
            if (paxS && paxS.paxType === 'General') syncMoveToMap2(sourceIdx, targetIdx, busSize);
            if (paxT && paxT.paxType === 'General') syncMoveToMap2(targetIdx, sourceIdx, busSize);
        }
        resetSelection(); refreshDisplay();
    }
}

function syncMoveToMap2(fromIdx, toIdx, busSize) {
    let mover = currentSeatMap2[fromIdx]; if (!mover || mover.paxType !== 'General') return;
    let obstacle = currentSeatMap2[toIdx]; 
    if (!obstacle || obstacle.paxType === 'General') { 
        currentSeatMap2[fromIdx] = obstacle; currentSeatMap2[toIdx] = mover; 
    } else if (obstacle.paxType === 'D2' || obstacle.paxType === 'D3') {
        currentSeatMap2[toIdx] = mover; currentSeatMap2[fromIdx] = null; 
        let newSeat = findEmptySeatMap2(busSize);
        if (newSeat !== -1) { currentSeatMap2[newSeat] = obstacle; }
    }
}

function findEmptySeatMap2(busSize) {
    let sequence = generateSeatSequence(999, busSize); 
    for (let idx of sequence) { if (currentSeatMap2[idx] === null) return idx; } 
    return -1;
}

function resetSelection() { 
    document.querySelectorAll('.seat.selected').forEach(e => e.classList.remove('selected')); 
    selectedSeat = { busNum: 0, idx: -1 }; 
}

function refreshDisplay() {
    const scrollY = window.scrollY; const busSize = parseInt(localStorage.getItem('bus_size') || "44");
    saveSeatMap(); redrawAll(busSize); renderMessages(msgListGroups, currentSeatMap1, currentSeatMap2);
    window.scrollTo(0, scrollY);
}

// =========================================
// [6] ë©”ì‹œì§€ ìƒì„± ë¡œì§ (ìˆ˜ì •ë¨)
// =========================================

function renderMessages(allGroups, seatMap1, seatMap2) {
    const msgList = document.getElementById('msgList');
    const section = document.getElementById('msgSection');
    msgList.innerHTML = ''; section.style.display = 'block';
    
    const statusData = JSON.parse(localStorage.getItem('bus_msgStatus') || '{}');
    const guideName = document.getElementById('guideNameInput').value || "Mr. Shin";
    const tH = document.getElementById('timeHongdae').value;
    const tM = document.getElementById('timeMyeongdong').value;
    const tD = document.getElementById('timeDongdaemun').value;
    const specialMsg = document.getElementById('specialNotice').value;
    const finalSpecial = specialMsg ? `\n\n${specialMsg}\n` : "";

    allGroups.sort((a, b) => {
        let numA = parseInt(a.repNum.replace(/\D/g, '')) || 0; let numB = parseInt(b.repNum.replace(/\D/g, '')) || 0;
        return numA - numB;
    });

    allGroups.forEach((g, idx) => {
        let seatStr = ""; let targetMap = (g.paxType === 'D2' || g.paxType === 'D3') ? seatMap2 : seatMap1;
        if (g.isStay) seatStr = "STAY (No Seat)";
        else {
            let seats = [];
            for(let i=1; i<targetMap.length; i++) { if(targetMap[i] && targetMap[i].repNum === g.repNum) seats.push(i); }
            seatStr = seats.sort((a,b)=>a-b).join('-');
        }

        let gid = g.repNum; let msgText = ""; let langTag = "";
        
        let txtLift = g.options.lift ? "Included âœ…" : "Lift 7hr: 75,000 / 60,000";
        let txtClothes = g.options.clothes ? "Included âœ…" : "Clothes: 20,000";
        let txtGear = g.options.gear ? "Included âœ…" : "Gear: 15,000 / 20,000";
        
        // [ìˆ˜ì • í•­ëª© 3] ê³ ì • Price List ì •ì˜
        const priceList_CN = `[Price List]\n\nS. ç§¯æå¿ƒæ€ï¼ˆåŒ…å«ï¼‰\n\nA. ç¼†è½¦ + è£…å¤‡\n   å‘¨æœ« 70,000 / å¹³æ—¥ 60,000\nB. å¤´ç›” 20,000\nC. æŠ¤å…· 15,000\nD. æ»‘é›ªæœ 20,000\nE. é›ªæ©‡ 30,000\nF. è§‚å…‰ç¼†è½¦ 20,000\n\n*(åˆ·å¡ Card +10%)`;
        const priceList_EN = `[Price List]\n\nS. Positive mindset (Included)\n\nA. Lift + Gear\n   Weekend 70,000 / Weekday 60,000\nB. Helmet 20,000\nC. Guard 15,000\nD. Ski Clothes 20,000\nE. Sled 30,000\nF. Sightseeing Lift 20,000\n\n*(Card payment +10%)`;

        // ìŠ¤í‚¤ì¥ ì†ë‹˜ (D2, D3, General Ski)
        if (g.paxType === 'D2' || g.paxType === 'D3' || (!g.isSancheoneo && g.paxType === 'General')) {
            let isReturnGuest = (g.paxType === 'D2' || g.paxType === 'D3');
            let dayLabel = isReturnGuest ? (g.paxType === 'D3' ? "Day 3" : "Day 2") : "Day 1";
            
            // ê·€ê°€ ê°€ì´ë“œ (D2/D3)
            if (isReturnGuest) {
                // [ìˆ˜ì • í•­ëª© 2] ì–¸ì–´ë³„ ë©”ì‹œì§€ ì™„ì „ ë¶„ë¦¬
                let step3_EN = "3. Gathering (15:40)\nğŸ“ Lobby (With luggage)";
                let step3_CN = "3. é›†åˆ Gathering (15:40)\nğŸ“ é…’åº—å¤§å… (å¸¦ä¸Šæ‰€æœ‰è¡Œæ)";
                
                if (g.isStay) { 
                    step3_EN = "3. Stay Guest\nğŸ“ No Bus (Enjoy Skiing!)"; 
                    step3_CN = "3. ç»­ä½ (Stay)\nğŸ“ No Bus (Enjoy Skiing!)"; 
                }

                if(g.langContext === 'CN') {
                    langTag = `<span class="lang-tag lang-CN">ä¸­æ–‡(${dayLabel})</span>`;
                    msgText = `[${dayLabel}/Return Guide - ${guideName}]\nGroup: ${g.msgNum}\nSeat: ${seatStr}\n\n1. é€€æˆ¿ Check-out (11:00 å‰)\n*è¡Œæå¯„æ”¾ä¸€æ¥¼å¤§å… (Lobby)\nâš ï¸ è¿Ÿäº¤ç½šæ¬¾ (Late): 10,000 / 30åˆ†\n\n2. Klook ä¼‘æ¯å®¤ (10:00)\nğŸ‘‰ ä»˜æ¬¾ & é¢†å–ç¼†è½¦ç¥¨ (Payment/Ticket)\n\n${step3_CN}\n\n${priceList_CN}`;
                } else {
                    langTag = `<span class="lang-tag lang-EN">ENG(${dayLabel})</span>`;
                    msgText = `[${dayLabel}/Return Guide - ${guideName}]\nGroup: ${g.msgNum}\nSeat: ${seatStr}\n\n1. Check-out (Until 11:00)\n*Leave bags at Lobby\nâš ï¸ Late Penalty: 10,000 KRW / 30min\n\n2. Klook Lounge (10:00)\nğŸ‘‰ Payment & Get Lift Card\n\n${step3_EN}\n\n${priceList_EN}`;
                }
            } 
            // ì¼ë°˜ ìŠ¤í‚¤ íˆ¬ì–´ ì¶œë°œ (General Ski)
            else {
                 let pickupInfo = ""; let loc = g.location ? g.location.trim() : "";
                 if(g.langContext === 'CN') {
                    langTag = `<span class="lang-tag lang-CN">SKI(CN)</span>`;
                    if (loc.includes('í™ëŒ€')) { pickupInfo = `â—ï¸${tH} å¼˜å¤§å…¥å£ç«™ 8è™Ÿå‡ºå£ (Hongik Univ. Exit 8)`; } 
                    else if (loc.includes('ëª…ë™')) { pickupInfo = `â—ï¸${tM} æ˜æ´ç«™ 3è™Ÿå‡ºå£ (Myeongdong Exit 3)`; } 
                    else if (loc.includes('ë™ëŒ€ë¬¸')) { pickupInfo = `â—ï¸${tD} æ±å¤§é–€æ­·å²æ–‡åŒ–å…¬åœ’ç«™ 11è™Ÿå‡ºå£ (DDP Exit 11)`; } 
                    else { pickupInfo = `â—ï¸${tH} å¼˜ëŒ€ 8ë²ˆ / â—ï¸${tM} ëª…ë™ 3ë²ˆ / â—ï¸${tD} ë™ëŒ€ë¬¸ 11ë²ˆ`; }
                    msgText = `[Ski Tour Guide ${guideName}]\n${pickupInfo}${finalSpecial}\n*é²åˆ°æ•ä¸é€€æ¬¾ã€‚\n*è»Šå…§åªå…è¨±é£²ç”¨ç™½æ°´ã€‚\n\n[Option Check]\nLift: ${txtLift}\nClothes: ${txtClothes}\nGear: ${txtGear}\n\nğŸ‘‰ è«‹å›è¦† "æ‚¨çš„å‡ºç™¼æ™‚é–“" ä»¥ç¢ºèªæ”¶åˆ°ã€‚\n\nGroup: ${g.msgNum}\nSeat: ${seatStr}`;
                } else {
                    langTag = `<span class="lang-tag lang-EN">SKI(EN)</span>`;
                    if (loc.includes('í™ëŒ€') || loc.includes('Hongik')) { pickupInfo = `â—ï¸${tH} Hongik Univ. Exit 8`; } 
                    else if (loc.includes('ëª…ë™') || loc.includes('Myeongdong')) { pickupInfo = `â—ï¸${tM} Myeongdong Exit 3`; } 
                    else if (loc.includes('ë™ëŒ€ë¬¸')) { pickupInfo = `â—ï¸${tD} Dongdaemun History Culture Exit 11`; } 
                    else { pickupInfo = `â—ï¸${tH} Hongik Univ. Exit 8 / â—ï¸${tM} Myeongdong Exit 3 / â—ï¸${tD} Dongdaemun History & Culture Park Station Exit 11`; }
                    msgText = `[Ski Tour Guide ${guideName}]\n${pickupInfo}${finalSpecial}\n*No refund if late.\n*Only water is allowed on bus.\n\n[Option Check]\nLift: ${txtLift}\nClothes: ${txtClothes}\nGear: ${txtGear}\n\nğŸ‘‰ Reply "Your departure time" to confirm\n\nGroup: ${g.msgNum}\nSeat: ${seatStr}`;
                }
            }
        } 
        // ì‚°ì²œì–´ / ì¼ë°˜ íˆ¬ì–´
        else {
             let pickupInfo = ""; let loc = g.location ? g.location.trim() : "";
            if(g.langContext === 'CN') {
                langTag = `<span class="lang-tag lang-CN">TOUR(CN)</span>`;
                if (loc.includes('í™ëŒ€')) { pickupInfo = `â—ï¸${tH} å¼˜å¤§å…¥å£ç«™ 8è™Ÿå‡ºå£ (Hongik Univ. Exit 8)`; } 
                else if (loc.includes('ëª…ë™')) { pickupInfo = `â—ï¸${tM} æ˜æ´ç«™ 3è™Ÿå‡ºå£ (Myeongdong Exit 3)`; } 
                else if (loc.includes('ë™ëŒ€ë¬¸')) { pickupInfo = `â—ï¸${tD} æ±å¤§é–€æ­·å²æ–‡åŒ–å…¬åœ’ç«™ 11è™Ÿå‡ºå£ (DDP Exit 11)`; } 
                else { pickupInfo = `â—ï¸${tH} å¼˜ëŒ€ 8ë²ˆ / â—ï¸${tM} ëª…ë™ 3ë²ˆ / â—ï¸${tD} ë™ëŒ€ë¬¸ 11ë²ˆ`; }
                msgText = `[Tour Guide ${guideName}]\n${pickupInfo}${finalSpecial}\n*ç‚ºäº†é¿é–‹äº¤é€šå µå¡ï¼Œæˆ‘å€‘æœƒæº–æ™‚å‡ºç™¼ã€‚\n*é²åˆ°æ•ä¸é€€æ¬¾ã€‚\n*è»Šå…§åªå…è¨±é£²ç”¨ç™½æ°´ã€‚\n*ä¸åŒ…å«é¤è²»ã€‚\n\nğŸ‘‰ è«‹å›è¦† "æ‚¨çš„å‡ºç™¼æ™‚é–“" ä»¥ç¢ºèªæ”¶åˆ°ã€‚\n\nGroup: ${g.msgNum}\nSeat: ${seatStr}`;
            } else {
                langTag = `<span class="lang-tag lang-EN">TOUR(EN)</span>`;
                if (loc.includes('í™ëŒ€') || loc.includes('Hongik')) { pickupInfo = `â—ï¸${tH} Hongik Univ. Exit 8`; } 
                else if (loc.includes('ëª…ë™') || loc.includes('Myeongdong')) { pickupInfo = `â—ï¸${tM} Myeongdong Exit 3`; } 
                else if (loc.includes('ë™ëŒ€ë¬¸')) { pickupInfo = `â—ï¸${tD} Dongdaemun History Culture Exit 11`; } 
                else { pickupInfo = `â—ï¸${tH} Hongik Univ. Exit 8 / â—ï¸${tM} Myeongdong Exit 3 / â—ï¸${tD} Dongdaemun History & Culture Park Station Exit 11`; }
                msgText = `[Tour Guide ${guideName}]\n${pickupInfo}${finalSpecial}\n*We depart early to avoid traffic.\n*There is no refund if you are late.\n*Only water is allowed on the bus.\n*Meals are not included.\n\nğŸ‘‰ Reply "Your departure time" to confirm\n\nGroup: ${g.msgNum}\nSeat: ${seatStr}`;
            }
        }

        // [ìˆ˜ì • í•­ëª© 4] Day 2, Day 3 ë©”ì‹œì§€ì—ëŠ” ë§í¬ ì œê±°
        if (g.isBoard && g.paxType !== 'D2' && g.paxType !== 'D3') {
            msgText += `\n\nğŸ“º How to wear boots:\n${CONFIG.BOOTS_YOUTUBE}`;
        }

        // ë²„íŠ¼ ìƒì„± ë¡œì§
        let waNumber = g.phone; 
        let hasPhone = (waNumber && waNumber.length > 5);
        let encodedText = encodeURIComponent(msgText);
        let waLink = hasPhone ? `https://wa.me/${waNumber}?text=${encodedText}` : '#';
        let waBtnClass = hasPhone ? 'btn-action btn-wa-send' : 'btn-action btn-wa-send disabled';
        let isContacted = statusData[gid]?.contacted || false; let isConnected = statusData[gid]?.connected || false; let memoText = statusData[gid]?.memo || "";
        
        let appIconHtml = getAppIconHtml(g.messenger, g.appType);
        
        let extraTags = "";
        if (g.isHot) extraTags += `<span class="day-tag tag-hot" style="margin-left:5px;">H</span>`;
        if (g.paxType === 'D1') extraTags += `<span class="day-tag tag-d1" style="margin-left:5px;">[D1]</span>`;
        if (g.paxType === 'D2') extraTags += `<span class="day-tag tag-d2" style="margin-left:5px;">[D2]</span>`;
        if (g.paxType === 'D3') extraTags += `<span class="day-tag tag-d3" style="margin-left:5px;">[D3]</span>`;
        
        let emailBtnHtml = g.email ? `<div class="btn-action btn-copy-mail" onclick="copyOnly(this, '${g.email}')">Mail<br>Copy</div>` : "";

        let card = document.createElement('div'); card.className = 'msg-card';
        card.innerHTML = `
            <div class="msg-check-area">
                <div class="check-box-wrapper"><label class="msg-check-label label-sent">ì—°ë½í•¨</label><input type="checkbox" class="msg-check-input chk-sent" onchange="updateMsgStatus('${gid}', 'contacted', this.checked, null)" ${isContacted ? 'checked' : ''}></div>
                <div class="check-box-wrapper"><label class="msg-check-label label-connected">ì—°ë½ë¨</label><input type="checkbox" class="msg-check-input chk-conn" onchange="updateMsgStatus('${gid}', 'connected', this.checked, null)" ${isConnected ? 'checked' : ''}></div>
            </div>
            <div class="msg-info">
                <div class="msg-group-row"><span class="msg-group">${g.msgNum}</span>${langTag}${extraTags}</div>
                <div class="msg-seats">Seat: ${seatStr}</div>
                <input type="text" class="msg-memo-input" placeholder="ë¹„ê³ " value="${memoText}" oninput="updateMsgStatus('${gid}', null, null, this.value)">
                <div class="hidden-msg">${msgText}</div>
            </div>
            <div class="msg-actions">
                <a href="${waLink}" target="_blank" class="${waBtnClass}">Send<br>WA</a>
                <div class="btn-action btn-copy-body" onclick="copyMessageBody(this)">ë³¸ë¬¸<br>Copy</div>
                ${emailBtnHtml}
                ${appIconHtml}
            </div>
        `;
        msgList.appendChild(card);
    });
}

function getAppIconHtml(rawMsg, appType) {
    if (!rawMsg) return `<div class="btn-action logo-none">X</div>`;
    let appClass = 'logo-none'; let copyValue = ""; let appName = "X"; 
    let lower = rawMsg.toLowerCase();
    
    // ë‹¨ìˆœ ë²ˆí˜¸ë§Œ ìˆëŠ” ê²½ìš°, AppTypeì€ 'ë¬´'ì§€ë§Œ ë‚´ìš©ì€ ë³µì‚¬ ê°€ëŠ¥í•˜ê²Œ
    if (appType === 'ë¬´') {
        // WhatsAppì´ë‚˜ Viberê°€ ì•„ë‹ˆë”ë¼ë„ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì¼ë‹¨ ETCë¡œ ë³µì‚¬ ê°€ëŠ¥í•˜ê²Œ
        if(rawMsg.length > 2) { appClass = 'logo-none'; appName = 'ETC'; copyValue = rawMsg; }
    } else {
        if (lower.includes('whatsapp')) { appClass = 'logo-wa'; appName = 'WA'; copyValue = rawMsg.replace(/[^0-9]/g, ''); }
        else if (lower.includes('line')) { appClass = 'logo-line'; appName = 'Line'; copyValue = rawMsg.replace(/line[:\s]*/gi, '').trim(); }
        // [ìˆ˜ì • í•­ëª© 5] ì¹´ì¹´ì˜¤í†¡ ID íŒŒì‹± ì •ê·œì‹ ìˆ˜ì •
        else if (lower.includes('kakao') || lower.includes('talk')) { 
            appClass = 'logo-kakao'; 
            appName = 'Ka'; 
            copyValue = rawMsg.replace(/^(kakao|talk|kakao\s*talk)[:\s]*/i, '').trim(); 
        }
        else if (lower.includes('viber')) { appClass = 'logo-viber'; appName = 'Vi'; copyValue = rawMsg; }
        else if (lower.includes('wechat') || lower.includes('weixin')) { appClass = 'logo-wechat'; appName = 'We'; copyValue = rawMsg.replace(/^(wechat|weixin)[:\s]*/i, '').trim(); }
        else if (lower.includes('zalo')) { appClass = 'logo-zalo'; appName = 'Za'; copyValue = rawMsg.replace(/^zalo[:\s]*/i, '').trim(); }
    }
    
    return (copyValue && appName !== 'X') ? `<div class="btn-action ${appClass}" onclick="copyOnly(this, '${copyValue}')">${appName}<br>Copy</div>` : `<div class="btn-action logo-none">X</div>`;
}

function updateMsgStatus(gid, type, checked, memo) {
    let statusData = JSON.parse(localStorage.getItem('bus_msgStatus') || '{}');
    if(!statusData[gid]) statusData[gid] = { contacted: false, connected: false, memo: "" };
    if(type === 'contacted') statusData[gid].contacted = checked;
    if(type === 'connected') statusData[gid].connected = checked;
    if(memo !== null) statusData[gid].memo = memo;
    localStorage.setItem('bus_msgStatus', JSON.stringify(statusData));
}

// =========================================
// [7] ìˆ˜ë™ ì œì–´ ë° ì €ì¥/ë¡œë“œ (LocalStorage)
// =========================================

function manualAddGroup() {
    const rawInput = (document.getElementById('manualGroupNum').value || "").trim();
    if(!rawInput) { alert("ì˜¤ë¹ , ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ì§€?"); return; }
    
    let targetGroup = msgListGroups.find(g => String(g.mainNum) === rawInput || String(g.msgNum) === rawInput);

    if (!targetGroup) {
        if(!confirm(`[${rawInput}ë²ˆ]ì€ ëª…ë‹¨ì— ì—†ì–´. í˜„ì¥ ì†ë‹˜(Walk-in)ìœ¼ë¡œ ì¶”ê°€í• ê¹Œ?`)) return;
        const isSancheoneoMode = msgListGroups.some(g => g.isSancheoneo);
        targetGroup = {
            mainNum: rawInput, msgNum: rawInput, repNum: rawInput, isLong: false, count: 0, 
            name: "Manual Guest", country: "ETC", gender: "N", langContext: "EN",
            appType: "ë¬´", location: "í˜„ì¥", phone: "", messenger: "", note: "Manual", members: [], 
            paxType: 'General', isStay: false, isBoard: false, 
            color: '#e0e0e0', textClass: 'neutral-text', subInfo: 'í˜„ì¥',
            isSancheoneo: isSancheoneoMode, isHot: false, email: "",
            options: { lift: false, gear: false, clothes: false, lesson: false }
        };
        msgListGroups.push(targetGroup);
    }

    targetGroup.count++;
    
    let sequence = generateSeatSequence(1, currentSeatMap1.length - 1);
    let seatedIdx = -1;
    
    // Map 1 ë°°ì¹˜
    for(let i of sequence) {
        if(currentSeatMap1[i] === null) { currentSeatMap1[i] = {...targetGroup}; seatedIdx = i; break; } 
    }

    // Map 2 ë°°ì¹˜
    if(targetGroup.paxType === 'General') {
        if (seatedIdx !== -1 && currentSeatMap2[seatedIdx] === null) {
             let cloned = {...targetGroup}; cloned.color = '#e0e0e0'; cloned.isSynced = true;
             currentSeatMap2[seatedIdx] = cloned;
        } else {
            for(let i of sequence) {
                if(currentSeatMap2[i] === null) { 
                    let cloned = {...targetGroup}; cloned.color = '#e0e0e0'; cloned.isSynced = true;
                    currentSeatMap2[i] = cloned; break; 
                } 
            }
        }
    }
    refreshDisplay();
}

function manualDelGroup() {
    const rawInput = (document.getElementById('manualGroupNum').value || "").trim();
    if(!rawInput) { alert("ì§€ìš¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜."); return; }
    
    let idx = msgListGroups.findIndex(g => String(g.mainNum) === rawInput || String(g.msgNum) === rawInput);
    if(idx === -1) { alert("ê·¸ ë²ˆí˜¸ëŠ” ëª…ë‹¨ì— ì—†ëŠ”ë°?"); return; }
    
    let group = msgListGroups[idx];
    let targetRepNum = group.repNum;

    if (group.count > 0) {
        group.count--; 
        for(let i = currentSeatMap1.length - 1; i >= 1; i--) {
            if(currentSeatMap1[i] && (String(currentSeatMap1[i].mainNum) === rawInput || currentSeatMap1[i].repNum === targetRepNum)) {
                currentSeatMap1[i] = null; break;
            }
        }
        for(let i = currentSeatMap2.length - 1; i >= 1; i--) {
            if(currentSeatMap2[i] && (String(currentSeatMap2[i].mainNum) === rawInput || currentSeatMap2[i].repNum === targetRepNum)) {
                currentSeatMap2[i] = null; break;
            }
        }
    }

    if (group.count <= 0) {
        if(confirm(`[${rawInput}ë²ˆ] ì¸ì›ì´ 0ëª…ì´ì•¼. ëª…ë‹¨ì—ì„œ ì™„ì „íˆ ì‚­ì œí• ê¹Œ?`)) {
            msgListGroups.splice(idx, 1);
            for(let i = 1; i < currentSeatMap1.length; i++) {
                if(currentSeatMap1[i] && (String(currentSeatMap1[i].mainNum) === rawInput || currentSeatMap1[i].repNum === targetRepNum)) currentSeatMap1[i] = null;
            }
            for(let i = 1; i < currentSeatMap2.length; i++) {
                if(currentSeatMap2[i] && (String(currentSeatMap2[i].mainNum) === rawInput || currentSeatMap2[i].repNum === targetRepNum)) currentSeatMap2[i] = null;
            }
        }
    }
    refreshDisplay();
}

// ì €ì¥/ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤
function saveSeatMap() { localStorage.setItem('bus_seatMap', JSON.stringify({ map1: currentSeatMap1, map2: currentSeatMap2, groups: msgListGroups })); }
function checkDateChange() { localStorage.setItem('bus_lastDate', document.getElementById('vcardDate').value); }
function saveTextInput() { localStorage.setItem('bus_rawData', document.getElementById('rawData').value); localStorage.setItem('bus_size', document.querySelector('input[name="busSize"]:checked').value); }
function saveTimeInput() { const times = { h: document.getElementById('timeHongdae').value, m: document.getElementById('timeMyeongdong').value, d: document.getElementById('timeDongdaemun').value }; localStorage.setItem('bus_times', JSON.stringify(times)); }
function saveGuideName() { 
    localStorage.setItem('bus_guideName', document.getElementById('guideNameInput').value);
    localStorage.setItem('bus_number', document.getElementById('busNumberInput').value);
    if(msgListGroups.length > 0) renderMessages(msgListGroups, currentSeatMap1, currentSeatMap2);
}
function saveSpecialNotice() { localStorage.setItem('bus_specialNotice', document.getElementById('specialNotice').value); if(msgListGroups.length > 0) renderMessages(msgListGroups, currentSeatMap1, currentSeatMap2); }

function loadSeatMap() {
    const saved = localStorage.getItem('bus_seatMap');
    if (saved) { 
        try { 
            const data = JSON.parse(saved); 
            if(data.map1 && data.map2) { 
                currentSeatMap1 = data.map1; currentSeatMap2 = data.map2; msgListGroups = data.groups || []; 
                const hasReturn = msgListGroups.some(g => g.paxType === 'D2' || g.paxType === 'D3');
                toggleMap2(hasReturn);
                redrawAll(parseInt(localStorage.getItem('bus_size') || "44")); 
                renderMessages(msgListGroups, currentSeatMap1, currentSeatMap2); 
            } 
        } catch(e) {} 
    }
}
function loadTextInput() { const savedData = localStorage.getItem('bus_rawData'); if(savedData) document.getElementById('rawData').value = savedData; const savedSize = localStorage.getItem('bus_size'); if(savedSize) { const radios = document.getElementsByName('busSize'); for(let r of radios) { if(r.value === savedSize) r.checked = true; } } }
function loadGuideName() { const savedGuide = localStorage.getItem('bus_guideName'); if(savedGuide) document.getElementById('guideNameInput').value = savedGuide; const savedBus = localStorage.getItem('bus_number'); if(savedBus) document.getElementById('busNumberInput').value = savedBus; }
function clearData() { if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { document.getElementById('rawData').value = ''; localStorage.removeItem('bus_rawData'); localStorage.removeItem('bus_seatMap'); localStorage.removeItem('bus_msgStatus'); location.reload(); } }

function updateHeader1(seatMap) {
    let counts = { 'í™ëŒ€':0, 'ëª…ë™':0, 'ë™ëŒ€ë¬¸':0, 'ê¸°íƒ€':0 }; let total = 0;
    for(let i=1; i<seatMap.length; i++) {
        let seat = seatMap[i];
        if(seat) {
            total++; let loc = seat.location || '';
            if(loc.includes('í™ëŒ€')) counts['í™ëŒ€']++;
            else if(loc.includes('ëª…ë™')) counts['ëª…ë™']++;
            else if(loc.includes('ë™ëŒ€ë¬¸')) counts['ë™ëŒ€ë¬¸']++;
            else counts['ê¸°íƒ€']++;
        }
    }
    document.getElementById('pickupSummary1').innerHTML = `TOTAL: ${total}ëª…<br><span style="font-size:0.9rem; color:#ffd700;">[ í™ëŒ€ ${counts['í™ëŒ€']} / ëª…ë™ ${counts['ëª…ë™']} / ë™ëŒ€ë¬¸ ${counts['ë™ëŒ€ë¬¸']} ]</span>`;
}
function updateHeader2(seatMap) {
    let counts = { 'Hotel':0, 'Challenge':0 }; let total = 0;
    for(let i=1; i<seatMap.length; i++) {
        let seat = seatMap[i];
        if(seat) {
            total++; 
            if(seat.paxType === 'D2' || seat.paxType === 'D3') counts['Hotel']++; else counts['Challenge']++; 
        }
    }
    document.getElementById('pickupSummary2').innerHTML = `TOTAL: ${total}ëª…<br><span style="font-size:0.9rem; color:#ffd700;">[ ë³µê·€í¸ ${counts['Challenge']} / ìˆ™ë°•ì†ë‹˜ ${counts['Hotel']} ]</span>`;
}

function updatePriority(checkbox) {
  const val = checkbox.value;
  if(checkbox.checked) { if(!priorityQueue.includes(val)) priorityQueue.push(val); } 
  else { priorityQueue = priorityQueue.filter(v => v !== val); }
  updatePriorityDisplay();
}

function updatePriorityDisplay() {
  const map = { 'solo':'í˜¼ì', 'CN':'ì¤‘êµ­ì–´', 'EN':'ì˜ì–´', 'F':'ì—¬ì', 'M':'ë‚¨ì', 'G4':'4ì¸ì´ìƒ' };
  const txt = priorityQueue.map(v => map[v]).join(' > ');
  document.getElementById('priorityView').innerText = "ìš°ì„ ìˆœìœ„: " + (txt || "ì—†ìŒ");
}

function toggleMap2(hasReturnGuests) {
    const map2Area = document.getElementById('captureArea2');
    const map2Btn = document.querySelector('button[onclick="downloadImage(2)"]');
    if (hasReturnGuests) { map2Area.style.display = 'block'; map2Btn.style.display = 'block'; } 
    else { map2Area.style.display = 'none'; map2Btn.style.display = 'none'; }
}

function downloadImage(num) {
  const capture = document.getElementById('captureArea' + num);
  html2canvas(capture, { scrollY: -window.scrollY }).then(canvas => {
    let link = document.createElement('a'); link.download = `Bus_Map${num}_${document.getElementById('dateDisplay1').innerText}.png`;
    link.href = canvas.toDataURL(); link.click();
  });
}

function downloadVCard() {
    if (!msgListGroups || msgListGroups.length === 0) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°°ì¹˜ ì‹¤í–‰ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”."); return; }
    
    let vcardContent = ""; 
    const dateCode = document.getElementById('vcardDate').value; 
    let count = 0;
    
    // [ì¤‘ë³µ ë°©ì§€ í•µì‹¬ ë¡œì§] 
    // Setì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ ì¶”ê°€ëœ ì „í™”ë²ˆí˜¸ëŠ” ê±´ë„ˆëœ€
    let processedPhones = new Set();

    msgListGroups.forEach(g => {
        let phoneStr = g.phone;
        // 1. ë²ˆí˜¸ê°€ ë„ˆë¬´ ì§§ìœ¼ë©´ íŒ¨ìŠ¤
        if (!phoneStr || phoneStr.length < 5) return;
        
        // 2. ì´ë¯¸ ì²˜ë¦¬ëœ ë²ˆí˜¸ë¼ë©´ íŒ¨ìŠ¤ (ì¤‘ë³µ ìƒì„± ë°©ì§€)
        if (processedPhones.has(phoneStr)) return; 
        
        // ì²˜ë¦¬ëœ ë²ˆí˜¸ë¡œ ë“±ë¡
        processedPhones.add(phoneStr);
        
        let locChar = 'ê¸°'; 
        if (g.location.includes('í™ëŒ€')) locChar = 'í™';
        else if (g.location.includes('ëª…ë™')) locChar = 'ëª…';
        else if (g.location.includes('ë™ëŒ€ë¬¸')) locChar = 'ë™';
        
        let finalName = `${dateCode}(${g.mainNum}${locChar})`;
        
        vcardContent += "BEGIN:VCARD\nVERSION:3.0\n";
        vcardContent += `FN:${finalName}\n`;
        vcardContent += `TEL;TYPE=CELL:+${phoneStr}\n`;
        vcardContent += `NOTE:Orig:${g.name} / ${g.count}pax\n`;
        vcardContent += "END:VCARD\n";
        count++;
    });
    
    if(count === 0) { alert("ì €ì¥í•  ìœ íš¨í•œ ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
    
    const blob = new Blob([vcardContent], { type: "text/vcard" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = `Contacts_${dateCode}.vcf`;
    link.href = url; link.click(); URL.revokeObjectURL(url);
}

// ì•ˆì „ì¥ì¹˜ (ì•„ì´í°/ëª¨ë°”ì¼ ë°ì´í„° ë³´í˜¸)
function forceSaveAllData() {
    try {
        saveTextInput(); saveGuideName(); saveTimeInput(); checkDateChange();
        localStorage.setItem('bus_specialNotice', document.getElementById('specialNotice').value);
    } catch (e) { console.log("Safe Save:", e); }
}

// =========================================
// [8] ì´ˆê¸°í™”
// =========================================
window.onload = function() {
    loadTextInput(); loadGuideName(); 
    document.getElementById('specialNotice').value = localStorage.getItem('bus_specialNotice') || "";

    const today = new Date(); today.setDate(today.getDate() + 1);
    const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    const dateStr = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')} (${days[today.getDay()]})`;
    document.getElementById('dateDisplay1').innerText = dateStr;
    document.getElementById('dateDisplay2').innerText = dateStr;
    const yymmdd = String(today.getFullYear()).slice(2) + String(today.getMonth()+1).padStart(2,'0') + String(today.getDate()).padStart(2,'0');
    document.getElementById('vcardDate').value = yymmdd;
    const savedTimes = JSON.parse(localStorage.getItem('bus_times') || '{}');
    if(savedTimes.h) document.getElementById('timeHongdae').value = savedTimes.h;
    if(savedTimes.m) document.getElementById('timeMyeongdong').value = savedTimes.m;
    if(savedTimes.d) document.getElementById('timeDongdaemun').value = savedTimes.d;
    loadSeatMap();
};

document.addEventListener('visibilitychange', function() { if (document.visibilityState === 'hidden') forceSaveAllData(); });
window.addEventListener('pagehide', function() { forceSaveAllData(); });
document.querySelectorAll('input, textarea').forEach(el => { el.addEventListener('blur', forceSaveAllData); });
</script>
</body>
</html>
