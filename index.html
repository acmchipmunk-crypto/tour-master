<!DOCTYPE html>

<html lang="ko">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<title>ë¯¸ìŠ¤í„° ì‹ ì˜ íˆ¬ì–´ë§ˆìŠ¤í„° 10.8 (Gender Free + FIT Mode)</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

  /* --- [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] --- */

  body, input, button, textarea, select { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; -webkit-user-select:none; }

  body { background: #f0f2f5; margin: 0; padding: 5px; max-width: 100vw; overflow-x: hidden; }

  

  .main-title { 

      text-align: center; 

      font-size: 22px; 

      font-weight: 900; 

      color: #ffffff; 

      background: linear-gradient(135deg, #3f51b5, #1a237e);

      margin: 10px 0 15px 0; 

      padding: 12px;

      border-radius: 10px;

      box-shadow: 0 4px 8px rgba(0,0,0,0.2);

      letter-spacing: 1px;

      text-transform: uppercase;

      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);

  }



  /* ... (ê¸°ì¡´ CSS ìƒëµ ì—†ì´ ì›ë³¸ ìœ ì§€) ... */

  .info-text { font-size: 12px; color: #546e7a; margin: 0 0 8px 0; font-weight: 600; display: block; background: #eceff1; padding: 4px 8px; border-radius: 4px; border-left: 3px solid #b0bec5; }

  .info-text.center { text-align: center; border-left: none; background: transparent; }

  

  .guide-panel { background: #fff3e0; padding: 10px; border-radius: 12px; margin-bottom: 10px; text-align: center; border: 2px solid #ffe0b2; display: flex; justify-content: space-around; gap: 5px; }

  .guide-input-group { display: flex; flex-direction: column; align-items: center; }

  .guide-input { font-size: 16px; font-weight: 900; color: #e65100; border: none; border-bottom: 2px solid #e65100; background: transparent; text-align: center; width: 120px; outline: none; }

  

  .input-box { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; box-sizing: border-box; width: 100%; }

  

  .manual-control-panel { display: flex; gap: 5px; background: #e8eaf6; padding: 10px; border-radius: 8px; margin-bottom: 10px; align-items: center; border: 1px solid #c5cae9; width: 100%; box-sizing: border-box; }

  .manual-input { flex: 1; padding: 12px; font-size: 16px; font-weight: bold; text-align: center; border: 2px solid #3f51b5; border-radius: 6px; color: #333; outline: none; min-width: 0; }

  .btn-manual { width: 50px; height: 45px; font-size: 20px; font-weight: 900; border: none; border-radius: 6px; cursor: pointer; color: white; flex-shrink: 0; }

  .btn-add { background: #3f51b5; }

  .btn-del { background: #f44336; }



  textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 12px; box-sizing: border-box; }

  

  .time-setting-panel { background: #e3f2fd; padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; gap: 5px; justify-content: space-between; align-items: center; }

  .time-input-group { display: flex; flex-direction: column; flex: 1; }

  .time-input-group label { font-size: 10px; font-weight: bold; color: #1565c0; margin-bottom: 2px; text-align: center; }

  .time-input-group input { text-align: center; border: 1px solid #90caf9; border-radius: 4px; padding: 4px; font-weight: bold; color: #333; width: 100%; box-sizing: border-box; }

  

  .control-panel { margin-top: 8px; border-top: 1px dashed #ddd; padding-top: 8px; }

  .chk-label { background: #f1f3f5; border: 1px solid #d1d1d1; border-radius: 4px; padding: 6px 9px; font-size: 11px; font-weight: 800; cursor: pointer; color: #333; display: flex; align-items: center; }

  .chk-label input { margin-right: 4px; }

  .chk-label:has(input:checked) { background: #007bff; border-color: #0056b3; color: white; }

  

  .priority-display { font-size: 12px; color: #0056b3; font-weight: bold; margin: 5px 0; padding: 5px; background: #fff; border-radius: 4px; min-height: 15px; border: 1px solid #eee; }

  .size-selector { display: flex; gap: 10px; margin-bottom: 5px; font-size: 12px; font-weight: bold; justify-content: center; background: #eee; padding: 5px; border-radius: 8px;}

  .control-group { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 5px; }

  

  /* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */

  .action-box { background: #e0f2f1; padding: 10px; border-radius: 12px; border: 1px solid #b2dfdb; display: flex; flex-direction: column; gap: 8px; }

  .action-row { display: flex; gap: 5px; align-items: center; }

  

  button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; transition: transform 0.1s; }

  button:active { transform: scale(0.98); }



  .btn-vcard { background: #009688; color: white; flex: 1.5; font-size: 13px; }

  .btn-run { background: #4e54c8; color: white; flex: 2; font-size: 15px; box-shadow: 0 2px 5px rgba(78, 84, 200, 0.3); }

  .btn-clear { background: #ef5350; color: white; flex: 0.8; font-size: 13px; } 

  .vcard-input { width: 70px; padding: 10px; text-align: center; border: 1px solid #00897b; border-radius: 6px; font-weight: bold; color: #00695c; font-size: 13px; }



  .btn-save-mini { background: #11998e; color: white; padding: 6px 14px; font-size: 12px; border-radius: 15px; border: 1px solid white; cursor: pointer; text-decoration: none; display: inline-block; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  .btn-save-mini.night { background: #e91e63; }

  

  .capture-wrapper { margin-bottom: 30px; border: 5px solid #eee; position: relative; }

  #captureArea1, #captureArea2 { background: white; padding: 15px 5px; border-radius: 0; width: 100%; max-width: 500px; margin: 0 auto; box-sizing: border-box; }

  

  .bus-header { text-align: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #333; position: relative; }

  

  .pickup-summary { 

      background: #2c3e50; 

      color: white; 

      padding: 10px; 

      border-radius: 6px; 

      font-size: 1.2rem; 

      font-weight: 900; 

      margin-bottom: 5px; 

      letter-spacing: -0.5px; 

      box-shadow: 0 2px 4px rgba(0,0,0,0.2); 

      display: flex; 

      align-items: center; 

      justify-content: space-between;

      gap: 10px;

  }

  

  .header-controls { position: static; transform: none; display: flex; align-items: center; }



  .bus-date { font-size: 1.0rem; color: #555; margin-top: 6px; font-weight: 800; }

  .bus-title-label { background: #333; color: #fff; display:inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 5px; font-weight: bold; }

  

  .bus-grid { display: grid; grid-template-columns: 1fr 1fr 0.2fr 1fr 1fr; grid-auto-rows: 1fr; gap: 4px; width: 100%; }

  .last-row-45 { grid-column: 1 / -1; display: flex; justify-content: space-between; gap: 4px; height: 100%; }

  .last-row-45 .seat { flex: 1; width: auto; }

  

  .seat { aspect-ratio: 1.1 / 1; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; position: relative; cursor: pointer; box-shadow: 1px 2px 3px rgba(0,0,0,0.1); padding: 3px; height: 100%; box-sizing: border-box; background: white; justify-content: center; align-items: center; }

  .seat.empty { background: white; opacity: 1; border: 2px dashed #ddd; } 

  .seat.reserved { background: #bbb; color: white; opacity: 0.5; pointer-events: none; border:none; } 

  .seat.emergency { border: 2px dashed #ff9800; background-color: #fff8e1; } 

  .seat.selected { border: 3px solid #ff0000; transform: scale(1.05); z-index: 20; box-shadow: 0 0 10px rgba(255,0,0,0.5); }

  .seat.synced-general { background-color: #e0e0e0 !important; border: 1px solid #bdbdbd; opacity: 0.8; }

  

  .seat-num { position: absolute; top: 2px; left: 4px; font-size: 11px; font-weight: bold; color: rgba(0,0,0,0.4); z-index: 2; }

  .grp-id { font-size: 24px; font-weight: 900; color: #333; line-height: 1; margin-bottom: 4px; margin-top: 8px; text-align: center; }

  .grp-id.long-text { font-size: 20px; letter-spacing: -1px; }

  .info-badge { background: rgba(255,255,255,0.85); border-radius: 12px; padding: 3px 6px; text-align: center; font-size: 11px; font-weight: 900; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: 95%; margin-top: auto; margin-bottom: 2px; white-space: nowrap; }

  

  .neutral-text { color: #555; } 

  .day-tag { color: white; padding: 1px 4px; border-radius: 4px; margin-right: 3px; font-size: 10px; vertical-align: middle; }

  .tag-d1 { background-color: #1976d2; } .tag-d2 { background-color: #d32f2f; } .tag-d3 { background-color: #7b1fa2; } .tag-stay { background-color: #ff9800; }

/* ìˆ˜ì • ì½”ë“œ */
.tag-hot { background-color: #ff3d00; border: 1px solid white; font-weight:900; color: black; }
.tag-moving { background-color: #fbc02d; border: 1px solid white; font-weight:900; color: black; }
.tag-shuttle { background-color: #8e8ebf; border: 1px solid white; font-weight:900; color: black; }




  .status { font-size: 11px; color: #666; text-align: right; margin-top: 5px; }



  .msg-section { margin-top: 20px; border-top: 2px solid #333; padding-top: 10px; }

  .msg-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

  .msg-check-area { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 8px; width: 45px; gap: 8px; }

  .check-box-wrapper { display: flex; flex-direction: column; align-items: center; }

  .msg-check-label { font-size: 10px; font-weight: 800; color: #555; margin-bottom: 2px; text-align: center; white-space: nowrap; }

  .label-sent { color: #1976d2; } .label-connected { color: #d32f2f; }

  .msg-check-input { transform: scale(1.5); margin: 0; cursor: pointer; }

  .chk-sent { accent-color: #2196f3; } .chk-conn { accent-color: #f44336; } 

  .msg-info { flex: 1; margin-right: 5px; min-width: 0; }

  .msg-group-row { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; }

    .msg-group { 
      font-size: 18px; 
      font-weight: 900; 
      padding: 2px 8px; 
      border-radius: 6px; 
      display: inline-block; 
      margin-right: 5px;
  }


  .msg-seats { font-size: 14px; font-weight: bold; color: #d32f2f; margin-top: 4px; }

  .msg-memo-input { width: 100%; margin-top: 5px; border: none; border-bottom: 1px solid #ccc; font-size: 12px; padding: 5px 2px; background: #fafafa; }

  .option-card-wrapper {
    display: flex;
    gap: 4px;
    margin-top: 10px;
    width: 100%;
    grid-column: 1 / -1;
  }
  .opt-card {
    flex: 1;
    padding: 6px 2px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 900;
    text-align: center;
    color: #333;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 28px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .opt-boarded {
    flex: 2;
    font-weight: 900;
    color: #333;
  }

  .msg-card {
    flex-wrap: wrap;
  }

  .opt-card.off {
    background-color: #eeeeee !important;
    color: #bdbdbd !important;
    border-color: #e0e0e0 !important;
    box-shadow: none;
  }
  .opt-chair { background-color: #ffcdd2; border-bottom: 3px solid #ef9a9a; }
  .opt-moving { background-color: #fff9c4; border-bottom: 3px solid #fff176; }
  .opt-sight { background-color: #c8e6c9; border-bottom: 3px solid #a5d6a7; }
  .opt-sled { background-color: #bbdefb; border-bottom: 3px solid #90caf9; }


  .lang-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; font-weight: bold; }


  .lang-CN { background: #fce4ec; color: #c2185b; }

  .lang-EN { background: #e3f2fd; color: #1565c0; }

  .msg-actions { display: flex; gap: 5px; align-items: center; }

  .btn-action { width: 45px; height: 45px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; text-align: center; line-height: 1.2; transition: transform 0.1s; }

  .btn-action:active { transform: scale(0.95); }

  .btn-wa-send { background: #25D366; color: white; }

  .btn-wa-send.disabled { background: #ccc; pointer-events: none; }

  .btn-copy-body { background: #607d8b; color: white; }

  .btn-copy-mail { background: #4fc3f7; color: white; }

  

  .logo-wa { background: #25D366; color: white; } .logo-line { background: white; border: 2px solid #06C755; color: #06C755; box-sizing: border-box; } .logo-kakao { background: #FEE500; color: #3c1e1e; }

  .logo-viber { background: #7360f2; color: white; } .logo-wechat { background: #000000; color: #07C160; border: 1px solid #07C160; } .logo-zalo { background: #0068FF; color: white; } .logo-none { background: #e0e0e0; color: #999; cursor: default; }

  .hidden-msg { display: none; white-space: pre-wrap; }



  /* ì„¤ëª…ì„œ ìŠ¤íƒ€ì¼ */

  .manual-section { background: white; padding: 15px; border-radius: 12px; margin-top: 30px; border: 2px solid #cfd8dc; }

  .manual-title { font-size: 16px; font-weight: 900; color: #455a64; margin-bottom: 10px; border-bottom: 2px solid #cfd8dc; padding-bottom: 5px; }

  .manual-list { padding-left: 20px; font-size: 13px; color: #37474f; line-height: 1.6; }

  .manual-list li { margin-bottom: 6px; }

  .manual-list span { font-weight: bold; color: #00695c; }

  

  /* ì ê¸ˆ í™”ë©´ ìŠ¤íƒ€ì¼ */

  #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #263238; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }

  #lockInput { font-size: 24px; padding: 10px; text-align: center; border-radius: 8px; border: none; margin-bottom: 20px; width: 200px; font-weight: bold; letter-spacing: 5px; }

  #lockBtn { padding: 10px 30px; font-size: 18px; font-weight: bold; background: #009688; border: none; border-radius: 8px; color: white; cursor: pointer; }





  /* [NEW] ê¸°ì› ë°°ì§€ ìŠ¤íƒ€ì¼ (ìµœì¢…) */

  .origin-badge {

      display: inline-block;

      width: 15px; height: 15px;

      line-height: 15px;

      border-radius: 50%;

      text-align: center;

      font-size: 9px;

      font-weight: 900;

      color: white;

      margin-left: 3px;

      vertical-align: text-bottom;

      box-shadow: 1px 1px 1px rgba(0,0,0,0.2);

      border: 1px solid rgba(255,255,255,0.3);

  }



  /* íšŒì‚¬ë³„ ìƒ‰ìƒ ë° ê¸€ììƒ‰ */

  .badge-klook { background: #FF5722; } /* í´ë£©: ì£¼í™© */

  .badge-kkday { background: #29B6F6; } /* ì¼€ì´ì¼€ì´: í•˜ëŠ˜ */

  .badge-trip  { background: #0d47a1; color: #FFEB3B; } /* íŠ¸ë¦½: ì§„í•œíŒŒë‘+ë…¸ë‘T */

  .badge-gyg   { background: #000000; } /* GYG: ê²€ì • */

  .badge-qike  { background: #00E676; } /* ì¹˜ì»¤: ë°ì€ì´ˆë¡ */

  .badge-trazy { background: #FF4081; } /* íŠ¸ë ˆì´ì§€: ë¶„í™ */

  .badge-etc   { background: #78909C; } /* ë¯¸ë¶„ë¥˜/í˜„ì¥: íšŒìƒ‰ */

  

  /* í•˜ë‹¨ ë°°ì§€ ì„¤ëª… ì˜ì—­ ìŠ¤íƒ€ì¼ */

  .badge-legend {

      background: white; border: 2px solid #cfd8dc; border-radius: 12px;

      padding: 10px; margin-top: 10px; text-align: center; font-size: 11px;

      color: #455a64; font-weight: bold; line-height: 2.0;

  }



</style>

</head>

<body>



<div id="lockScreen" style="display:none;">

    <h2 style="margin-bottom:20px;">ğŸ”’ ACCESS LOCKED</h2>

    <input type="password" id="lockInput" placeholder="Password" maxlength="6" inputmode="numeric">

    <button id="lockBtn" onclick="unlock()">ENTER</button>

</div>



<style>
  /* v11 Slim UI ë¯¸ì„¸ ì¡°ì • ìŠ¤íƒ€ì¼ */
  .v11-card { background: white; padding: 4px 12px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 4px; border: 1px solid #e0e4e8; }
  .v11-title { 
      text-align: center; font-size: 20px; font-weight: 900; color: #333; 
      background: linear-gradient(135deg, #ffd600, #ffab00); padding: 8px; 
      border-radius: 10px; margin: 5px 0 8px 0; box-shadow: 0 2px 8px rgba(255,171,0,0.3);
      text-shadow: 1px 1px 1px rgba(255,255,255,0.8); border: 2px solid #fff;
  }
  /* ì œëª© ì•½ 50% í™•ëŒ€ (12px -> 18px), ì„¤ëª… ì•½ 30% í™•ëŒ€ (10px -> 13px) */
  .v11-section-label { font-size: 18px; font-weight: 800; color: #1a237e; display: block; margin-bottom: 0px; letter-spacing: -0.5px; }
  .v11-section-desc { font-size: 13px; color: #555; margin-bottom: 4px; line-height: 1.1; font-weight: 500; }
  
  .v11-btn-group { display: flex; gap: 4px; width: 100%; }
  
  /* ëª¨ë“  ì…ë ¥ì°½ ë° ë²„íŠ¼ ë†’ì´ 38pxë¡œ í†µì¼ */
  .v11-ui-element { height: 38px !important; border-radius: 6px !important; font-size: 14px !important; box-sizing: border-box !important; }
  
  .guide-panel { padding: 2px !important; margin-bottom: 0 !important; border-radius: 8px; }
  .time-setting-panel { padding: 2px !important; margin-bottom: 0 !important; gap: 4px !important; }
  
  textarea { padding: 4px !important; border-radius: 6px !important; background-color: #fcfcfc; border: 1px solid #ccc !important; }
  /* 3ë²ˆ ë°ì´í„° ì…ë ¥ì°½ì€ ë‚´ìš© í™•ì¸ì„ ìœ„í•´ ìµœì†Œ ë†’ì´ ìœ ì§€ */
  #rawData { height: 50px !important; }
  /* 8ë²ˆ ëª…ë‹¨ ì¶”ê°€ì°½ì€ ìš”ì²­ì— ë”°ë¼ ë†’ì´ í†µì¼ */
  #manualBatchData { height: 38px !important; flex: 1; }
  
  .v11-manual-box { background: #f0f2f5; border: 1px dashed #3f51b5; padding: 4px; border-radius: 4px; margin-top: 4px; }
  
  input[type="text"], button { border: 1px solid #ccc; }
  button { cursor: pointer; font-weight: bold !important; display: flex; align-items: center; justify-content: center; }
  
  .manual-input { background-color: #fcfcfc; }
  .chk-label { padding: 3px 6px !important; font-size: 11px !important; }
  .priority-display { padding: 2px 4px !important; margin: 2px 0 !important; }
</style>

<div class="v11-title">ğŸ“± ë¯¸ìŠ¤í„° ì‹ ì˜ íˆ¬ì–´ë§ˆìŠ¤í„° v11</div>

<div class="v11-card">
  <span class="v11-section-label">1. ê¸°ë³¸ ì •ë³´</span>
  <p class="v11-section-desc">ê°€ì´ë“œì™€ ë²„ìŠ¤ ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>
  <div class="guide-panel">
      <div class="guide-input-group">
          <label style="font-weight:bold; font-size:10px; color:#ef6c00;">ê°€ì´ë“œ</label>
          <input type="text" id="guideNameInput" class="guide-input v11-ui-element" value="Mr. Shin" oninput="saveGuideName()">
      </div>
      <div class="guide-input-group">
          <label style="font-weight:bold; font-size:10px; color:#0277bd;">ë²„ìŠ¤</label>
          <input type="text" id="busNumberInput" class="guide-input v11-ui-element" value="4044" oninput="saveGuideName()">
      </div>
  </div>
</div>

<div class="v11-card">
  <span class="v11-section-label">2. ì¶œë°œ ì‹œê°„ ì„¤ì •</span>
  <p class="v11-section-desc">í”½ì—… ì‹œê°„ì€ ë©”ì‹œì§€ì— ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</p>
  <div class="time-setting-panel">
    <div class="time-input-group"><label>í™ëŒ€</label><input type="text" id="timeHongdae" class="v11-ui-element" style="width:100%;" value="06:40" onchange="saveTimeInput()"></div>
    <div class="time-input-group"><label>ëª…ë™</label><input type="text" id="timeMyeongdong" class="v11-ui-element" style="width:100%;" value="07:10" onchange="saveTimeInput()"></div>
    <div class="time-input-group"><label>ë™ëŒ€ë¬¸</label><input type="text" id="timeDongdaemun" class="v11-ui-element" style="width:100%;" value="07:20" onchange="saveTimeInput()"></div>
  </div>
</div>

<div class="v11-card">
  <span class="v11-section-label">3. ë°ì´í„° ì…ë ¥</span>
  <p class="v11-section-desc">ëª…ë‹¨ ì „ì²´ë¥¼ ë³µì‚¬í•´ì„œ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
  <textarea id="rawData" placeholder="ì—¬ê¸°ì— ëª…ë‹¨ ë°ì´í„° ë¶™ì—¬ë„£ê¸°..." oninput="saveTextInput()"></textarea>
  <div class="size-selector" style="margin-top:2px; font-size: 11px; padding: 2px;">
    <label><input type="radio" name="busSize" value="44" checked onchange="saveTextInput()"> 44ì¸ìŠ¹</label>
    <label><input type="radio" name="busSize" value="45" onchange="saveTextInput()"> 45ì¸ìŠ¹</label>
    <label><input type="radio" name="busSize" value="FIT" onchange="saveTextInput()"> FIT(ìë™)</label>
  </div>
</div>

<div class="v11-card">
  <span class="v11-section-label">4. ë°°ì¹˜ ìš°ì„ ìˆœìœ„</span>
  <p class="v11-section-desc">ì¢Œì„ ë°°ì¹˜ ê¸°ì¤€ì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
  <div class="control-panel" style="margin-top:0; border-top:none; padding-top:0;">
    <div class="priority-display" id="priorityView" style="font-size: 11px; min-height: 12px;">ìš°ì„ ìˆœìœ„: ì—†ìŒ</div>
    <div class="control-group" style="gap: 2px;">
      <label class="chk-label"><input type="checkbox" class="criteria" value="solo" onchange="updatePriority(this)"> í˜¼ì</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="CN" onchange="updatePriority(this)"> ì¤‘ì–´</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="EN" onchange="updatePriority(this)"> ì˜ì–´</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="G4" onchange="updatePriority(this)"> 4ì¸â†‘</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="HD" onchange="updatePriority(this)"> í™ëŒ€</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="MY" onchange="updatePriority(this)"> ëª…ë™</label>
      <label class="chk-label"><input type="checkbox" class="criteria" value="DDM" onchange="updatePriority(this)"> ë™ëŒ€</label>
    </div>
    <div class="size-selector" style="background:#eef; margin-top:2px; padding: 2px; font-size: 10px;">
      <label><input type="radio" name="direction" value="front" checked> ì•ìª½</label>
      <label><input type="radio" name="direction" value="back"> ë’¤ìª½</label>
    </div>
  </div>
</div>

<div class="v11-card" style="background: #e8eaf6; border: 1px solid #3f51b5;">
  <span class="v11-section-label">5. ìë™ ë°°ì¹˜ ì‹¤í–‰</span>
  <p class="v11-section-desc">ì„ íƒí•œ ì¡°ê±´ìœ¼ë¡œ ì¢Œì„ì„ ìë™ ë°°ì¹˜í•©ë‹ˆë‹¤.</p>
  <div class="v11-btn-group">
      <button class="btn-clear v11-ui-element" style="flex:1;" onclick="clearData()">ğŸ—‘ ì´ˆê¸°í™”</button>
      <button class="btn-run v11-ui-element" style="background: #3f51b5; color: white; border:none; flex:3;" onclick="runAI()">ğŸ¤– ìë™ ë°°ì¹˜ ì‹¤í–‰ (Run)</button>
  </div>
  <div class="status" id="paxInfo" style="text-align:center; font-weight: 800; margin-top:2px; font-size: 10px; color:#1a237e;">ì¤€ë¹„ë¨</div>
</div>

<div class="v11-card">
  <span class="v11-section-label">6. ì—°ë½ì²˜ ì €ì¥</span>
  <p class="v11-section-desc">ì†ë‹˜ ì—°ë½ì²˜ë¥¼ íœ´ëŒ€í°ì— ì €ì¥í•©ë‹ˆë‹¤.</p>
  <div class="v11-btn-group">
      <input type="text" id="vcardDate" class="v11-ui-element" style="width:80px;" placeholder="YYMMDD" onchange="checkDateChange()">
      <button class="btn-vcard v11-ui-element" style="flex:1; border:none;" onclick="downloadVCard()">ğŸ“ ì—°ë½ì²˜ ì €ì¥(.vcf)</button>
  </div>
</div>

<div class="v11-card">
  <span class="v11-section-label">7. í˜„ì¥ ì¶”ê°€</span>
  <p class="v11-section-desc">ë°°ì¹˜ í›„ ì¢Œì„ì„ ê°œë³„ë¡œ ì¶”ê°€Â·ì¡°ì •í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
  <div class="v11-btn-group">
      <input type="text" id="manualGroupNum" class="manual-input v11-ui-element" style="flex:1;" placeholder="No. or Name">
      <button class="btn-manual btn-add v11-ui-element" style="width:45px; border:none;" onclick="manualAddGroup()">+</button>
      <button class="btn-manual btn-del v11-ui-element" style="width:45px; background:#f44336; border:none;" onclick="manualDelGroup()">-</button>
  </div>
</div>

<div class="v11-card">
  <span class="v11-section-label">8. ëª…ë‹¨ ì¶”ê°€</span>
  <p class="v11-section-desc">ì¶”ê°€ëœ ëª…ë‹¨ë§Œ ë³µì‚¬ í•´ì„œ ì…ë ¥ í•˜ì„¸ìš”</p>
  <div class="v11-btn-group">
      <textarea id="manualBatchData" placeholder="ì—¬ëŸ¬ ì¤„ ëª…ë‹¨ ë¶™ì—¬ë„£ê¸°..."></textarea>
      <button class="btn-manual btn-add v11-ui-element" style="width: 70px; border:none; font-size: 12px !important;" onclick="manualBatchAdd()">ëª…ë‹¨ì¶”ê°€</button>
  </div>
  <div class="v11-manual-box">
      <div style="font-size: 10px; color: #1a237e; font-weight: 700; text-align:center;">
          ğŸ’¡ ê¸°ì¡´ ì¢Œì„ ìœ ì§€ / ë¹ˆ ìë¦¬ì— ìˆœì°¨ ë°°ì¹˜
      </div>
  </div>
</div>







<div class="v11-card">
  <span class="v11-section-label">9. ì¢Œì„ë°°ì¹˜í‘œ ì •ë¦¬ ì´ë¯¸ì§€ ì €ì¥</span>
  <p class="v11-section-desc">ì¢Œì„ ë°°ì¹˜ ê²°ê³¼ë¥¼ íƒ­í•˜ì—¬ ì •ë¦¬í•˜ê³  ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤</p>
</div>

<div class="capture-wrapper">
  <div id="captureArea1">
    <div class="bus-header">
      <div class="bus-title-label">â˜€ï¸ Map 1 (Seoul â†’ Dest)</div>
      <div class="pickup-summary" id="pickupSummary1">
          ì¤€ë¹„ì¤‘...
          <div class="header-controls" data-html2canvas-ignore="true">
             <button class="btn-save-mini" onclick="downloadImage(1)">ğŸ“¸ ì €ì¥</button>
          </div>
      </div>
      <div class="bus-date" id="dateDisplay1">2026-00-00</div>
    </div>
    <div class="bus-grid" id="busGrid1"></div>
  </div>
</div>

<div class="capture-wrapper">
  <div id="captureArea2">
    <div class="bus-header">
      <div class="bus-title-label">ğŸŒ™ Map 2 (Dest â†’ Seoul)</div>
      <div class="pickup-summary" id="pickupSummary2">
          ì¤€ë¹„ì¤‘...
          <div class="header-controls" data-html2canvas-ignore="true">
            <button class="btn-save-mini night" onclick="downloadImage(2)">ğŸ“¸ ì €ì¥</button>
          </div>
      </div>
      <div class="bus-date" id="dateDisplay2">2026-00-00</div>
    </div>
    <div class="bus-grid" id="busGrid2"></div>
  </div>
</div>

<div class="v11-card" style="background: #fff9c4; border: 1px solid #fbc02d;">
  <span class="v11-section-label">10. ê°€ì´ë“œ ê°œì¸ê³µì§€</span>
  <p class="v11-section-desc">ê°€ì´ë“œ ê°œì¸ì´ ì¶”ê°€ í•˜ê³  ì‹¶ì€ ë©”ì„¸ì§€ì„ ì…ë ¥í•©ë‹ˆë‹¤</p>
  <textarea id="specialNotice" style="height: 100px; margin-top:5px; border-color:#fbc02d;" placeholder="ì˜ˆ: ë¹„ê°€ ì˜¤ë‹ˆ ìš°ì‚°ì„ ì±™ê¸°ì„¸ìš”. (ì´ ë‚´ìš©ì€ ì „ì†¡ ë©”ì‹œì§€ ì¤‘ê°„ì— ì‚½ì…ë©ë‹ˆë‹¤)" oninput="saveSpecialNotice()"></textarea>
</div>

<div class="msg-section" id="msgSection" style="display:none;">
    <div class="v11-card">
      <span class="v11-section-label">11. ë©”ì‹œì§€ ë°œì†¡ & ì²´í¬</span>
      <p class="v11-section-desc">ì†ë‹˜ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ì²´í¬í•©ë‹ˆë‹¤.</p>
    </div>
    <div id="msgList"></div>
</div>


    <div class="info-text" style="margin-bottom:15px; text-align:center;">Send ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ WhatsAppì´ ì—´ë¦½ë‹ˆë‹¤.</div>

    <div id="msgList"></div>

</div>

<textarea id="clipboardHelper" style="position:absolute; left:-9999px; top:auto; width:1px; height:1px; opacity:0; pointer-events:none;"></textarea>

<div class="badge-legend">

  <div class="legend-title">ğŸš© ì˜ˆì•½ì²˜ë³„ í›„ê¸° ì‘ì„± ê°€ì´ë“œ (ê°€ì´ë“œìš©)</div>

  <!-- Klook -->
  <div style="margin-bottom:12px;">
    <div>
      <span class="origin-badge badge-klook">K</span>
      <b>Klook</b> Â· <b style="color:#2e7d32;">ë‹¹ì¼ ê°€ëŠ¥</b>
    </div>
    <div style="font-size:12px; margin-top:4px;">
      íˆ¬ì–´ê°€ â€˜ì‚¬ìš© ì™„ë£Œâ€™ ì²˜ë¦¬ë˜ë©´ ë‹¹ì¼ í›„ê¸° ì‘ì„± ê°€ëŠ¥,  
      ë³µê·€ ë²„ìŠ¤ë‚˜ í•˜ì°¨ ì§ì „ì— ë°”ë¡œ ìš”ì²­í•˜ëŠ” ê²ƒì´ ê°€ì¥ íš¨ê³¼ì 
    </div>
  </div>

  <!-- KKday -->
  <div style="margin-bottom:12px;">
    <div>
      <span class="origin-badge badge-kkday">K</span>
      <b>KKday</b> Â· <b style="color:#d32f2f;">ë‹¤ìŒ ë‚  ê°€ëŠ¥</b>
    </div>
    <div style="font-size:12px; margin-top:4px;">
      íˆ¬ì–´ ì¢…ë£Œ ë‹¤ìŒ ë‚ ë¶€í„° í›„ê¸° í™œì„±í™”,  
      ë‹¹ì¼ í˜„ì¥ ìš”ì²­ë³´ë‹¤ëŠ” ë‹¤ìŒ ë‚  ë©”ì‹œì§€ ìš”ì²­ì´ ì•ˆì •ì 
    </div>
  </div>

  <!-- Trip.com -->
  <div style="margin-bottom:12px;">
    <div>
      <span class="origin-badge badge-trip">T</span>
      <b>Trip.com</b> Â· <b style="color:#f9a825;">ìƒí’ˆë³„ ìƒì´</b>
    </div>
    <div style="font-size:12px; margin-top:4px;">
      ì¼ë¶€ ìƒí’ˆì€ ë‹¹ì¼ ê°€ëŠ¥í•˜ë‚˜ ë‹¤ìˆ˜ëŠ” ì¢…ë£Œ í›„ ì¼ì • ì‹œê°„ í•„ìš”,  
      ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ í›„ ìš”ì²­ ê¶Œì¥
    </div>
  </div>

  <!-- GetYourGuide -->
  <div style="margin-bottom:12px;">
    <div>
      <span class="origin-badge badge-gyg">G</span>
      <b>GetYourGuide</b> Â· <b style="color:#2e7d32;">ë‹¹ì¼ ê°€ëŠ¥</b>
    </div>
    <div style="font-size:12px; margin-top:4px;">
      íˆ¬ì–´ ì¢…ë£Œ í›„ ëª‡ ì‹œê°„ ë‚´ ì´ë©”ì¼ë¡œ í›„ê¸° ë§í¬ ë°œì†¡,  
      ë‹¹ì¼ ì €ë… â€œì´ë©”ì¼ í™•ì¸â€ ì•ˆë‚´ ì‹œ ì‘ì„±ë¥  ë†’ìŒ
    </div>
  </div>

  <!-- Qike -->
  <div style="margin-bottom:12px;">
    <div>
      <span class="origin-badge badge-qike">Q</span>
      <b>Qike</b> Â· <b style="color:#f9a825;">ìƒí’ˆë³„ ìƒì´</b>
    </div>
    <div style="font-size:12px; margin-top:4px;">
      í”Œë«í¼Â·íŒë§¤ì ì„¤ì •ì— ë”°ë¼ ìƒì´,  
      ìœ„ì±— ì†Œí†µ ê¸°ë°˜ì´ë¼ ë§Œì¡±ë„ ë†’ì„ ê²½ìš° ë‹¹ì¼ ìš”ì²­ ì„±ê³µ ì‚¬ë¡€ ìˆìŒ
    </div>
  </div>

  <!-- Trazy -->
  <div style="margin-bottom:12px;">
    <div>
      <span class="origin-badge badge-trazy">Z</span>
      <b>Trazy</b> Â· <b style="color:#f9a825;">ìƒí’ˆë³„ ìƒì´</b>
    </div>
    <div style="font-size:12px; margin-top:4px;">
      ëŒ€ë¶€ë¶„ ì¢…ë£Œ í›„ í›„ê¸° í™œì„±í™”,  
      ìƒí’ˆ ì„¸íŒ…ì— ë”°ë¼ ì‹œì  ë‹¤ë¥´ë¯€ë¡œ ë‹¹ì¼ ê°•ìš”ëŠ” ë¹„ì¶”ì²œ
    </div>
  </div>

  <!-- ê¸°íƒ€ -->
  <div>
    <div>
      <span class="origin-badge badge-etc">ë¯¸</span>
      <b>ê¸°íƒ€ / í˜„ì¥</b> Â· <b style="color:#2e7d32;">ì¦‰ì‹œ ê°€ëŠ¥</b>
    </div>
    <div style="font-size:12px; margin-top:4px;">
      í”Œë«í¼ í›„ê¸° ì—†ìŒ,  
      êµ¬ê¸€ë§µ ë¦¬ë·°Â·SNS íƒœê·¸Â·ê°€ì´ë“œ ì´ë¦„ ì–¸ê¸‰ ìš”ì²­ì´ ê°€ì¥ í˜„ì‹¤ì 
    </div>
  </div>

</div>



<div class="manual-section">

    <div class="manual-title">ğŸ“˜ íˆ¬ì–´ë§ˆìŠ¤í„° ì‚¬ìš© ì„¤ëª…ì„œ</div>

    <ul class="manual-list">

        <li><span>1ë‹¨ê³„ ê¸°ë³¸ ì •ë³´ ì„¤ì •:</span> ê°€ì´ë“œ ì„±í•¨ê³¼ ë²„ìŠ¤ ë²ˆí˜¸ëŠ” ëª¨ë“  ëŒ€ê³ ê° ë©”ì‹œì§€ì™€ ì—°ë½ì²˜ íŒŒì¼ëª…ì˜ ê¸°ì¤€ì´ ë©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì…ë ¥ëœ ì •ë³´ëŠ” ì´í›„ ìƒì„±ë˜ëŠ” ì´ë¯¸ì§€ì™€ ë©”ì‹œì§€ì— ìë™ìœ¼ë¡œ ë°˜ì˜ë˜ì–´ ê°€ì´ë“œì˜ ì „ë¬¸ì„±ì„ ë†’ì—¬ì¤ë‹ˆë‹¤.</li>

        <li><span>2ë‹¨ê³„ ì¶œë°œ ì‹œê°„ ì„¤ì •:</span> ê° í”½ì—… í¬ì¸íŠ¸ë³„ ì‹œê°„ì„ ì •í™•íˆ ì…ë ¥í•˜ë©´, ì†ë‹˜ì—ê²Œ ë°œì†¡ë˜ëŠ” ê°œë³„ ì•ˆë‚´ ë©”ì‹œì§€ì— í•´ë‹¹ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ë§¤ì¹­ë©ë‹ˆë‹¤. ê°€ì´ë“œê°€ ì¼ì¼ì´ ì‹œê°„ì„ ê³„ì‚°í•˜ì—¬ ì…ë ¥í•˜ëŠ” ì‹¤ìˆ˜ë¥¼ ì›ì²œì ìœ¼ë¡œ ë°©ì§€í•©ë‹ˆë‹¤.</li>

        <li><span>3ë‹¨ê³„ ë°ì´í„° ì…ë ¥:</span> í˜„ì¥ì—ì„œ ìˆ˜ì‹ í•œ ì¹´í†¡ì´ë‚˜ ì—‘ì…€ ëª…ë‹¨ì„ ê°€ê³µ ì—†ì´ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ì„ íƒí•œ ë²„ìŠ¤ ì¸ìŠ¹(44/45/FIT)ì— ë”°ë¼ ìµœì í™”ëœ ì¢Œì„ ê·¸ë¦¬ë“œê°€ ìƒì„±ë˜ë©°, ì´ëŠ” íš¨ìœ¨ì ì¸ ì¸ì› ê´€ë¦¬ë¥¼ ìœ„í•œ ì²« ë‹¨ì¶”ê°€ ë©ë‹ˆë‹¤.</li>

        <li><span>4ë‹¨ê³„ ë°°ì¹˜ ìš°ì„ ìˆœìœ„ ì„¤ì •:</span> ì–¸ì–´ë³„, ì¸ì›ë³„, í”½ì—…ì§€ë³„ ì¡°ê±´ì„ ì²´í¬í•˜ì—¬ AIì—ê²Œ ë°°ì¹˜ íŒíŠ¸ë¥¼ ì œê³µí•˜ì„¸ìš”. ì•ìª½ í˜¹ì€ ë’¤ìª½ ì„ í˜¸ ì˜µì…˜ì„ í†µí•´ ë…¸ì•½ìë‚˜ íŠ¹ì • ê·¸ë£¹ì˜ íŠ¹ì´ì‚¬í•­ì„ ì¢Œì„ ë°°ì¹˜ì— ì¦‰ê° ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>

        <li><span>5ë‹¨ê³„ ìë™ ë°°ì¹˜ ì‹¤í–‰:</span> [Run] ë²„íŠ¼ì„ ëˆ„ë¥´ëŠ” ìˆœê°„ ëª¨ë“  ë°ì´í„°ê°€ ë¶„ì„ë˜ì–´ ìµœì ì˜ ì¢Œì„ ë°°ì¹˜ ì´ˆì•ˆì´ í™•ì •ë©ë‹ˆë‹¤. ì´ ë‹¨ê³„ì—ì„œ ì „ì²´ ì¸ì› êµ¬ì„±ê³¼ ì°¨ëŸ‰ ë‚´ ë°€ì§‘ë„ë¥¼ ì‹œê°ì ìœ¼ë¡œ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>

        <li><span>6ë‹¨ê³„ ì—°ë½ì²˜ ì €ì¥:</span> í™•ì •ëœ ëª…ë‹¨ì„ ê¸°ë°˜ìœ¼ë¡œ VCF íŒŒì¼ì„ ìƒì„±í•˜ì—¬ íœ´ëŒ€í°ì— ì €ì¥í•˜ì„¸ìš”. ê¹€í™” ì‹¤ì¥ë‹˜ ë°”ë³´. íˆ¬ì–´ ë‹¹ì¼ ëª¨ë¥´ëŠ” ë²ˆí˜¸ë¡œ ì˜¤ëŠ” ì „í™”ë¥¼ ì¦‰ì‹œ ì‹ë³„í•˜ê³ , ë©”ì‹ ì € ì•±ê³¼ ì—°ë™í•˜ê¸° ìœ„í•œ ì‹¤ë¬´ìƒì˜ í•„ìˆ˜ ì ˆì°¨ì…ë‹ˆë‹¤.</li>

        <li><span>7ë‹¨ê³„ í˜„ì¥ ì¶”ê°€:</span> ìë™ ë°°ì¹˜ ì™„ë£Œ í›„ ë°œìƒí•˜ëŠ” ê°‘ì‘ìŠ¤ëŸ¬ìš´ í˜„ì¥ ì˜ˆì•½(Walk-in)ì€ ì „ìš© ì¶”ê°€ ë²„íŠ¼ì„ í™œìš©í•˜ì„¸ìš”. ê¸°ì¡´ì— í™•ì •ëœ ì „ì²´ ì¢Œì„ êµ¬ì¡°ë¥¼ ííŠ¸ëŸ¬ëœ¨ë¦¬ì§€ ì•Šê³  ë¹ˆìë¦¬ì—ë§Œ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ì¸ì›ì„ ë°°ì •í•©ë‹ˆë‹¤.</li>

        <li><span>8ë‹¨ê³„ ëª…ë‹¨ ì¶”ê°€:</span> íˆ¬ì–´ ì§ì „ ì¶”ê°€ëœ ì—¬ëŸ¬ ëª…ì˜ ë¦¬ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ 'ëª…ë‹¨ ì¶”ê°€' ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”. ì´ë¯¸ ë°°ì¹˜ê°€ ëë‚œ ìƒí™©ì—ì„œë„ ê¸°ì¡´ ì†ë‹˜ë“¤ì˜ ìë¦¬ë¥¼ ìœ ì§€í•˜ë©´ì„œ, ìƒˆë¡œìš´ ëª…ë‹¨ë§Œ ë¹ˆ ì¢Œì„ì— ìˆœì°¨ì ìœ¼ë¡œ ì±„ì›Œ ë„£ìŠµë‹ˆë‹¤.</li>

        <li><span>9ë‹¨ê³„ ì¢Œì„ë°°ì¹˜í‘œ ì •ë¦¬ & ìŠ¤ìƒ· ì €ì¥:</span> íƒ­ ê¸°ëŠ¥ì„ ì´ìš©í•´ ìµœì¢… ì¢Œì„ì„ ì •ë¦¬í•œ í›„ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ì„¸ìš”. ì´ ìŠ¤í¬ë¦°ìƒ·ì€ ê¸°ì‚¬ë‹˜ê³¼ì˜ ì›í™œí•œ ì†Œí†µì„ ë•ê³ , ìŠ¹ì°¨ ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì†ë‹˜ë“¤ ê°„ì˜ í˜¼ì„ ì„ ë°©ì§€í•˜ëŠ” ê²°ì •ì ì¸ ë„êµ¬ê°€ ë©ë‹ˆë‹¤.</li>

        <li><span>10ë‹¨ê³„ ê°€ì´ë“œ ê°œì¸ê³µì§€:</span> íˆ¬ì–´ ë‹¹ì¼ì˜ ë‚ ì”¨, ë³€ê²½ëœ ì£¼ì˜ì‚¬í•­ ë“± ì˜¤ëŠ˜ë§Œ í•„ìš”í•œ íŠ¹ë³„ ë©”ì‹œì§€ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”. ê³ ì •ëœ ì•ˆë‚´ ë¬¸êµ¬ì™€ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•¨ìœ¼ë¡œì¨ ì†ë‹˜ì—ê²Œ ì „ë‹¬í•´ì•¼ í•  í•µì‹¬ ì •ë³´ë¥¼ ëˆ„ë½ ì—†ì´ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>

        <li><span>11ë‹¨ê³„ ë©”ì‹œì§€ ë°œì†¡ ì²´í¬:</span> ìƒì„±ëœ ê°œë³„ ë©”ì‹œì§€ì˜ [Send] ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°œì†¡í•˜ê³  ì²´í¬ë°•ìŠ¤ë¡œ ê¸°ë¡í•˜ì„¸ìš”. ë§ì€ ì¸ì›ì„ ì‘ëŒ€í•  ë•Œ ë°œìƒí•˜ê¸° ì‰¬ìš´ ì¤‘ë³µ ë°œì†¡ì´ë‚˜ ëˆ„ë½ì„ ë§‰ì•„ì£¼ëŠ” ë§ˆì§€ë§‰ ì•ˆì „ì¥ì¹˜ì…ë‹ˆë‹¤.</li>

    </ul>

</div>


<script>

/**

 * [ì „ì—­ ìƒìˆ˜ ë° ì„¤ì •] - ë²„ì „ 10.8 (Gender Free + FIT)

 */

const CONFIG = {

    BOOTS_YOUTUBE: "https://youtu.be/J9S0q1QKoOY?si=pfaS60b3IJOEBgAG",

    COLORS: {

        hongdae: '#C8E6C9',    // í™ëŒ€ (ì´ˆë¡)

        myeongdong: '#BBDEFB', // ëª…ë™ (íŒŒë‘)

        dongdaemun: '#E1BEE7', // ë™ëŒ€ë¬¸ (ë³´ë¼)

        resort: '#FFF9C4',     // ìŠ¤í‚¤ì¥/D2/D3 (ë…¸ë‘)

        etc: '#E0E0E0'         // ê¸°íƒ€/í˜„ì¥ (íšŒìƒ‰)

    },

    PHONE_CODES: { 
    "1": "US", "7": "RU", "20": "EG", "27": "ZA", "30": "GR", "31": "NL", "32": "BE", "33": "FR", "34": "ES",
    "36": "HU", "39": "IT", "40": "RO", "41": "CH", "43": "AT", "44": "UK", "45": "DK", "46": "SE", "47": "NO",
    "48": "PL", "49": "DE",

    "51": "PE", "52": "MX", "53": "CU", "54": "AR", "55": "BR", "56": "CL", "57": "CO", "58": "VE",
    "60": "MY", "61": "AU", "62": "ID", "63": "PH", "64": "NZ", "65": "SG", "66": "TH",

    "81": "JP", "82": "KR", "84": "VN", "86": "CN",
    "90": "TR", "91": "IN", "92": "PK", "93": "AF", "94": "LK", "95": "MM", "98": "IR",

    "852": "HK", "853": "MO", "886": "TW",

    "971": "AE", "966": "SA", "974": "QA", "965": "KW", "968": "OM", "973": "BH", "962": "JO", "964": "IQ",

    "880": "BD", "977": "NP", "960": "MV",

    "855": "KH", "856": "LA", "673": "BN", "976": "MN",

    "998": "UZ", "7": "KZ", "996": "KG", "994": "AZ", "995": "GE", "374": "AM",

    "358": "FI", "354": "IS", "353": "IE", "351": "PT", "30": "GR",

    "372": "EE", "371": "LV", "370": "LT", "421": "SK", "386": "SI", "420": "CZ",

    "212": "MA", "216": "TN", "254": "KE", "255": "TZ", "256": "UG", "234": "NG", "233": "GH", "251": "ET",

    "507": "PA", "506": "CR", "1876": "JM", "1809": "DO",

    "679": "FJ", "685": "WS", "675": "PG", "680": "PW", "691": "FM", "692": "MH"
},

    COUNTRY_MAP: {
  'KR':'í•œêµ­','CN':'ì¤‘êµ­','TW':'ëŒ€ë§Œ','HK':'í™ì½©','MO':'ë§ˆì¹´ì˜¤','JP':'ì¼ë³¸',

  'US':'ë¯¸êµ­','CA':'ìºë‚˜ë‹¤','UK':'ì˜êµ­','FR':'í”„ë‘ìŠ¤','DE':'ë…ì¼','ES':'ìŠ¤í˜ì¸','IT':'ì´íƒˆë¦¬ì•„',
  'NL':'ë„¤ëœë€ë“œ','BE':'ë²¨ê¸°ì—','CH':'ìŠ¤ìœ„ìŠ¤','AT':'ì˜¤ìŠ¤íŠ¸ë¦¬ì•„','SE':'ìŠ¤ì›¨ë´','NO':'ë…¸ë¥´ì›¨ì´',
  'FI':'í•€ë€ë“œ','DK':'ë´ë§ˆí¬','PL':'í´ë€ë“œ','CZ':'ì²´ì½”','HU':'í—ê°€ë¦¬','RO':'ë£¨ë§ˆë‹ˆì•„',
  'BG':'ë¶ˆê°€ë¦¬ì•„','GR':'ê·¸ë¦¬ìŠ¤','PT':'í¬ë¥´íˆ¬ê°ˆ','IE':'ì•„ì¼ëœë“œ','IS':'ì•„ì´ìŠ¬ë€ë“œ',
  'EE':'ì—ìŠ¤í† ë‹ˆì•„','LV':'ë¼íŠ¸ë¹„ì•„','LT':'ë¦¬íˆ¬ì•„ë‹ˆì•„','SK':'ìŠ¬ë¡œë°”í‚¤ì•„','SI':'ìŠ¬ë¡œë² ë‹ˆì•„',
  'RU':'ëŸ¬ì‹œì•„','UA':'ìš°í¬ë¼ì´ë‚˜',

  'SG':'ì‹±ê°€í¬ë¥´','MY':'ë§ë ˆì´ì‹œì•„','TH':'íƒœêµ­','VN':'ë² íŠ¸ë‚¨','PH':'í•„ë¦¬í•€','ID':'ì¸ë„ë„¤ì‹œì•„',
  'BN':'ë¸Œë£¨ë‚˜ì´','KH':'ìº„ë³´ë””ì•„','LA':'ë¼ì˜¤ìŠ¤','MM':'ë¯¸ì–€ë§ˆ','MN':'ëª½ê³¨',

  'IN':'ì¸ë„','PK':'íŒŒí‚¤ìŠ¤íƒ„','BD':'ë°©ê¸€ë¼ë°ì‹œ','LK':'ìŠ¤ë¦¬ë‘ì¹´','NP':'ë„¤íŒ”','MV':'ëª°ë””ë¸Œ',

  'KZ':'ì¹´ìíìŠ¤íƒ„','UZ':'ìš°ì¦ˆë² í‚¤ìŠ¤íƒ„','KG':'í‚¤ë¥´ê¸°ìŠ¤ìŠ¤íƒ„',
  'AZ':'ì•„ì œë¥´ë°”ì´ì”','GE':'ì¡°ì§€ì•„','AM':'ì•„ë¥´ë©”ë‹ˆì•„',

  'AE':'ì•„ëì—ë¯¸ë¦¬íŠ¸','SA':'ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„','QA':'ì¹´íƒ€ë¥´','KW':'ì¿ ì›¨ì´íŠ¸',
  'OM':'ì˜¤ë§Œ','BH':'ë°”ë ˆì¸','JO':'ìš”ë¥´ë‹¨','IQ':'ì´ë¼í¬','IR':'ì´ë€','IL':'ì´ìŠ¤ë¼ì—˜',
  'TR':'í„°í‚¤','EG':'ì´ì§‘íŠ¸','MA':'ëª¨ë¡œì½”','TN':'íŠ€ë‹ˆì§€',

  'ZA':'ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­','KE':'ì¼€ëƒ','TZ':'íƒ„ìë‹ˆì•„','UG':'ìš°ê°„ë‹¤',
  'NG':'ë‚˜ì´ì§€ë¦¬ì•„','GH':'ê°€ë‚˜','ET':'ì—í‹°ì˜¤í”¼ì•„',

  'MX':'ë©•ì‹œì½”','PE':'í˜ë£¨','BR':'ë¸Œë¼ì§ˆ','AR':'ì•„ë¥´í—¨í‹°ë‚˜','CL':'ì¹ ë ˆ','CO':'ì½œë¡¬ë¹„ì•„',
  'VE':'ë² ë„¤ìˆ˜ì—˜ë¼','PA':'íŒŒë‚˜ë§ˆ','CR':'ì½”ìŠ¤íƒ€ë¦¬ì¹´',
  'DO':'ë„ë¯¸ë‹ˆì¹´ê³µí™”êµ­','JM':'ìë©”ì´ì¹´','CU':'ì¿ ë°”',

  'AU':'í˜¸ì£¼','NZ':'ë‰´ì§ˆëœë“œ','FJ':'í”¼ì§€','WS':'ì‚¬ëª¨ì•„',
  'PG':'íŒŒí‘¸ì•„ë‰´ê¸°ë‹ˆ','PW':'íŒ”ë¼ìš°','FM':'ë¯¸í¬ë¡œë„¤ì‹œì•„','MH':'ë§ˆì…œì œë„'
},
    SCHEMES: {

        'kakao': 'kakaotalk://',

        'line': 'line://',

        'wechat': 'weixin://', 

        'viber': 'viber://',

        'mail': 'mailto:'

    }

};



let currentSeatMap1 = [];

let currentSeatMap2 = [];

let selectedSeat = { busNum: 0, idx: -1 };

let msgListGroups = []; 

let priorityQueue = [];

let audioCtx = null;



// =========================================

// [ê¸°ì› íŒë³„ ë¡œì§]

// =========================================

function detectOrigin(rawId) {

    if (!rawId) return "(ë¯¸)";

    let temp = rawId.split('-')[0];

    temp = temp.replace(/\(.*\)/g, '').replace(/\s+/g, '').toUpperCase();

    if (temp.includes('QIKE')) return "(ì¹˜)";

    if (temp.includes('GYG')) return "(ê²Ÿ)";

    if (/^\d{8}[A-Z]{2}\d{5}$/.test(temp)) return "(ì§€)";

    if (/^[A-Z]{3}\d{6}$/.test(temp)) return "(í´)";

    if (/^(24|25|26)KK/.test(temp)) return "(ì¼€)";

    if (/^\d{8,}$/.test(temp)) return "(íŠ¸)";

    return "(ë¯¸)";

}



function getOriginBadgeHtml(tag) {

    if (!tag) return "";

    if (tag.includes('í´')) return `<span class="origin-badge badge-klook">K</span>`;

    if (tag.includes('ì¼€')) return `<span class="origin-badge badge-kkday">K</span>`;

    if (tag.includes('íŠ¸')) return `<span class="origin-badge badge-trip">T</span>`;

    if (tag.includes('ê²Ÿ')) return `<span class="origin-badge badge-gyg">G</span>`;

    if (tag.includes('ì¹˜')) return `<span class="origin-badge badge-qike">Q</span>`;

    if (tag.includes('ì§€')) return `<span class="origin-badge badge-trazy">Z</span>`;

    return `<span class="origin-badge badge-etc">ë¯¸</span>`;

}



// =========================================

// [1] ìœ í‹¸ë¦¬í‹° ë° í—¬í¼ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)

// =========================================



function initAudio() {

  if (!audioCtx) {

    const AudioContext = window.AudioContext || window.webkitAudioContext;

    audioCtx = new AudioContext();

  }

  if (audioCtx.state === 'suspended') { audioCtx.resume(); }

}



function playPopSound() {

  initAudio();

  if (!audioCtx) return;

  const osc = audioCtx.createOscillator();

  const gainNode = audioCtx.createGain();

  osc.connect(gainNode);

  gainNode.connect(audioCtx.destination);

  osc.type = 'sine';

  osc.frequency.setValueAtTime(800, audioCtx.currentTime);

  osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);

  gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);

  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

  osc.start(audioCtx.currentTime);

  osc.stop(audioCtx.currentTime + 0.1);

}



document.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON' || 
        (e.target.tagName === 'INPUT' && (e.target.type === 'checkbox' || e.target.type === 'radio')) || 
        e.target.closest('.seat') || 
        e.target.closest('.opt-card') || 
        e.target.closest('.btn-action')) {
        playPopSound();
    }
});




function combinePhoneAndMessenger(phoneCol, messengerCol) {

    let cleanPhoneCol = (phoneCol || "").trim();

    let splitPhone = cleanPhoneCol.split(/[,\/]/);

    let firstPhone = splitPhone[0] ? splitPhone[0].trim() : "";

    let cleanMsgCol = (messengerCol || "").trim();

    let lowerMsg = cleanMsgCol.toLowerCase();

    

    let rawPhoneDigits = firstPhone.replace(/[^0-9]/g, '');

    let f_CountryCode = "82"; 

    let f_Country = "ETC";

    

    for (let len = 4; len >= 1; len--) {

        let prefix = rawPhoneDigits.substring(0, len);

        if (CONFIG.PHONE_CODES[prefix]) { 

            f_CountryCode = prefix; 

            f_Country = CONFIG.PHONE_CODES[prefix]; 

            break; 

        }

    }

    

    let targetBody = "";

    let isMessengerValid = false;

    

    if (lowerMsg.includes('whatsapp') || lowerMsg.includes('viber')) {

        targetBody = cleanMsgCol.replace(/[^0-9]/g, '');

        isMessengerValid = true;

    } 

    

    if (!isMessengerValid) {

        targetBody = rawPhoneDigits;

    }

    

    if (targetBody.startsWith('0')) targetBody = targetBody.substring(1);

    

    let fullNumber = "";

    if (targetBody.startsWith(f_CountryCode)) {

        fullNumber = targetBody;

    } else {

        fullNumber = f_CountryCode + targetBody;

    }

    

    return { code: f_CountryCode, country: f_Country, fullNumber: fullNumber };

}



function getMessengerApp(text) { 

    if(!text) return 'ë¬´'; 



    const raw = String(text || "");

    const t = raw.toLowerCase();



    if(t.includes('whatsapp')) return 'ì™€'; 

    if(t.includes('line')) return 'ë¼'; 

    if(t.includes('kakao')) return 'ì¹´'; 



    if (

        t.includes("wechat") ||

        t.includes("weixin") ||

        raw.includes("å¾®ä¿¡")

    ) return "ì›¨";



    if(t.includes('viber')) return 'ë°”'; 

    if(t.includes('zalo')) return 'ì˜'; 

    return 'ë¬´'; 

}



function copyToClipboard(text, el) {

    if (navigator.clipboard && window.isSecureContext) {

        navigator.clipboard.writeText(text).then(() => { feedback(el); }).catch(() => { fallbackCopy(text, el); });

    } else { fallbackCopy(text, el); }

}



function fallbackCopy(text, el) {

    const scrollY = window.scrollY;

    const helper = document.getElementById('clipboardHelper');

    helper.value = text;

    helper.focus({ preventScroll: true });

    helper.select();

    document.execCommand('copy');

    helper.blur();

    window.scrollTo(0, scrollY);

    feedback(el);

}



function copyAndOpen(el, text, schemeKey) {

    copyToClipboard(text, el);

    let scheme = CONFIG.SCHEMES[schemeKey];

    if (schemeKey === 'viber') { const cleanNum = text.replace(/[^0-9]/g, ''); scheme = `viber://chat?number=${cleanNum}`; }

    if (scheme) { setTimeout(() => { try { window.location.href = scheme; } catch(e) {} }, 300); }

}



function feedback(el) { if(!el) return; let original = el.innerHTML; el.innerHTML = 'OK!'; setTimeout(() => el.innerHTML = original, 800); }

function copyMessageBody(btn) { const card = btn.closest('.msg-card'); const hiddenDiv = card.querySelector('.hidden-msg'); copyToClipboard(hiddenDiv.textContent, btn); }

function copyOnly(el, text) { copyToClipboard(text, el); }



// =========================================

// [2] ë°ì´í„° íŒŒì‹± ë° ì „ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)

// =========================================

function findCount(parts) {

  for (let i = 0; i < parts.length - 1; i++) {

    if (parts[i].includes('ì¤‘êµ­ì–´') || parts[i].includes('ì˜ì–´')) {

      let n = parseInt(parts[i+1]);

      if (!isNaN(n)) return n;

    }

  }

  return 1;

}



function findLocation(parts) {

  for (let p of parts) {

    if (p.includes('í™ëŒ€') || p.includes('ëª…ë™') || p.includes('ë™ëŒ€ë¬¸')) return p.trim();

  }

  return "";

}



function parseRawDataLine(line, originalOrder, isGlobalSki, headerMap) {

    let parts = line.split('\t').map(p => p.trim());

    if (headerMap && parts.length < 2) { parts = line.split(/\s{2,}/).map(p => p.trim()); }

    if (headerMap && !parts[headerMap.name]) return null;

    if(parts.length < 4 && !headerMap) return null;



    let firstCol = parts[0] || "";

    if (firstCol === 'No.' || firstCol.includes('ì˜ˆì•½ë²ˆí˜¸') || firstCol.toLowerCase().startsWith('total') || firstCol.includes('ì—‘ì…€')) return null;



    const lineLower = line.toLowerCase();

    const isSkiTour = isGlobalSki || lineLower.includes('ski') || lineLower.includes('snowboard');



    let customId, productName, name, rawPhone, messengerCol, count, location, rawLang, note;

    let resNoForOrigin = ""; 



    if (headerMap) {

        customId = parts[headerMap.no] || originalOrder.toString();

        productName = (headerMap.product !== -1 && parts[headerMap.product]) ? parts[headerMap.product] : "Ski Tour";

        name = parts[headerMap.name] || "Guest";

        rawPhone = (headerMap.phone !== -1 && parts[headerMap.phone]) ? parts[headerMap.phone] : "";

        messengerCol = (headerMap.messenger !== -1 && parts[headerMap.messenger]) ? parts[headerMap.messenger] : "";

        resNoForOrigin = (headerMap.resNo !== -1 && parts[headerMap.resNo]) ? parts[headerMap.resNo] : "";

        rawLang = ""; 

        count = findCount(parts); 

        location = findLocation(parts);

        note = ""; 

        if(!customId) customId = originalOrder.toString();

    } else {

        customId = parts[0] || originalOrder.toString();

        if (isSkiTour) {

             productName = parts[1] || "";

             resNoForOrigin = parts[2] || ""; 

             name = parts[3] || "Guest";

             rawPhone = parts[4] || "";

             messengerCol = parts[5] || "";

             rawLang = parts[7] || "";

             count = findCount(parts);

             location = findLocation(parts);

             note = parts[10] || "";

        } else {

             productName = parts[2] || "";

             name = parts[4] || "Guest";

             rawPhone = parts[5] || "";

             messengerCol = parts[6] || "";

             rawLang = parts[8] || "";

             count = findCount(parts);

             location = findLocation(parts);

             note = parts[12] || "";

             resNoForOrigin = customId; 

        }

    }



    let originTag = detectOrigin(resNoForOrigin);

    let optLift = false, optGear = false, optClothes = false, optLesson = false;

    if (!headerMap && isSkiTour) {

        if (parts[11] && parseInt(parts[11]) > 0) optLift = true;

        if (parts[12] && parseInt(parts[12]) > 0) optGear = true;

        if (parts[13] && parseInt(parts[13]) > 0) optClothes = true;

        if (parts[14] && parseInt(parts[14]) > 0) optLesson = true;

    }



    let paxType = 'General'; let isStay = false; 

        let isBoard = (productName.toLowerCase().includes('board') || productName.includes('ë³´ë“œ'));
    let isHot = (productName.toLowerCase().includes('hot')); 
    let isMoving = (line.includes('ë¬´ë¹™') && !line.includes('ë¦¬í”„íŠ¸') && !line.includes('ë¦¬í”„íŠ¸ì—…'));
    let isChair = (line.includes('ë¬´ë¹™') && line.includes('ë¦¬í”„íŠ¸'));
    let isSightseeing = (line.includes('ê´€ê´‘'));
    let isSled = (line.includes('ìŠ¤ë…¸ìš°í'));
    let isShuttle = (line.includes('ì…”í‹€'));
  
    let lowerP = productName.toLowerCase();



    if (lowerP.includes('day1') || lowerP.includes('day 1')) { paxType = 'D1'; }

    else if (lowerP.includes('day2') || lowerP.includes('day 2')) { paxType = 'D2'; }

    else if (lowerP.includes('day3') || lowerP.includes('day 3')) { paxType = 'D3'; }

 

    

    if (paxType === 'General' && (location.includes('ìŠ¤í‚¤ì¥') || location.includes('Resort'))) { paxType = 'D2'; }



    let parsedInfo = combinePhoneAndMessenger(rawPhone, messengerCol);
    // ì˜¤ì§ í…ìŠ¤íŠ¸(rawLang)ì— í¬í•¨ëœ ë‹¨ì–´ë§Œ ê¸°ì¤€ìœ¼ë¡œ íŒë³„í•©ë‹ˆë‹¤.
    let langContext = 'EN'; // ê¸°ë³¸ê°’ì€ ì˜ì–´

    if (rawLang && rawLang.includes('ì¤‘êµ­ì–´')) {
        langContext = 'CN';
    } else if (rawLang && rawLang.includes('ì˜ì–´')) {
        langContext = 'EN';
    }


    let gender = 'N'; 

    let appType = getMessengerApp(messengerCol);

    if (note && note.toLowerCase().includes('whatsapp')) { appType = 'ì™€'; }



    let emailAddr = "";

    for(let p of parts) { if(p && p.includes('@')) { emailAddr = p; break; } }



                                return {
      id: customId, originalId: originalOrder, name: name, 
      phone: parsedInfo.fullNumber, 
      count: count, location: location, note: note,
      country: parsedInfo.country, langContext: langContext, gender: gender, appType: appType, messenger: messengerCol, isGrouped: false,
      paxType: paxType, isStay: isStay, isBoard: isBoard, 
      isSancheoneo: !isSkiTour, isHot: isHot, isMoving: isMoving, isChair: isChair, isSightseeing: isSightseeing, isSled: isSled, isShuttle: isShuttle, email: emailAddr,
      originTag: originTag, 
      options: { lift: optLift, gear: optGear, clothes: optClothes, lesson: optLesson }
    };





}



function createGroupsFromEntries(entries) {
    let finalGroups = [];
    entries.forEach((entry) => {
        if(entry.isGrouped) return;
        let currentGroupMembers = [entry]; entry.isGrouped = true;
        
        function norm(v) {
            if (!v) return "";
            return String(v).trim().toLowerCase();
        }

        function isSameGroup(a, b) {
            const aPhone = norm(a.phone);
            const bPhone = norm(b.phone);
            const aName  = norm(a.name);
            const bName  = norm(b.name);
            const aId    = norm(a.id);
            const bId    = norm(b.id);
            const aMail  = norm(a.email);
            const bMail  = norm(b.email);
            const aMsg   = norm(a.messenger);
            const bMsg   = norm(b.messenger);

            if (aPhone && bPhone && aPhone === bPhone) return true;
            if (aName  && bName  && aName  === bName)  return true;
            if (aId    && bId    && aId    === bId)    return true;
            if (aMsg && bMsg && aMsg === bMsg) return true;

            return false;
        }

        let queue = [entry];
        while(queue.length > 0) {
            let curr = queue.shift();
            entries.forEach((target) => {
                if(target.isGrouped) return;
                if (isSameGroup(curr, target)) {
                    target.isGrouped = true;
                    currentGroupMembers.push(target);
                    queue.push(target);
                }
            });
        }

        let rep = currentGroupMembers[0];
        
        // [ìˆ˜ì •ëœ ë¶€ë¶„] ìˆ«ìë¥¼ ì¶”ì¶œí•˜ê³  ì¤‘ë³µ ì œê±° í›„ 3.4 í˜•íƒœë¡œ ê²°í•©í•©ë‹ˆë‹¤.
        let cleanIds = currentGroupMembers.map(m => m.id.replace(/\D/g, '')); 
        if (cleanIds.some(id => id === "")) cleanIds = currentGroupMembers.map(m => m.id);
        
        let uniqueIds = [...new Set(cleanIds)].sort((a,b) => parseInt(a) - parseInt(b));
        let displayNum = uniqueIds.join('.'); 

        let totalC = currentGroupMembers.reduce((sum, m) => sum + m.count, 0);
        let uniqueTags = [...new Set(currentGroupMembers.map(m => m.originTag))];
        let combinedOrigin = uniqueTags.join('');

        let groupType = 'General';
        if(currentGroupMembers.some(m => m.paxType === 'D3')) groupType = 'D3';
        else if(currentGroupMembers.some(m => m.paxType === 'D2')) groupType = 'D2';
        else if(currentGroupMembers.some(m => m.paxType === 'D1')) groupType = 'D1';
        if (groupType === 'D1' && currentGroupMembers.some(m => m.paxType === 'General')) groupType = 'D1';

        let gLift = currentGroupMembers.some(m => m.options.lift);
        let gGear = currentGroupMembers.some(m => m.options.gear);
        let gClothes = currentGroupMembers.some(m => m.options.clothes);
        let gLesson = currentGroupMembers.some(m => m.options.lesson);

                                        finalGroups.push({
            mainNum: displayNum, 
            msgNum: displayNum, 
            repNum: rep.id, 
            count: totalC, name: rep.name, country: rep.country, gender: rep.gender,
            langContext: rep.langContext, appType: rep.appType, location: rep.location, 
            phone: rep.phone, messenger: rep.messenger, paxType: groupType, 
            isStay: currentGroupMembers.some(m => m.isStay), 
            isBoard: currentGroupMembers.some(m => m.isBoard), 
            isSancheoneo: rep.isSancheoneo, 
            isHot: currentGroupMembers.some(m => m.isHot),
            memberHotList: currentGroupMembers.flatMap(m => Array(m.count).fill(m.isHot)),
            isMoving: currentGroupMembers.some(m => m.isMoving),
            memberMovingList: currentGroupMembers.flatMap(m => Array(m.count).fill(m.isMoving)),
            isChair: currentGroupMembers.some(m => m.isChair),
            memberChairCount: currentGroupMembers.reduce((sum, m) => sum + (m.isChair ? m.count : 0), 0),
            isMovingCount: currentGroupMembers.reduce((sum, m) => sum + (m.isMoving ? m.count : 0), 0),
            isSightseeingCount: currentGroupMembers.reduce((sum, m) => sum + (m.isSightseeing ? m.count : 0), 0),
            isSledCount: currentGroupMembers.reduce((sum, m) => sum + (m.isSled ? m.count : 0), 0),
            isShuttle: currentGroupMembers.some(m => m.isShuttle),
            memberShuttleList: currentGroupMembers.flatMap(m => Array(m.count).fill(m.isShuttle)),
            isSkiTour: currentGroupMembers.some(m => !m.isSancheoneo),
            email: rep.email,
            originTag: combinedOrigin, 
            options: { lift: gLift, gear: gGear, clothes: gClothes, lesson: gLesson },
            isBoarded: false,
            offOptions: []
        });


    });
    return finalGroups;
}




function calculateScore(grp) {

    let score = 0;

    priorityQueue.forEach((criteria, idx) => {

        let weight = Math.pow(10, 6 - idx); let match = false;

        if (criteria === 'solo' && grp.count === 1) match = true;

        if (criteria === 'CN' && grp.langContext === 'CN') match = true;

        if (criteria === 'EN' && grp.langContext === 'EN') match = true;

        if (criteria === 'G4' && grp.count >= 4) match = true;

        if (criteria === 'HD' && grp.location.includes('í™ëŒ€')) match = true;

        if (criteria === 'MY' && grp.location.includes('ëª…ë™')) match = true;

        if (criteria === 'DDM' && grp.location.includes('ë™ëŒ€ë¬¸')) match = true;

        if(match) score += weight;

    });

    return score;

}



function getPickColor(grp) {

    let loc = grp.location || '';

    if (grp.paxType === 'D2' || grp.paxType === 'D3') return CONFIG.COLORS.resort;

    if (loc.includes('í™ëŒ€')) return CONFIG.COLORS.hongdae;

    if (loc.includes('ëª…ë™')) return CONFIG.COLORS.myeongdong;

    if (loc.includes('ë™ëŒ€ë¬¸')) return CONFIG.COLORS.dongdaemun;

    return CONFIG.COLORS.etc;

}



function setGroupMeta(grp) {

    let nation = grp.country;

// ë’¤ì— .substring(0, 2)ë¥¼ ë¶™ì—¬ì„œ 2ê¸€ìë§Œ ê°€ì ¸ì˜¤ê²Œ ìˆ˜ì •
if (CONFIG.COUNTRY_MAP[grp.country]) nation = CONFIG.COUNTRY_MAP[grp.country].substring(0, 2);

    grp.textClass = 'neutral-text'; 

    grp.subInfo = `${nation}${grp.originTag}`; 

}



// =========================================

// [4] ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ (runAI - FIT ìˆ˜ì •ë¨)

// =========================================

function runAI() {

    saveTextInput(); saveTimeInput(); saveGuideName();

    localStorage.removeItem('bus_seatMap');

    

    let raw = document.getElementById('rawData').value;

    // ë”°ì˜´í‘œ ì•ˆì— ìˆëŠ” ì¤„ë°”ê¿ˆ(\r\n) ë¿ë§Œ ì•„ë‹ˆë¼ íƒ­(\t)ë„ ê³µë°±ìœ¼ë¡œ ë°”ê¿”ì„œ ì¹¸ ë°€ë¦¼ ë°©ì§€
raw = raw.replace(/"([^"]*)"/g, (match, p1) => p1.replace(/[\r\n\t]+/g, ' '));



    // [ìˆ˜ì •] FIT ëª¨ë“œ ë¶„ê¸° ì²˜ë¦¬

    let rawSizeVal = document.querySelector('input[name="busSize"]:checked').value;

    const isFit = (rawSizeVal === 'FIT');

    

    // FITì¸ ê²½ìš° ì´ˆê¸°ê°’ 0, ì•„ë‹ˆë©´ parseInt

    let busSize = isFit ? 0 : parseInt(rawSizeVal);



    const direction = document.querySelector('input[name="direction"]:checked').value;

    const lines = raw.trim().split('\n');

    const rawLower = raw.toLowerCase();

    const isGlobalSki = rawLower.includes('ski') || rawLower.includes('snowboard') || rawLower.includes('ìŠ¤í‚¤') || rawLower.includes('ìŠ¤ë…¸ìš°');



    let headerMap = null;

    let startLineIdx = 0;



    for (let k = 0; k < Math.min(lines.length, 5); k++) {

        let checkLine = lines[k].trim();

        if(!checkLine) continue;

        let headerParts = checkLine.split(/\t+/).map(h => h.trim());

        if (headerParts.length < 2) headerParts = checkLine.split(/\s{2,}/).map(h => h.trim());

        const idxNo = headerParts.findIndex(p => p === 'No.' || p === 'NO.');

        const idxRes = headerParts.findIndex(p => p.includes('ì˜ˆì•½ë²ˆí˜¸') || p.includes('Order'));



        if (idxNo !== -1 && idxRes !== -1) {

            headerMap = {

                no: idxNo,

                resNo: idxRes,

                product: headerParts.findIndex(p => p.includes('í–‰ì‚¬ëª…') || p.includes('ìƒí’ˆ') || p.includes('Product')),

                name: headerParts.findIndex(p => p.includes('ì˜ˆì•½ì') || p.includes('ì´ë¦„') || p.includes('Name')),

                phone: headerParts.findIndex(p => p.includes('í•¸ë“œí°') || p.includes('ì „í™”') || p.includes('ì—°ë½ì²˜') || p.includes('Phone')),

                messenger: headerParts.findIndex(p => p.includes('ë©”ì‹ ì €') || p.includes('ì¹´í†¡') || p.includes('Messenger') || p.includes('ì—°ë½ê°€ëŠ¥APP') || p.includes('ì•±'))

            };

            startLineIdx = k + 1; 

            break; 

        }

    }



    let entries = []; let originalOrder = 1;

    for (let i = startLineIdx; i < lines.length; i++) {

        let line = lines[i];

        if (!line.trim()) continue;

        const parsed = parseRawDataLine(line, originalOrder, isGlobalSki, headerMap);

        if(parsed) { entries.push(parsed); originalOrder++; }

    }



    msgListGroups = createGroupsFromEntries(entries);



    // [ì¶”ê°€] FIT ëª¨ë“œì¼ ê²½ìš°: ë°°ì • ëŒ€ìƒ ì¸ì›ìˆ˜ë§Œí¼ busSize ìë™ ì„¤ì •

    if (isFit) {

        let totalGoing = msgListGroups

            .filter(g => g.paxType === 'General' || g.paxType === 'D1')

            .reduce((sum, g) => sum + g.count, 0);

        

        busSize = totalGoing > 0 ? totalGoing : 1; 

    }



    let listGoing = msgListGroups.filter(g => g.paxType === 'General' || g.paxType === 'D1');

    if (direction === 'front') listGoing.sort((a,b) => calculateScore(b) - calculateScore(a));

    else listGoing.sort((a,b) => calculateScore(a) - calculateScore(b));



    currentSeatMap1 = new Array(busSize + 1).fill(null);

    

    // [ìˆ˜ì •] ì‹œí€€ìŠ¤ ìƒì„± ì‹œ isFit í”Œë˜ê·¸ ì „ë‹¬

    let seatSequence = generateSeatSequence(999, busSize, isFit);

    let currentSeqIdx = 0;



                                listGoing.forEach((grp) => {
        grp.color = getPickColor(grp); setGroupMeta(grp);
        for(let i=0; i<grp.count; i++) {
            if(currentSeqIdx < seatSequence.length) {
                let seatNum = seatSequence[currentSeqIdx];
                
                // ë¦¬ìŠ¤íŠ¸ì—ì„œ ië²ˆì§¸ ì‚¬ëŒì˜ HOT, ë¬´ë¹™, ì…”í‹€ ì—¬ë¶€ë¥¼ ê°ê° ì¶”ì¶œí•©ë‹ˆë‹¤.
                let individualHot = (grp.memberHotList && grp.memberHotList[i]) ? true : false;
                let individualMoving = (grp.memberMovingList && grp.memberMovingList[i]) ? true : false;
                let individualShuttle = (grp.memberShuttleList && grp.memberShuttleList[i]) ? true : false;

                // í•´ë‹¹ ì¢Œì„(seatNum)ì— ê°œë³„ ì†ì„±ì„ ì •í™•íˆ ë¶€ì—¬í•©ë‹ˆë‹¤.
                currentSeatMap1[seatNum] = { 
                    ...grp, 
                    isHot: individualHot, 
                    isMoving: individualMoving, 
                    isShuttle: individualShuttle 
                }; 

                currentSeqIdx++;
            }
        }
    });






    currentSeatMap2 = new Array(busSize + 1).fill(null);

    for(let i=1; i<=busSize; i++) {

        if(currentSeatMap1[i]) {

            if (currentSeatMap1[i].paxType === 'General') {

                let cloned = { ...currentSeatMap1[i] }; cloned.color = '#e0e0e0'; cloned.isSynced = true; currentSeatMap2[i] = cloned;

            }

        }

    }



    let listReturnOnly = msgListGroups.filter(g => g.paxType === 'D2' || g.paxType === 'D3');

    toggleMap2(listReturnOnly.length > 0); 

    if (direction === 'front') listReturnOnly.sort((a,b) => calculateScore(b) - calculateScore(a));

    else listReturnOnly.sort((a,b) => calculateScore(a) - calculateScore(b));



    let emptySeatsMap2 = [];

    seatSequence.forEach(seatNum => { if(!currentSeatMap2[seatNum]) emptySeatsMap2.push(seatNum); });

    

    let d23Passengers = [];

    listReturnOnly.forEach((grp) => {

        grp.color = getPickColor(grp); setGroupMeta(grp);

        if (!grp.isStay) { for(let k=0; k<grp.count; k++) { d23Passengers.push({ ...grp, count: 1 }); } }

    });

    

    let pIdx = 0;

    for(let k=0; k<emptySeatsMap2.length; k++) {

        if(pIdx >= d23Passengers.length) break;

        let seatNum = emptySeatsMap2[k]; currentSeatMap2[seatNum] = d23Passengers[pIdx]; pIdx++;

    }



    saveSeatMap(); redrawAll(busSize, isFit); // [ìˆ˜ì •] isFit ì „ë‹¬

    renderMessages(msgListGroups, currentSeatMap1, currentSeatMap2, isFit); // [ìˆ˜ì •] isFit ì „ë‹¬

}



// [ìˆ˜ì •] isFit ë§¤ê°œë³€ìˆ˜ ì¶”ê°€ ë° ë‹¨ìˆœ ì‹œí€€ìŠ¤ ì²˜ë¦¬

function generateSeatSequence(totalPax, busSize, isFit) {

  // 1. FIT ëª¨ë“œ: ë‹¨ìˆœ 1, 2, 3... ìˆœì„œ

  if (isFit) {

      let seq = [];

      for(let i=1; i<=busSize; i++) seq.push(i);

      return seq;

  }

  // 2. ê¸°ì¡´ 14ì¸ìŠ¹ (ì½”ë“œìƒ ë‚¨ê²¨ë‘ , í•„ìš”ì‹œ í˜¸í™˜)

  if (busSize === 14) {

    let seq = [];

    for (let i = 1; i <= 14; i++) seq.push(i);

    return seq;

  }



  // 3. ê¸°ì¡´ 44/45ì¸ìŠ¹ ë¡œì§ (ìœ ì§€)

  let sequence = [];

  for(let i = 5; i <= busSize; i++) sequence.push(i);

  sequence.push(4); sequence.push(3); sequence.push(2); sequence.push(1); 

  return sequence;

}

// =========================================

// [5] UI ë Œë”ë§ ë° ì¸í„°ë™ì…˜ (FIT ìˆ˜ì •ë¨)

// =========================================



function redrawAll(busSize, isFit) {

    // [ìˆ˜ì •] isFit í”Œë˜ê·¸ë¥¼ renderBusì— ì „ë‹¬

    renderBus(currentSeatMap1, busSize, 'busGrid1', 1, isFit); 

    renderBus(currentSeatMap2, busSize, 'busGrid2', 2, isFit);

    updateHeader1(currentSeatMap1); 

    updateHeader2(currentSeatMap2);

}



function renderFitBus(seatMap, gridId, busNum) {

    const grid = document.getElementById(gridId);

    grid.innerHTML = "";

    grid.style.display = "grid";

    grid.style.gridTemplateColumns = "repeat(4, 1fr)";

    grid.style.gap = "4px";



    // ê°€ì¡±(repNum) ê¸°ì¤€ìœ¼ë¡œ ë¬¶ê¸°

    let grouped = {};

    for (let i = 1; i < seatMap.length; i++) {

        const s = seatMap[i];

        if (!s) continue;

        const key = s.repNum || ("solo_" + i);

        if (!grouped[key]) grouped[key] = [];

        grouped[key].push(i);

    }



    // ê°€ì¡± ë‹¨ìœ„ë¡œ ì¶œë ¥

    Object.values(grouped).forEach(seats => {

        // ì¢Œì„ ì¶œë ¥

        for (let i = 0; i < seats.length; i++) {

            createSeatElement(grid, seats[i], seatMap, seatMap.length - 1, busNum);

        }



        // 4ì¹¸ ë§ì¶”ê¸°ìš© ë”ë¯¸

        const mod = seats.length % 4;

        if (mod !== 0) {

            for (let k = 0; k < 4 - mod; k++) {

                const dummy = document.createElement("div");

dummy.style.visibility = "hidden";

dummy.style.height = "0px";

dummy.style.margin = "0";

grid.appendChild(dummy);

            }

        }



        // ê°€ì¡± êµ¬ë¶„ì„ 

        const line = document.createElement("div");

        line.style.gridColumn = "1 / -1";

        line.style.height = "3px";

        line.style.background = "#000";

        line.style.margin = "3px 0";

        grid.appendChild(line);

    });

}



// [ìˆ˜ì •] ê¸°ì¡´ renderBusë¥¼ ê°ì‹¸ì„œ FIT ë¶„ê¸° ì²˜ë¦¬

function renderBus(seatMap, maxSeats, gridId, busNum, isFit) {

  // 1. FIT ëª¨ë“œì¼ ê²½ìš° ì „ìš© í•¨ìˆ˜ë¡œ ë‚©ì¹˜

  if (isFit) {

      renderFitBus(seatMap, gridId, busNum);

      return;

  }



  // 2. ì´í•˜ ê¸°ì¡´ ì½”ë“œ ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ

  const grid = document.getElementById(gridId);

  grid.innerHTML = '';

  // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë³µêµ¬ (FITì—ì„œ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)

  grid.style.display = "grid";

  grid.style.gridTemplateColumns = "1fr 1fr 0.2fr 1fr 1fr";

  grid.style.gap = "4px";



  if (maxSeats === 14) {

    grid.style.gridTemplateColumns = "repeat(4, 1fr)";

    for (let i = 1; i <= 14; i++) {

      createSeatElement(grid, i, seatMap, maxSeats, busNum);

    }

    return;

  }



  for(let row=0; row<11; row++) {

    if(maxSeats === 45 && row === 10) {

      let lastRowDiv = document.createElement('div');

      lastRowDiv.className = 'last-row-45';

      for(let k=41; k<=45; k++) createSeatElement(lastRowDiv, k, seatMap, maxSeats, busNum);

      grid.appendChild(lastRowDiv);

      continue;

    }

    for(let col=0; col<5; col++) {

      if(col === 2) { grid.appendChild(document.createElement('div')); continue; }

      let seatNum = (row < 10)

        ? (row * 4) + (col < 2 ? col + 1 : col)

        : (col < 2 ? 40 + col + 1 : 40 + col);

      createSeatElement(grid, seatNum, seatMap, maxSeats, busNum);

    }

  }

}



function createSeatElement(parent, seatNum, seatMap, maxSeats, busNum) {

  let seatDiv = document.createElement('div'); seatDiv.className = 'seat'; seatDiv.dataset.idx = seatNum;

  if(selectedSeat.busNum === busNum && selectedSeat.idx === seatNum) seatDiv.classList.add('selected');

  if (busNum === 2 && seatMap[seatNum] && seatMap[seatNum].paxType === 'General') { seatDiv.classList.add('synced-general'); }

  

  // FIT ëª¨ë“œë‚˜ 44/45ì¸ìŠ¹ì˜ ì•ìë¦¬ ì²˜ë¦¬ (FITëŠ” ëª¨ë“  ìë¦¬ê°€ ì¼ë°˜ ìë¦¬ì²˜ëŸ¼ ë³´ì´ê²Œ ì²˜ë¦¬)

  if(seatNum <= 4 && maxSeats > 14) {

    if (seatMap[seatNum]) renderSeatContent(seatDiv, seatMap[seatNum], seatNum, busNum);

    else { seatDiv.classList.add('emergency'); renderSeatContent(seatDiv, null, seatNum, busNum); }

  } else {

    renderSeatContent(seatDiv, seatMap[seatNum], seatNum, busNum);

  }

  

  seatDiv.onclick = function() { handleSeatClick(this, busNum, seatNum, maxSeats); };

  parent.appendChild(seatDiv);

}



function renderSeatContent(el, data, num, busNum) {
  el.innerHTML = `<span class="seat-num">${num}</span>`;
  if(data) {
    if (busNum === 2 && data.paxType === 'General') { 
        el.style.backgroundColor = data.color; 
        el.innerHTML += `<div style="font-size:30px; color:#757575; font-weight:bold; margin-top:10px;">âŒ</div>`; 
        return; 
    }
    el.style.backgroundColor = data.color;
    
    let dispNum = data.mainNum;
    let len = String(dispNum).length; 
    let fSize = "24px"; 

    if (len > 12) fSize = "12px";       
    else if (len > 8) fSize = "15px";   
    else if (len > 5) fSize = "19px";   
    else if (len > 3) fSize = "22px";   

    // --- [ìˆ˜ì •ëœ ë¶€ë¶„] ì˜ì–´ ì†ë‹˜ì¼ ê²½ìš° ê¸€ììƒ‰ì„ ì§„í•œ íŒŒë‘ìœ¼ë¡œ ì„¤ì • ---
    let textColor = (data.langContext === 'EN') ? '#1a237e' : '#333';
    // ---------------------------------------------------------

    let originBadgeHtml = getOriginBadgeHtml(data.originTag);
    let cleanNation = data.subInfo ? data.subInfo.replace(/\(.\)/g, '') : "";
    
        let tagsHtml = "";
    if (data.isHot) tagsHtml += `<span class="day-tag tag-hot">H</span>`;
if (data.isMoving) tagsHtml += `<span class="day-tag tag-moving">ë¬´</span>`;
if (data.isShuttle) tagsHtml += `<span class="day-tag tag-shuttle">ì…”</span>`; 
    if (data.paxType === 'D1') tagsHtml += `<span class="day-tag tag-d1">D1</span>`;

    if (data.paxType === 'D2') tagsHtml += `<span class="day-tag tag-d2">D2</span>`;
    if (data.paxType === 'D3') tagsHtml += `<span class="day-tag tag-d3">D3</span>`;


    // style ì†ì„±ì— color:${textColor}ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
    el.innerHTML += `<div class="grp-id" style="font-size:${fSize}; color:${textColor};">${dispNum}</div><div class="info-badge ${data.textClass}">${tagsHtml}${cleanNation}${originBadgeHtml}</div>`;
  } else el.className += " empty";
}




function handleSeatClick(el, busNum, seatIdx, busSize) {

    if(selectedSeat.idx === -1) { 

        selectedSeat = { busNum: busNum, idx: seatIdx }; el.classList.add('selected'); 

    } else {

        let sourceBus = selectedSeat.busNum; let sourceIdx = selectedSeat.idx; let targetBus = busNum; let targetIdx = seatIdx;

        if (sourceBus !== targetBus) { alert("ê°™ì€ ë²„ìŠ¤ë¼ë¦¬ë§Œ ì´ë™ ê°€ëŠ¥!"); resetSelection(); return; }

        

        let mapMain = (sourceBus === 1) ? currentSeatMap1 : currentSeatMap2;

        let paxS = mapMain[sourceIdx]; let paxT = mapMain[targetIdx];

        

        mapMain[sourceIdx] = paxT; mapMain[targetIdx] = paxS;

        

        if (sourceBus === 1) {

            if (paxS && paxS.paxType === 'General') syncMoveToMap2(sourceIdx, targetIdx, busSize);

            if (paxT && paxT.paxType === 'General') syncMoveToMap2(targetIdx, sourceIdx, busSize);

        }

        resetSelection(); refreshDisplay();

    }

}



function syncMoveToMap2(fromIdx, toIdx, busSize) {

    let mover = currentSeatMap2[fromIdx]; if (!mover || mover.paxType !== 'General') return;

    let obstacle = currentSeatMap2[toIdx]; 

    if (!obstacle || obstacle.paxType === 'General') { 

        currentSeatMap2[fromIdx] = obstacle; currentSeatMap2[toIdx] = mover; 

    } else if (obstacle.paxType === 'D2' || obstacle.paxType === 'D3') {

        currentSeatMap2[toIdx] = mover; currentSeatMap2[fromIdx] = null; 

        let newSeat = findEmptySeatMap2(busSize);

        if (newSeat !== -1) { currentSeatMap2[newSeat] = obstacle; }

    }

}



function findEmptySeatMap2(busSize) {

    // FIT ëª¨ë“œì—ì„œëŠ” ì‹œí€€ìŠ¤ê°€ ë‹¨ìˆœ 1~Nì´ë¯€ë¡œ í˜¸í™˜ë¨

    let isFit = (document.querySelector('input[name="busSize"]:checked').value === 'FIT');

    let sequence = generateSeatSequence(999, busSize, isFit); 

    for (let idx of sequence) { if (currentSeatMap2[idx] === null) return idx; } 

    return -1;

}



function resetSelection() { 

    document.querySelectorAll('.seat.selected').forEach(e => e.classList.remove('selected')); 

    selectedSeat = { busNum: 0, idx: -1 }; 

}



function refreshDisplay() {

    const scrollY = window.scrollY; 

    let rawSize = localStorage.getItem('bus_size') || "44";

    const isFit = (rawSize === 'FIT');

    // FITë©´ ë§µ í¬ê¸°ê°€ busSize, ì•„ë‹ˆë©´ 44/45

    let busSize = isFit ? (currentSeatMap1.length - 1) : parseInt(rawSize);



    saveSeatMap(); 

    redrawAll(busSize, isFit); 

    renderMessages(msgListGroups, currentSeatMap1, currentSeatMap2, isFit);

    window.scrollTo(0, scrollY);

}



// =========================================

// [6] ë©”ì‹œì§€ ìƒì„± ë¡œì§ (FIT ìˆ˜ì •ë¨)

// =========================================

function renderMessages(allGroups, seatMap1, seatMap2, isFit) {

    const msgList = document.getElementById('msgList');

    const section = document.getElementById('msgSection');

    msgList.innerHTML = ''; section.style.display = 'block';

    

    const statusData = JSON.parse(localStorage.getItem('bus_msgStatus') || '{}');

    const guideName = document.getElementById('guideNameInput').value || "Mr. Shin";

    const busNo = document.getElementById('busNumberInput').value || "";

    

    const tH = document.getElementById('timeHongdae').value;

    const tM = document.getElementById('timeMyeongdong').value;

    const tD = document.getElementById('timeDongdaemun').value;

    const specialMsg = document.getElementById('specialNotice').value;

    const finalSpecial = specialMsg ? `\n\n${specialMsg}\n` : "";



    allGroups.sort((a, b) => {

        let numA = parseInt(a.repNum.replace(/\D/g, '')) || 0; let numB = parseInt(b.repNum.replace(/\D/g, '')) || 0;

        return numA - numB;

    });



    allGroups.forEach((g, idx) => {
    
            let groupBgColor = getPickColor(g);
        let groupTextColor = (g.langContext === 'EN') ? '#1a237e' : '#333';


        let seatStr = ""; let targetMap = (g.paxType === 'D2' || g.paxType === 'D3') ? seatMap2 : seatMap1;

        if (g.isStay) seatStr = "STAY (No Seat)";

        else {

            let seats = [];

            for(let i=1; i<targetMap.length; i++) { if(targetMap[i] && targetMap[i].repNum === g.repNum) seats.push(i); }

            seatStr = seats.sort((a,b)=>a-b).join('-');

        }



        let gid = g.repNum; let msgText = ""; let langTag = "";

        

        const priceList_CN = `[Price List]\n\nS. ç§¯æå¿ƒæ€ï¼ˆåŒ…å«ï¼‰\n\nA. ç¼†è½¦ + è£…å¤‡\n   å‘¨æœ« 70,000 / å¹³æ—¥ 60,000\nB. å¤´ç›” 20,000\nC. æŠ¤å…· 15,000\nD. æ»‘é›ªæœ 20,000\nE. é›ªæ©‡ 30,000\nF. è§‚å…‰ç¼†è½¦ 20,000\n\n*(åˆ·å¡ Card +10%)`;

        const priceList_EN = `[Price List]\n\nS. Positive mindset (Included)\n\nA. Lift + Gear\n   Weekend 70,000 / Weekday 60,000\nB. Helmet 20,000\nC. Guard 15,000\nD. Ski Clothes 20,000\nE. Sled 30,000\nF. Sightseeing Lift 20,000\n\n*(Card payment +10%)`;




        // FIT ëª¨ë“œì—ì„œë„ ê·¸ë£¹ ë²ˆí˜¸(Group)ëŠ” í‘œì‹œë˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
let groupLine = `Group: ${g.msgNum}\n`; 
let seatLine = isFit ? "" : `Seat: ${seatStr}\n`; // ì¢Œì„ ë²ˆí˜¸ëŠ” FIT ëª¨ë“œì—ì„œ ì˜ë¯¸ê°€ ì—†ìœ¼ë¯€ë¡œ ì œì™¸ ìœ ì§€
let busLine = isFit ? "" : `\nbus no : ${busNo}`;




        if (g.paxType === 'D2' || g.paxType === 'D3') {

            let isReturnGuest = (g.paxType === 'D2' || g.paxType === 'D3');

            let dayLabel = isReturnGuest ? (g.paxType === 'D3' ? "Day 3" : "Day 2") : "Day 1";

            let step3_EN = "3. Gathering (15:40)\nğŸ“ Lobby (With luggage)";

            let step3_CN = "3. é›†åˆ Gathering (15:40)\nğŸ“ é…’åº—å¤§å… (å¸¦ä¸Šæ‰€æœ‰è¡Œæ)";

            

            if (g.isStay) { 

                step3_EN = "3. Stay Guest\nğŸ“ No Bus (Enjoy Skiing!)"; 

                step3_CN = "3. ç»­ä½ (Stay)\nğŸ“ No Bus (Enjoy Skiing!)"; 

            }



            if(g.langContext === 'CN') {

                langTag = `<span class="lang-tag lang-CN">ä¸­æ–‡(${dayLabel})</span>`;

                msgText = `[${dayLabel}/Return Guide - ${guideName}]\n${groupLine}${seatLine}\n1. é€€æˆ¿ Check-out (11:00 å‰)\n*è¡Œæå¯„æ”¾ä¸€æ¥¼å¤§å… (Lobby)\nâš ï¸ è¿Ÿäº¤ç½šæ¬¾ (Late): 10,000 / 30åˆ†\n\n2. Klook ä¼‘æ¯å®¤ (10:00)\nğŸ‘‰ ä»˜æ¬¾ & é¢†å–ç¼†è½¦ç¥¨ (Payment/Ticket)\n\n${step3_CN}\n\n${priceList_CN}`;

            } else {

                langTag = `<span class="lang-tag lang-EN">ENG(${dayLabel})</span>`;

                msgText = `[${dayLabel}/Return Guide - ${guideName}]\n${groupLine}${seatLine}\n1. Check-out (Until 11:00)\n*Leave bags at Lobby\nâš ï¸ Late Penalty: 10,000 KRW / 30min\n\n2. Klook Lounge (10:00)\nğŸ‘‰ Payment & Get Lift Card\n\n${step3_EN}\n\n${priceList_EN}`;

            }

        } 

        else {

             let pickupInfo = ""; let loc = g.location ? g.location.trim() : "";

             

             if(g.langContext === 'CN') {

                langTag = "";

                if (loc.includes('í™ëŒ€')) { pickupInfo = `â—ï¸${tH} å¼˜å¤§å…¥å£ç«™ 8è™Ÿå‡ºå£ (Hongik Univ. Exit 8)`; } 

                else if (loc.includes('ëª…ë™')) { pickupInfo = `â—ï¸${tM} æ˜æ´ç«™ 3è™Ÿå‡ºå£ (Myeongdong Exit 3)`; } 

                else if (loc.includes('ë™ëŒ€ë¬¸')) { pickupInfo = `â—ï¸${tD} æ±å¤§é–€æ­·å²æ–‡åŒ–å…¬åœ’ç«™ 11è™Ÿå‡ºå£`; } 

                else { pickupInfo = `â—ï¸${tH} å¼˜ëŒ€ 8ë²ˆ / â—ï¸${tM} ëª…ë™ 3ë²ˆ / â—ï¸${tD} ë™ëŒ€ë¬¸ 11ë²ˆ`; }

                

                msgText = `[${guideName}]\n${pickupInfo}${finalSpecial}\n*ç‚ºäº†é¿é–‹äº¤é€šå µå¡ï¼Œæˆ‘å€‘æœƒæº–æ™‚å‡ºç™¼ã€‚\n*é²ë„æ•ä¸é€€æ¬¾ã€‚\n*è»Šå…§åªå…è¨±é£²ç”¨ç™½æ°´ã€‚\n*ä¸åŒ…å«é¤è²»ã€‚\n\nğŸ‘‰ å¦‚æœæ”¶åˆ°ä¿¡æ¯ï¼Œéº»ç…©å›è¦† â€œæ‚¨æ‰€äº†è§£çš„å‡ºç™¼æ™‚é–“â€, è®“æˆ‘å€‘çŸ¥é“å™¢,è¬è¬ğŸ˜Šã€‚\nå¤§å·´å· : ${busNo}\nå®¶åº­è™Ÿ: ${g.repNum}\nåä½å·: ${seatStr}`;


            } else {

                langTag = "";

                if (loc.includes('í™ëŒ€') || loc.includes('Hongik')) { pickupInfo = `â—ï¸${tH} Hongik Univ.s.t Exit 8`; } 

                else if (loc.includes('ëª…ë™') || loc.includes('Myeongdong')) { pickupInfo = `â—ï¸${tM} Myeongdong s.t Exit 3`; } 

                else if (loc.includes('ë™ëŒ€ë¬¸')) { pickupInfo = `â—ï¸${tD} Dongdaemun History Culture park s.t Exit 11`; } 

                else { pickupInfo = `â—ï¸${tH} Hongik Univ. Exit 8 / â—ï¸${tM} Myeongdong Exit 3 / â—ï¸${tD} Dongdaemun History & Culture Park Station Exit 11`; }

                

                msgText = `[${guideName}]\n${pickupInfo}${finalSpecial}\n\n*We depart early to avoid traffic.\n*There is no refund if you are late.\n*Only water is allowed on the bus.\n*Meals are not included.\n\nğŸ‘‰ Reply "Your departure time" to confirm\nbus no : ${busNo}\nGroup: ${g.repNum}\nSeat: ${seatStr}`;

            }

        }



        if (g.isBoard && g.paxType !== 'D2' && g.paxType !== 'D3') {

            msgText += `\n\nğŸ“º How to wear boots:\n${CONFIG.BOOTS_YOUTUBE}`;

        }
else if (!g.isBoard && g.paxType !== 'D2' && g.paxType !== 'D3') {
    // ì–¸ì–´ë³„ë¡œ "ë‹¹ì‹ ì€ mmì‹ ë°œ ì‚¬ì´ì¦ˆë¥¼ í™•ì¸ í•´ì•¼ í•©ë‹ˆë‹¤" ë¬¸êµ¬ ì¶”ê°€
    if (g.langContext === 'CN') {
        msgText += `\n\nğŸ‘Ÿ è¯·ç¡®è®¤æ‚¨çš„é‹å­å°ºå¯¸ (æ¯«ç±³):\nhttps://bit.ly/3NRRC7t`;
    } else {
        msgText += `\n\nğŸ‘Ÿ You must check your shoe size (millimeter):\nhttps://bit.ly/3NRRC7t`;
    }
}



        let waNumber = g.phone; 

        let hasPhone = (waNumber && waNumber.length > 5);

        let encodedText = encodeURIComponent(msgText);

        let waLink = hasPhone ? `https://wa.me/${waNumber}?text=${encodedText}` : '#';

        let waBtnClass = hasPhone ? 'btn-action btn-wa-send' : 'btn-action btn-wa-send disabled';

        let isContacted = statusData[gid]?.contacted || false; let isConnected = statusData[gid]?.connected || false; let memoText = statusData[gid]?.memo || "";

        

        let appIconHtml = getAppIconHtml(g.messenger, g.appType);

        

                        let extraTags = "";
if (g.isHot) extraTags += `<span class="day-tag tag-hot" style="margin-left:5px; color: black;">H</span>`;
if (g.isMoving) extraTags += `<span class="day-tag tag-moving" style="margin-left:5px; color: black;">ë¬´</span>`;
if (g.isShuttle) extraTags += `<span class="day-tag tag-shuttle" style="margin-left:5px; color: black;">ì…”</span>`;
if (g.paxType === 'D1') extraTags += `<span class="day-tag tag-d1" style="margin-left:5px;">[D1]</span>`;

        if (g.paxType === 'D2') extraTags += `<span class="day-tag tag-d2" style="margin-left:5px;">[D2]</span>`;


        if (g.paxType === 'D3') extraTags += `<span class="day-tag tag-d3" style="margin-left:5px;">[D3]</span>`;

        

        let emailBtnHtml = g.email ? `<div class="btn-action btn-copy-mail" onclick="copyAndOpen(this, '${g.email}', 'mail')">Mail<br>Copy</div>` : "";



        let uiGroupNum = g.msgNum.replace(/[a-zA-Z]/g, '');



                let card = document.createElement('div'); card.className = 'msg-card';

                let optionHtml = "";
        if (g.isSkiTour) {
            let pickupColor = groupBgColor;
            let gid = g.repNum;

            let boardClass = g.isBoarded ? 'opt-card opt-boarded off' : 'opt-card opt-boarded';
            let boardStyle = g.isBoarded ? 'background-color: #eeeeee;' : `background-color: ${pickupColor};`;
            
            let chairOff = (g.memberChairCount === 0 || (g.offOptions && g.offOptions.includes('chair'))) ? 'off' : '';
            let movingOff = (g.isMovingCount === 0 || (g.offOptions && g.offOptions.includes('moving'))) ? 'off' : '';
            let sightOff = (g.isSightseeingCount === 0 || (g.offOptions && g.offOptions.includes('sight'))) ? 'off' : '';
            let sledOff = (g.isSledCount === 0 || (g.offOptions && g.offOptions.includes('sled'))) ? 'off' : '';

            optionHtml = `
                <div class="option-card-wrapper">
                    <div class="${boardClass}" style="${boardStyle}" data-original-color="${pickupColor}" onclick="toggleBoarding(this, '${gid}')">íƒ‘ìŠ¹ ì™„ë£Œ</div>
                    <div class="opt-card opt-chair ${chairOff}" onclick="toggleOptCard(this, '${gid}', 'chair')">ì²´ì–´${g.memberChairCount}</div>
                    <div class="opt-card opt-moving ${movingOff}" onclick="toggleOptCard(this, '${gid}', 'moving')">ë¬´ë¹™${g.isMovingCount}</div>
                    <div class="opt-card opt-sight ${sightOff}" onclick="toggleOptCard(this, '${gid}', 'sight')">ê´€ê´‘${g.isSightseeingCount}</div>
                    <div class="opt-card opt-sled ${sledOff}" onclick="toggleOptCard(this, '${gid}', 'sled')">ì°ë§¤${g.isSledCount}</div>
                </div>
            `;
        }



        card.innerHTML = `
    <div class="msg-check-area">
        <div class="check-box-wrapper"><label class="msg-check-label label-sent">ì—°ë½í•¨</label><input type="checkbox" class="msg-check-input chk-sent" onchange="updateMsgStatus('${gid}', 'contacted', this.checked, null)" ${isContacted ? 'checked' : ''}></div>
        <div class="check-box-wrapper"><label class="msg-check-label label-connected">ì—°ë½ë¨</label><input type="checkbox" class="msg-check-input chk-conn" onchange="updateMsgStatus('${gid}', 'connected', this.checked, null)" ${isConnected ? 'checked' : ''}></div>
    </div>
    <div class="msg-info">
        <div class="msg-group-row"><span class="msg-group" style="background-color: ${groupBgColor}; color: ${groupTextColor};">${uiGroupNum}</span>${langTag}${extraTags}</div>
        <div class="msg-seats">Seat: ${seatStr}</div>
        <input type="text" class="msg-memo-input" placeholder="ë¹„ê³ " value="${memoText}" oninput="updateMsgStatus('${gid}', null, null, this.value)">
        <div class="hidden-msg">${msgText}</div>
    </div>
    <div class="msg-actions">
        <a href="${waLink}" target="_blank" class="${waBtnClass}">Send<br>WA</a>
        <div class="btn-action btn-copy-body" onclick="copyMessageBody(this)">ë³¸ë¬¸<br>Copy</div>
        ${emailBtnHtml}
        ${appIconHtml}
    </div>
    ${optionHtml}
`;



        msgList.appendChild(card);

    });

}



function getAppIconHtml(rawMsg, appType) {

    if (!rawMsg) return `<div class="btn-action logo-none">X</div>`;

    let appClass = 'logo-none'; let copyValue = ""; let appName = "X"; let schemeKey = null;

    let lower = rawMsg.toLowerCase();

    

    if (appType === 'ë¬´') {

        if(rawMsg.length > 2) { appClass = 'logo-none'; appName = 'ETC'; copyValue = rawMsg; }

    } else {

        if (lower.includes('whatsapp')) { 

            appClass = 'logo-wa'; appName = 'WA'; copyValue = rawMsg.replace(/[^0-9]/g, ''); 

        }

        else if (lower.includes('line')) { 

            appClass = 'logo-line'; appName = 'Line'; copyValue = rawMsg.replace(/line[:\s]*/gi, '').trim(); 

            schemeKey = 'line';

        }

        else if (lower.includes('kakao') || lower.includes('talk')) { 

            appClass = 'logo-kakao'; appName = 'Ka'; copyValue = rawMsg.replace(/^(kakao|talk|kakao\s*talk)[:\s]*/i, '').trim(); 

            schemeKey = 'kakao';

        }

        else if (lower.includes('viber')) { 

            appClass = 'logo-viber'; appName = 'Vi'; 

            copyValue = rawMsg.replace(/[^0-9]/g, ''); 

            schemeKey = 'viber';

        }

        else if (lower.includes('wechat') || lower.includes('weixin')) { 

            appClass = 'logo-wechat'; appName = 'We'; copyValue = rawMsg.replace(/^(wechat|weixin)[:\s]*/i, '').trim(); 

            schemeKey = 'wechat';

        }

        else if (lower.includes('zalo')) { 

            appClass = 'logo-zalo'; appName = 'Za'; copyValue = rawMsg.replace(/^zalo[:\s]*/i, '').trim(); 

        }

    }

    

    if (copyValue && appName !== 'X') {

        if (schemeKey) {

            return `<div class="btn-action ${appClass}" onclick="copyAndOpen(this, '${copyValue}', '${schemeKey}')">${appName}<br>Copy</div>`;

        } else {

            return `<div class="btn-action ${appClass}" onclick="copyOnly(this, '${copyValue}')">${appName}<br>Copy</div>`;

        }

    } else {

        return `<div class="btn-action logo-none">X</div>`;

    }

}



function updateMsgStatus(gid, type, checked, memo) {

    let statusData = JSON.parse(localStorage.getItem('bus_msgStatus') || '{}');

    if(!statusData[gid]) statusData[gid] = { contacted: false, connected: false, memo: "" };

    if(type === 'contacted') statusData[gid].contacted = checked;

    if(type === 'connected') statusData[gid].connected = checked;

    if(memo !== null) statusData[gid].memo = memo;

    localStorage.setItem('bus_msgStatus', JSON.stringify(statusData));

}



// =========================================

// [7] ìˆ˜ë™ ì œì–´ ë° ì €ì¥/ë¡œë“œ

// =========================================



function manualAddGroup() {

    const rawInput = (document.getElementById('manualGroupNum').value || "").trim();

    if(!rawInput) { alert("ì˜¤ë¹ , ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ì§€?"); return; }

    

    let targetGroup = msgListGroups.find(g => String(g.mainNum) === rawInput || String(g.msgNum) === rawInput);



    if (!targetGroup) {

        if(!confirm(`[${rawInput}ë²ˆ]ì€ ëª…ë‹¨ì— ì—†ì–´. í˜„ì¥ ì†ë‹˜(Walk-in)ìœ¼ë¡œ ì¶”ê°€í• ê¹Œ?`)) return;

        const isSancheoneoMode = msgListGroups.some(g => g.isSancheoneo);

        targetGroup = {

            mainNum: rawInput, msgNum: rawInput, repNum: rawInput, isLong: false, count: 0, 

            name: "Manual Guest", country: "ETC", gender: "N", langContext: "EN",

            appType: "ë¬´", location: "í˜„ì¥", phone: "", messenger: "", note: "Manual", members: [], 

            paxType: 'General', isStay: false, isBoard: false, 

            color: '#e0e0e0', textClass: 'neutral-text', subInfo: 'í˜„ì¥',

            isSancheoneo: isSancheoneoMode, isHot: false, email: "",

            originTag: "(í˜„)", 

            options: { lift: false, gear: false, clothes: false, lesson: false }

        };

        msgListGroups.push(targetGroup);

    }



    targetGroup.count++;

    

    // [ìˆ˜ì •] ìˆ˜ë™ ì¶”ê°€ ì‹œì—ë„ FIT ì‹œí€€ìŠ¤ ì‚¬ìš© (ì¼ë°˜ 1,2,3... ë˜ëŠ” ë²„ìŠ¤ì‹œí€€ìŠ¤)

    let isFit = (document.querySelector('input[name="busSize"]:checked').value === 'FIT');

    // FIT ëª¨ë“œë©´ ì¢Œì„ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë§µì„ í™•ì¥í•´ì•¼ í•˜ì§€ë§Œ, 

    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ê¸°ì¡´ ë§µì˜ ë¹ˆìë¦¬ë§Œ ì°¾ìŒ (FITëŠ” ë³´í†µ ìë™ì‹¤í–‰ìœ¼ë¡œ ë¦¬ì…‹í•˜ë¯€ë¡œ)

    let sequence = generateSeatSequence(1, currentSeatMap1.length - 1, isFit);

    let seatedIdx = -1;

    

    for(let i of sequence) {

        if(currentSeatMap1[i] === null) { currentSeatMap1[i] = {...targetGroup}; seatedIdx = i; break; } 

    }



    if(targetGroup.paxType === 'General') {

        if (seatedIdx !== -1 && currentSeatMap2[seatedIdx] === null) {

             let cloned = {...targetGroup}; cloned.color = '#e0e0e0'; cloned.isSynced = true;

             currentSeatMap2[seatedIdx] = cloned;

        } else {

            for(let i of sequence) {

                if(currentSeatMap2[i] === null) { 

                    let cloned = {...targetGroup}; cloned.color = '#e0e0e0'; cloned.isSynced = true;

                    currentSeatMap2[i] = cloned; break; 

                } 

            }

        }

    }

    refreshDisplay();

}



function manualDelGroup() {
    const rawInput = (document.getElementById('manualGroupNum').value || "").trim();
    if(!rawInput) { alert("ì§€ìš¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜."); return; }
    
    let idx = msgListGroups.findIndex(g => String(g.mainNum) === rawInput || String(g.msgNum) === rawInput);
    if(idx === -1) { alert("ê·¸ ë²ˆí˜¸ëŠ” ëª…ë‹¨ì— ì—†ëŠ”ë°?"); return; }
    
    let group = msgListGroups[idx];
    let targetRepNum = group.repNum;

    if (group.count > 0) {
        group.count--; 
        for(let i = currentSeatMap1.length - 1; i >= 1; i--) {
            if(currentSeatMap1[i] && (String(currentSeatMap1[i].mainNum) === rawInput || currentSeatMap1[i].repNum === targetRepNum)) {
                currentSeatMap1[i] = null; break;
            }
        }
        for(let i = currentSeatMap2.length - 1; i >= 1; i--) {
            if(currentSeatMap2[i] && (String(currentSeatMap2[i].mainNum) === rawInput || currentSeatMap2[i].repNum === targetRepNum)) {
                currentSeatMap2[i] = null; break;
            }
        }
    }

    if (group.count <= 0) {
        if(confirm(`[${rawInput}ë²ˆ] ì¸ì›ì´ 0ëª…ì´ì•¼. ëª…ë‹¨ì—ì„œ ì™„ì „íˆ ì‚­ì œí• ê¹Œ?`)) {
            msgListGroups.splice(idx, 1);
            for(let i = 1; i < currentSeatMap1.length; i++) {
                if(currentSeatMap1[i] && (String(currentSeatMap1[i].mainNum) === rawInput || currentSeatMap1[i].repNum === targetRepNum)) currentSeatMap1[i] = null;
            }
            for(let i = 1; i < currentSeatMap2.length; i++) {
                if(currentSeatMap2[i] && (String(currentSeatMap2[i].mainNum) === rawInput || currentSeatMap2[i].repNum === targetRepNum)) currentSeatMap2[i] = null;
            }
        }
    }
    refreshDisplay();
}

function manualBatchAdd() {
    const rawBatch = document.getElementById('manualBatchData').value.trim();
    if (!rawBatch) return;

    const rawLower = rawBatch.toLowerCase();
    const isGlobalSki = rawLower.includes('ski') || rawLower.includes('snowboard') || rawLower.includes('ìŠ¤í‚¤') || rawLower.includes('ìŠ¤ë…¸ìš°');
    const lines = rawBatch.split('\n');
    
    let entries = [];
    let startIdx = (msgListGroups.length > 0) ? msgListGroups.length + 1 : 1;

    lines.forEach((line, i) => {
        if (!line.trim()) return;
        const parsed = parseRawDataLine(line, startIdx + i, isGlobalSki, null);
        if (parsed) entries.push(parsed);
    });

    if (entries.length === 0) return;

    const newGroups = createGroupsFromEntries(entries);
    const busSizeVal = document.querySelector('input[name="busSize"]:checked').value;
    const isFit = (busSizeVal === 'FIT');
    const busSize = isFit ? (currentSeatMap1.length - 1) : parseInt(busSizeVal);
    const seatSequence = generateSeatSequence(999, busSize, isFit);

    newGroups.forEach(grp => {
        grp.color = getPickColor(grp);
        setGroupMeta(grp);
        msgListGroups.push(grp);

        let seatedCount = 0;
        for (let sNum of seatSequence) {
            if (seatedCount >= grp.count) break;
            if (currentSeatMap1[sNum] === null) {
                currentSeatMap1[sNum] = { ...grp };
                seatedCount++;
            }
        }
    });

    document.getElementById('manualBatchData').value = "";
    refreshDisplay();
}



function saveSeatMap() { localStorage.setItem('bus_seatMap', JSON.stringify({ map1: currentSeatMap1, map2: currentSeatMap2, groups: msgListGroups })); }

function checkDateChange() { localStorage.setItem('bus_lastDate', document.getElementById('vcardDate').value); }

function saveTextInput() { localStorage.setItem('bus_rawData', document.getElementById('rawData').value); localStorage.setItem('bus_size', document.querySelector('input[name="busSize"]:checked').value); }

function saveTimeInput() { const times = { h: document.getElementById('timeHongdae').value, m: document.getElementById('timeMyeongdong').value, d: document.getElementById('timeDongdaemun').value }; localStorage.setItem('bus_times', JSON.stringify(times)); }

function saveGuideName() { 

    localStorage.setItem('bus_guideName', document.getElementById('guideNameInput').value);

    localStorage.setItem('bus_number', document.getElementById('busNumberInput').value);

    if(msgListGroups.length > 0) refreshDisplay(); // ë³€ê²½ ì‹œ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸

}

function saveSpecialNotice() { localStorage.setItem('bus_specialNotice', document.getElementById('specialNotice').value); if(msgListGroups.length > 0) refreshDisplay(); }



function loadSeatMap() {

    const saved = localStorage.getItem('bus_seatMap');

    if (saved) { 

        try { 

            const data = JSON.parse(saved); 

            if(data.map1 && data.map2) { 

                currentSeatMap1 = data.map1; currentSeatMap2 = data.map2; msgListGroups = data.groups || []; 

                const hasReturn = msgListGroups.some(g => g.paxType === 'D2' || g.paxType === 'D3');

                toggleMap2(hasReturn);

                refreshDisplay(); // í†µí•© ë¦¬í”„ë ˆì‹œ í˜¸ì¶œ

            } 

        } catch(e) {} 

    }

}

function loadTextInput() { const savedData = localStorage.getItem('bus_rawData'); if(savedData) document.getElementById('rawData').value = savedData; const savedSize = localStorage.getItem('bus_size'); if(savedSize) { const radios = document.getElementsByName('busSize'); for(let r of radios) { if(r.value === savedSize) r.checked = true; } } }

function loadGuideName() { const savedGuide = localStorage.getItem('bus_guideName'); if(savedGuide) document.getElementById('guideNameInput').value = savedGuide; const savedBus = localStorage.getItem('bus_number'); if(savedBus) document.getElementById('busNumberInput').value = savedBus; }

function clearData() { if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { document.getElementById('rawData').value = ''; localStorage.removeItem('bus_rawData'); localStorage.removeItem('bus_seatMap'); localStorage.removeItem('bus_msgStatus'); location.reload(); } }



function updateHeader1(seatMap) {

    let counts = { 'í™ëŒ€':0, 'ëª…ë™':0, 'ë™ëŒ€ë¬¸':0, 'í˜„ì¥':0, 'ê¸°íƒ€':0 }; let total = 0;

    for(let i=1; i<seatMap.length; i++) {

        let seat = seatMap[i];

        if(seat) {

            total++; let loc = seat.location || '';

            if(loc.includes('í™ëŒ€')) counts['í™ëŒ€']++;

            else if(loc.includes('ëª…ë™')) counts['ëª…ë™']++;

            else if(loc.includes('ë™ëŒ€ë¬¸')) counts['ë™ëŒ€ë¬¸']++;

            else if(loc.includes('í˜„ì¥')) counts['í˜„ì¥']++;

            else counts['ê¸°íƒ€']++;

        }

    }

    const textHtml = `<div>TOTAL: ${total}ëª…<br><span style="font-size:0.9rem; color:#ffd700;">[ í™ëŒ€ ${counts['í™ëŒ€']} / ëª…ë™ ${counts['ëª…ë™']} / ë™ëŒ€ë¬¸ ${counts['ë™ëŒ€ë¬¸']} / í˜„ì¥ ${counts['í˜„ì¥']} ]</span></div>`;

    const btnHtml = `<div class="header-controls" data-html2canvas-ignore="true"><button class="btn-save-mini" onclick="downloadImage(1)">ğŸ“¸ ì €ì¥</button></div>`;

    document.getElementById('pickupSummary1').innerHTML = textHtml + btnHtml;

}



function updateHeader2(seatMap) {

    let counts = { 'Hotel':0, 'Challenge':0 }; let total = 0;

    for(let i=1; i<seatMap.length; i++) {

        let seat = seatMap[i];

        if(seat) {

            total++; 

            if(seat.paxType === 'D2' || seat.paxType === 'D3') counts['Hotel']++; else counts['Challenge']++; 

        }

    }

    const textHtml = `<div>TOTAL: ${total}ëª…<br><span style="font-size:0.9rem; color:#ffd700;">[ ë³µê·€í¸ ${counts['Challenge']} / ìˆ™ë°•ì†ë‹˜ ${counts['Hotel']} ]</span></div>`;

    const btnHtml = `<div class="header-controls" data-html2canvas-ignore="true"><button class="btn-save-mini night" onclick="downloadImage(2)">ğŸ“¸ ì €ì¥</button></div>`;

    document.getElementById('pickupSummary2').innerHTML = textHtml + btnHtml;

}



function updatePriority(checkbox) {

  const val = checkbox.value;

  if(checkbox.checked) { if(!priorityQueue.includes(val)) priorityQueue.push(val); } 

  else { priorityQueue = priorityQueue.filter(v => v !== val); }

  updatePriorityDisplay();

}



function updatePriorityDisplay() {

  const map = { 'solo':'í˜¼ì', 'CN':'ì¤‘êµ­ì–´', 'EN':'ì˜ì–´', 'G4':'4ì¸ì´ìƒ', 'HD':'í™ëŒ€', 'MY':'ëª…ë™', 'DDM':'ë™ëŒ€ë¬¸' };

  const txt = priorityQueue.map(v => map[v]).join(' > ');

  document.getElementById('priorityView').innerText = "ìš°ì„ ìˆœìœ„: " + (txt || "ì—†ìŒ");

}



function toggleMap2(hasReturnGuests) {

    const map2Area = document.getElementById('captureArea2');

    if (hasReturnGuests) { map2Area.style.display = 'block'; } 

    else { map2Area.style.display = 'none'; }

}



function downloadImage(num) {

  const capture = document.getElementById('captureArea' + num);

  html2canvas(capture, { scrollY: -window.scrollY }).then(canvas => {

    let link = document.createElement('a'); link.download = `Bus_Map${num}_${document.getElementById('dateDisplay1').innerText}.png`;

    link.href = canvas.toDataURL(); link.click();

  });

}



function downloadVCard() {

    if (!msgListGroups || msgListGroups.length === 0) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°°ì¹˜ ì‹¤í–‰ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”."); return; }

    

    let vcardContent = ""; 

    const dateCode = document.getElementById('vcardDate').value; 

    let count = 0;

    let processedPhones = new Set();



    msgListGroups.forEach(g => {

        let phoneStr = g.phone;

        if (!phoneStr || phoneStr.length < 5) return;

        if (processedPhones.has(phoneStr)) return; 

        

        processedPhones.add(phoneStr);

        

        let locChar = 'ê¸°'; 

        if (g.location.includes('í™ëŒ€')) locChar = 'í™';

        else if (g.location.includes('ëª…ë™')) locChar = 'ëª…';

        else if (g.location.includes('ë™ëŒ€ë¬¸')) locChar = 'ë™';

        

        let finalName = `${dateCode}(${g.mainNum}${locChar})`;

        

        vcardContent += "BEGIN:VCARD\nVERSION:3.0\n";

        vcardContent += `FN:${finalName}\n`;

        vcardContent += `TEL;TYPE=CELL:+${phoneStr}\n`;

        vcardContent += `NOTE:Orig:${g.name} / ${g.count}pax\n`;

        vcardContent += "END:VCARD\n";

        count++;

    });

    

    if(count === 0) { alert("ì €ì¥í•  ìœ íš¨í•œ ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

    

    const blob = new Blob([vcardContent], { type: "text/vcard" });

    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');

    link.download = `Contacts_${dateCode}.vcf`;

    link.href = url; link.click(); URL.revokeObjectURL(url);

}



function forceSaveAllData() {

    try {

        saveTextInput(); saveGuideName(); saveTimeInput(); checkDateChange();

        localStorage.setItem('bus_specialNotice', document.getElementById('specialNotice').value);

    } catch (e) { console.log("Safe Save:", e); }

}



function unlock() {

    const input = document.getElementById('lockInput');

    if (input.value === '840506') {

        localStorage.setItem('tm_auth_10_8', 'true');

        document.getElementById('lockScreen').style.display = 'none';

    } else {

        alert('Wrong Password!');

        input.value = '';

        input.focus();

    }

}



window.onload = function() {

    if (localStorage.getItem('tm_auth_10_8') !== 'true') {

        document.getElementById('lockScreen').style.display = 'flex';

    }



    loadTextInput(); loadGuideName(); 

    document.getElementById('specialNotice').value = localStorage.getItem('bus_specialNotice') || "";



    const today = new Date(); today.setDate(today.getDate() + 1);

    const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

    const dateStr = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')} (${days[today.getDay()]})`;

    document.getElementById('dateDisplay1').innerText = dateStr;

    document.getElementById('dateDisplay2').innerText = dateStr;

    const yymmdd = String(today.getFullYear()).slice(2) + String(today.getMonth()+1).padStart(2,'0') + String(today.getDate()).padStart(2,'0');

    document.getElementById('vcardDate').value = yymmdd;

    const savedTimes = JSON.parse(localStorage.getItem('bus_times') || '{}');

    if(savedTimes.h) document.getElementById('timeHongdae').value = savedTimes.h;

    if(savedTimes.m) document.getElementById('timeMyeongdong').value = savedTimes.m;

    if(savedTimes.d) document.getElementById('timeDongdaemun').value = savedTimes.d;

    

    loadSeatMap();

};



document.addEventListener('visibilitychange', function() { if (document.visibilityState === 'hidden') forceSaveAllData(); });

window.addEventListener('pagehide', function() { forceSaveAllData(); });

document.querySelectorAll('input, textarea').forEach(el => { el.addEventListener('blur', forceSaveAllData); });


function toggleOptCard(el, gid, optName) {
    if (navigator.vibrate) { navigator.vibrate(50); }
    
    let group = msgListGroups.find(g => g.repNum === gid);
    if (!group) return;

    if (!group.offOptions) group.offOptions = [];

    const idx = group.offOptions.indexOf(optName);
    if (idx > -1) {
        group.offOptions.splice(idx, 1);
        el.classList.remove('off');
    } else {
        group.offOptions.push(optName);
        el.classList.add('off');
    }

    saveSeatMap();
}

function toggleBoarding(el, gid) {
    if (navigator.vibrate) {
        navigator.vibrate(50);
    }
    playPopSound();
    
    let group = msgListGroups.find(g => g.repNum === gid);
    if (!group) return;

    group.isBoarded = !group.isBoarded;
    
    if (group.isBoarded) {
        el.dataset.originalColor = el.style.backgroundColor;
        el.classList.add('off');
        el.style.backgroundColor = '#eeeeee';
    } else {
        el.classList.remove('off');
        el.style.backgroundColor = el.dataset.originalColor || '';
    }

    saveSeatMap();
}



</script>

</body>

</html>